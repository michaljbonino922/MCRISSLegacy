<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[UpdateShipQuotaRqmt]" directorySegmentName="seg_28" id="344FA877-4B17-478D-14F8-B5F7C4554D2C">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:49 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@ORGANIZATION_ID  int, 
@FISCAL_YEAR  int, 
@MONTH_CODE  int, 
@CATEGORY_CODE  varchar(2), 
@QUOTA_VALUE  int = 0, 
@REQMT_VALUE  int = 0, 
@USER_LOGIN  varchar(15) 
 
AS 
BEGIN 
 
 IF EXISTS (SELECT 1 FROM SHIPPING_QUOTA_PLAN WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
  AND FISCAL_YEAR = @FISCAL_YEAR AND CATEGORY_CODE = @CATEGORY_CODE AND MONTH_CODE = @MONTH_CODE) 
   BEGIN 
 
  IF @QUOTA_VALUE != -1 AND @REQMT_VALUE != -1 
   BEGIN 
    UPDATE SHIPPING_QUOTA_PLAN SET QUOTA_VALUE = @QUOTA_VALUE,  
    REQMT_VALUE = @REQMT_VALUE, USER_LOGIN = @USER_LOGIN, UPDATE_DATE = GETDATE() 
    WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
    AND FISCAL_YEAR = @FISCAL_YEAR 
    AND CATEGORY_CODE = @CATEGORY_CODE 
    AND MONTH_CODE = @MONTH_CODE    
   END 
  ELSE IF @QUOTA_VALUE != -1 AND @REQMT_VALUE = -1 
   BEGIN 
    UPDATE SHIPPING_QUOTA_PLAN SET QUOTA_VALUE = @QUOTA_VALUE, 
    USER_LOGIN = @USER_LOGIN, UPDATE_DATE = GETDATE() 
    WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
    AND FISCAL_YEAR = @FISCAL_YEAR 
    AND CATEGORY_CODE = @CATEGORY_CODE 
    AND MONTH_CODE = @MONTH_CODE    
   END 
  ELSE IF @QUOTA_VALUE = -1 AND @REQMT_VALUE != -1 
   BEGIN 
    UPDATE SHIPPING_QUOTA_PLAN SET REQMT_VALUE = @REQMT_VALUE,  
    USER_LOGIN = @USER_LOGIN, UPDATE_DATE = GETDATE() 
    WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
    AND FISCAL_YEAR = @FISCAL_YEAR 
    AND CATEGORY_CODE = @CATEGORY_CODE 
    AND MONTH_CODE = @MONTH_CODE    
   END 
   END 
 ELSE 
       BEGIN 
   
  IF @QUOTA_VALUE != -1 AND @REQMT_VALUE != -1 
   BEGIN 
    INSERT INTO SHIPPING_QUOTA_PLAN (ORGANIZATION_ID, FISCAL_YEAR,  
    CATEGORY_CODE, MONTH_CODE, QUOTA_VALUE, REQMT_VALUE, USER_LOGIN, UPDATE_DATE) VALUES  
    (@ORGANIZATION_ID, @FISCAL_YEAR, @CATEGORY_CODE, @MONTH_CODE, @QUOTA_VALUE, @REQMT_VALUE, @USER_LOGIN, GETDATE()) 
   END  
  ELSE IF @QUOTA_VALUE != -1 AND @REQMT_VALUE =-1 
   BEGIN 
    INSERT INTO SHIPPING_QUOTA_PLAN (ORGANIZATION_ID, FISCAL_YEAR,  
    CATEGORY_CODE, MONTH_CODE, QUOTA_VALUE, REQMT_VALUE, USER_LOGIN, UPDATE_DATE) VALUES  
    (@ORGANIZATION_ID, @FISCAL_YEAR, @CATEGORY_CODE, @MONTH_CODE, @QUOTA_VALUE, 0, @USER_LOGIN, GETDATE()) 
   END  
  ELSE IF @QUOTA_VALUE = -1 AND @REQMT_VALUE !=-1 
   BEGIN 
    INSERT INTO SHIPPING_QUOTA_PLAN (ORGANIZATION_ID, FISCAL_YEAR,  
    CATEGORY_CODE, MONTH_CODE, QUOTA_VALUE, REQMT_VALUE, USER_LOGIN, UPDATE_DATE) VALUES  
    (@ORGANIZATION_ID, @FISCAL_YEAR, @CATEGORY_CODE, @MONTH_CODE, 0, @REQMT_VALUE, @USER_LOGIN, GETDATE()) 
   END  
      END 
 
 /* 
 -- Recalculate totals (CATEGORY_CODE 'S') 
 DECLARE @quotaTotal int = 0 
 DECLARE @reqmtTotal int = 0 
  
 SET @quotaTotal = ( 
  SELECT SUM(QUOTA_VALUE) 
  FROM SHIPPING_QUOTA_PLAN 
  WHERE ORGANIZATION_ID = @ORGANIZATION_ID AND FISCAL_YEAR = @FISCAL_YEAR AND CATEGORY_CODE != 'S' AND MONTH_CODE = @MONTH_CODE 
 ) 
   
 SET @reqmtTotal = ( 
  SELECT SUM(REQMT_VALUE) 
  FROM SHIPPING_QUOTA_PLAN 
  WHERE ORGANIZATION_ID = @ORGANIZATION_ID AND FISCAL_YEAR = @FISCAL_YEAR AND CATEGORY_CODE != 'S' AND MONTH_CODE = @MONTH_CODE 
 ) 
     
 IF EXISTS (SELECT 1 FROM SHIPPING_QUOTA_PLAN WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
  AND FISCAL_YEAR = @FISCAL_YEAR AND CATEGORY_CODE = 'S' AND MONTH_CODE = @MONTH_CODE) 
  BEGIN    
   UPDATE SHIPPING_QUOTA_PLAN 
    SET QUOTA_VALUE = @quotaTotal,  
     REQMT_VALUE = @reqmtTotal 
    WHERE ORGANIZATION_ID = @ORGANIZATION_ID 
    AND FISCAL_YEAR = @FISCAL_YEAR 
    AND CATEGORY_CODE = 'S' 
    AND MONTH_CODE = @MONTH_CODE 
  END 
 /* 
 ELSE 
  BEGIN 
   INSERT INTO SHIPPING_QUOTA_PLAN ( 
    ORGANIZATION_ID, FISCAL_YEAR, CATEGORY_CODE, MONTH_CODE, QUOTA_VALUE, REQMT_VALUE, USER_LOGIN, UPDATE_DATE 
    ) 
    VALUES ( 
    @ORGANIZATION_ID, @FISCAL_YEAR, 'S', @MONTH_CODE, @quotaTotal, @reqmtTotal, @USER_LOGIN, GETDATE() 
    ) 
  END 
 */ 
 */ 
END]]></body>
<schema>E9C4E37D-78A2-31F9-D580-7C2848ACFCB7</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>