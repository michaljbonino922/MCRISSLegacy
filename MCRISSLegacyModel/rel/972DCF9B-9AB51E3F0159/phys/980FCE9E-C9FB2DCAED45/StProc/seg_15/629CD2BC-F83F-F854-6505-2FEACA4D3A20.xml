<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetAvailableProgramsView]" directorySegmentName="seg_15" id="629CD2BC-F83F-F854-6505-2FEACA4D3A20">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@OrgID  int, 
 @FY int 
AS 
 
SET NOCOUNT ON 
SET ANSI_WARNINGS OFF 
 
DECLARE @OrgType varchar(3) 
SELECT @OrgType = ORGANIZATION_TYPE FROM RECRUITING_ORGANIZATION WHERE ORGANIZATION_ID = @OrgID  
 
CREATE TABLE #AVAILABLE_PROGRAMS   
 (PROGRAM_ID INT, PROGRAM_CODE VARCHAR(8), FY INT, PERIOD_CODE INT, PROGRAM_PERIOD_ID INT,  
 AVAILABLE_PROGRAM_COUNT INT, ASSIGNED_PROGRAM_COUNT INT) 
 
INSERT INTO #AVAILABLE_PROGRAMS  
 (PROGRAM_ID, PROGRAM_CODE, FY, PERIOD_CODE, PROGRAM_PERIOD_ID, AVAILABLE_PROGRAM_COUNT) 
SELECT  
 PG.PROGRAM_ID, 
 PG.PROGRAM_CODE + 
 CASE  
  WHEN PG.PROGRAM_DESCRIPTION LIKE '%FEMALE%' AND PG.PROGRAM_CODE NOT LIKE '%F' THEN ' - F' 
  ELSE SPACE(0) 
 END AS PROGRAM_CODE, 
 PP.FY, PP.PERIOD_CODE, PP.PROGRAM_PERIOD_ID, 
 --- GET THE AVAILABLE PROGRAM COUNT 
 COUNT(PA.PROGRAM_AVAILABILITY_ID) AS AVAILABLE_PROGRAM_COUNT 
FROM 
 PROGRAM PG INNER JOIN PROGRAM_PERIOD PP ON  
  (PP.FY = @FY AND 
  PG.STATUS = 'A') 
 LEFT OUTER JOIN PROGRAM_AVAILABILITY PA ON  
  (PG.PROGRAM_ID = PA.PROGRAM_ID AND 
  PA.PROGRAM_PERIOD_ID = PP.PROGRAM_PERIOD_ID AND 
  PA.ASSIGNED_ORGANIZATION_ID = @OrgID AND 
  PA.CONTRACT_ID IS NULL AND 
  PA.PROGRAM_AVAILABILITY_ID NOT IN (SELECT PROGRAM_AVAILABILITY_ID FROM REMOVED_PROGRAMS))  
GROUP BY 
 PG.PROGRAM_ID, PG.PROGRAM_CODE, PG.PROGRAM_DESCRIPTION, PP.PROGRAM_PERIOD_ID, PP.FY, PP.PERIOD_CODE 
ORDER BY 
 PG.PROGRAM_CODE, PG.PROGRAM_ID, PP.PERIOD_CODE 
 
 
UPDATE 
 #AVAILABLE_PROGRAMS  
SET 
 ASSIGNED_PROGRAM_COUNT = CASE @OrgType 
     WHEN 'D' THEN (SELECT COUNT(PA.PROGRAM_AVAILABILITY_ID) FROM PROGRAM_AVAILABILITY PA 
       INNER JOIN ORGANIZATION_MAP RS ON  
        (PA.ASSIGNED_ORGANIZATION_ID = RS.CHILD_ORGANIZATION_ID AND 
        RS.PARENT_ORGANIZATION_ID = @OrgID) 
       WHERE PA.PROGRAM_ID = AP.PROGRAM_ID AND 
       PA.PROGRAM_PERIOD_ID = AP.PROGRAM_PERIOD_ID AND 
       PA.CONTRACT_ID IS NULL AND 
       PA.PROGRAM_AVAILABILITY_ID NOT IN (SELECT PROGRAM_AVAILABILITY_ID FROM REMOVED_PROGRAMS))  
     ELSE 0 
    END 
FROM 
 #AVAILABLE_PROGRAMS AP  
 
 
--- RETURN THE DATA 
SELECT 
 PROGRAM_ID, PROGRAM_CODE, FY, PERIOD_CODE,  
 AVAILABLE_PROGRAM_COUNT, ASSIGNED_PROGRAM_COUNT 
FROM 
 #AVAILABLE_PROGRAMS 
 
--- CLEAN UP 
DROP TABLE #AVAILABLE_PROGRAMS 
 
SET ANSI_WARNINGS ON 
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>