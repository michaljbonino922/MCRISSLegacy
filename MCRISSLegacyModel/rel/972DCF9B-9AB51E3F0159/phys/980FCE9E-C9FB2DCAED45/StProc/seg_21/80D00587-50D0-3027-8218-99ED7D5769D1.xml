<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetSchoolInforma.onData]" directorySegmentName="seg_21" id="80D00587-50D0-3027-8218-99ED7D5769D1">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@SchoolCode int,  
 @SchoolYear int 
AS 
 
SET NOCOUNT ON 
 
CREATE TABLE #SCHOOL_INFORMATION_DATA  
 (SCHOOL_NAME VARCHAR(60) NULL, DOD_CODE VARCHAR(20) NULL, STREET VARCHAR(40) NULL, CITY VARCHAR(20) NULL, ZIP_CODE VARCHAR(9) NULL,  
 RSS VARCHAR(15) NULL, STATUS_CODE VARCHAR(4) NULL, PRIORITY_CODE CHAR(1) NULL, ACCESS_CODE CHAR(1) NULL,  
 MALE_SENIORS INT NULL, FEMALE_SENIORS INT NULL, PERCENT_TO_COLLEGE NUMERIC NULL, SCHEDULED_GRAD_DATE DATETIME NULL,  
 RECRUITER_ID INT NULL, ASVAB_RESP CHAR(1) NULL, ASVAB_DATE DATETIME NULL, ASVAB_MONTH INT NULL, ASVAB_NUM INT NULL) 
 
INSERT INTO #SCHOOL_INFORMATION_DATA  
 (SCHOOL_NAME, DOD_CODE, STREET, CITY, ZIP_CODE,  
 RSS, STATUS_CODE, PRIORITY_CODE, ACCESS_CODE,  
 MALE_SENIORS, FEMALE_SENIORS, PERCENT_TO_COLLEGE, SCHEDULED_GRAD_DATE,  
 RECRUITER_ID, ASVAB_RESP, ASVAB_DATE, ASVAB_MONTH, ASVAB_NUM) 
SELECT  
 HS.HIGHSCHOOL_NAME, HS.DOD_CODE, HS.STREET, HS.CITY, HS.ZIP_CODE,  
 RO.SHORT_NAME, HSP.STATUS_CODE, HSP.PRIORITY_CODE, HSP.ACCESS_CODE,  
 HSP.MALE_SENIORS, HSP.FEMALE_SENIORS, HSP.PERCENT_TO_COLLEGE,  
 CONVERT(VARCHAR(11), HSP.SCHEDULED_GRAD_DATE, 106) AS SCHEDULED_GRAD_DATE, 
 HSP.RECRUITER_ID, HSP.ASVAB_RESP,   
 CONVERT(VARCHAR(11), HSP.ASVAB_MONTH, 106) AS ASVAB_DATE,  
 COALESCE(MONTH(HSP.ASVAB_MONTH), 0) AS ASVAB_MONTH,  
 COALESCE(HSP.ASVAB_NUM, 0) AS ASVAB_NUM 
FROM  
 HIGH_SCHOOL_PROFILE HSP INNER JOIN HIGH_SCHOOL HS ON  
  (HSP.SCHOOL_CODE = HS.SCHOOL_CODE AND  
  HSP.SCHOOL_CODE = @SchoolCode AND 
  HSP.SCHOOL_YEAR = @SchoolYear) 
 INNER JOIN RECRUITING_ORGANIZATION RO ON HS.ORGANIZATION_ID = RO.ORGANIZATION_ID 
 
--- IF ASVAB_MONTH OR ASVAB_NUM IS NULL, GET THE DATA FROM THE SASVAB DATABASE  
--- PER SCR 571 VERSION 3.1.18 
IF EXISTS (SELECT 1 FROM #SCHOOL_INFORMATION_DATA WHERE COALESCE(ASVAB_MONTH, 0) = 0 OR COALESCE(ASVAB_NUM, 0) = 0) 
BEGIN 
 DECLARE @ASVABMonth int 
 DECLARE @ASVABCount int 
 
 SELECT 
  @ASVABMonth  = T.ASVAB_MONTH, 
  @ASVABCount = T.ASVAB_COUNT 
 FROM  
  (SELECT 
   MONTH(S.TEST_DATE) AS ASVAB_MONTH, 
   COUNT(S.SCORE_ID) AS ASVAB_COUNT 
  FROM 
   #SCHOOL_INFORMATION_DATA D INNER JOIN SASVAB.DBO.SCORES S ON D.DOD_CODE = S.SCHOOL_CODE 
  GROUP BY 
   MONTH(S.TEST_DATE)) T 
 ORDER BY 
  T.ASVAB_MONTH DESC 
 
  
 --- UPDATE DATA FROM SASVAB 
 UPDATE 
  #SCHOOL_INFORMATION_DATA  
 SET 
  ASVAB_MONTH  = @ASVABMonth, 
  ASVAB_NUM  = @ASVABCount 
END  
  
SELECT 
 SCHOOL_NAME, DOD_CODE, STREET, CITY, ZIP_CODE,  
 RSS, STATUS_CODE, PRIORITY_CODE, ACCESS_CODE,  
 MALE_SENIORS, FEMALE_SENIORS, PERCENT_TO_COLLEGE,  
 CONVERT(VARCHAR(11), SCHEDULED_GRAD_DATE, 106) AS SCHEDULED_GRAD_DATE,  
 RECRUITER_ID, ASVAB_RESP,  
 ASVAB_MONTH, 
 ASVAB_NUM 
FROM  
 #SCHOOL_INFORMATION_DATA  
 
--- CLEAN UP 
DROP TABLE #SCHOOL_INFORMATION_DATA  
SET NOCOUNT OFF]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>