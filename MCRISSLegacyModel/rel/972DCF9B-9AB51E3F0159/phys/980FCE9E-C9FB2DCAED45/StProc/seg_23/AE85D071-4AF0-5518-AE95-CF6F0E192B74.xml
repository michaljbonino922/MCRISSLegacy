<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_ODSE_UpdatePRUCData]" directorySegmentName="seg_23" id="AE85D071-4AF0-5518-AE95-CF6F0E192B74">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[AS 
 
CREATE TABLE MCRISS_OFFICERS_STAGING 
( 
 SSN VARCHAR(9) NOT NULL CONSTRAINT PK_MCRISS_OFFICERS_STAGING PRIMARY KEY WITH FILLFACTOR = 30 
) 
 
-- POPULATE TEMP TABLE WITH ALL OFFICERS FROM MCRISS 
INSERT INTO MCRISS_OFFICERS_STAGING 
SELECT  
 P.SOCIAL_SECURITY_NUMBER  
FROM  
 PERSON P  
 INNER JOIN NWA N ON P.PERSON_ID = N.MARINE_CANDIDATE_ID AND N.NWA_ID = dbo.GetMaxNWAID(P.PERSON_ID) 
 INNER JOIN CANDIDATE_STATUS CS ON N.NWA_ID = CS.NWA_ID AND CS.STATUS_TYPE = 'O' AND CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID) 
 
 
 
--- CREATE TABLE WITH MATCHING SSN's FROM ODSE AND MCRISS OFFICERS 
CREATE TABLE ODSE_OFFICERS_PRUC_DATA 
( 
 SSN VARCHAR(9) NOT NULL CONSTRAINT PK_ODSE_OFFICERS_PRUC_DATA PRIMARY KEY WITH FILLFACTOR = 30, 
 PERSON_ID INT NULL, 
 PRESENT_REPORTING_UNIT_CODE VARCHAR(5) NULL, 
 RESERVE_REPORTING_UNIT_CODE VARCHAR(5) NULL 
) 
 
 
INSERT INTO ODSE_OFFICERS_PRUC_DATA(SSN, PRESENT_REPORTING_UNIT_CODE, RESERVE_REPORTING_UNIT_CODE) 
SELECT  
 OPS.SSN,  
 OPS.PRESENT_RUC,  
 OPS.RESERVE_RUC  
FROM  
 ODSE_PRUC_STAGING OPS  
WHERE  
 EXISTS (SELECT 1 FROM MCRISS_OFFICERS_STAGING MOS WHERE MOS.SSN = OPS.SSN) 
 
--- UPDATE THE PERSON_ID FIELD 
UPDATE ODSE_OFFICERS_PRUC_DATA 
SET  
 PERSON_ID = P.PERSON_ID 
FROM  
 ODSE_OFFICERS_PRUC_DATA OOP  
 INNER JOIN PERSON P ON OOP.SSN = P.SOCIAL_SECURITY_NUMBER 
 
 
-- UPDATE OR INSERT DATA TO THE MARINE TABLE 
UPDATE MARINE 
SET  
 PRESENT_REPORTING_UNIT_CODE = ISNULL(M.PRESENT_REPORTING_UNIT_CODE,SS.PRESENT_REPORTING_UNIT_CODE), 
 RESERVE_REPORTING_UNIT_CODE = ISNULL(M.RESERVE_REPORTING_UNIT_CODE,SS.RESERVE_REPORTING_UNIT_CODE), 
 USER_LOGIN = 'MCMODSINTERFACE', 
 UPDATE_DATE = GetDate() 
FROM  
 MARINE M  
 INNER JOIN (SELECT M.MARINE_ID, OOP.PRESENT_REPORTING_UNIT_CODE, OOP.RESERVE_REPORTING_UNIT_CODE 
      FROM 
      ODSE_OFFICERS_PRUC_DATA OOP  
      INNER JOIN PERSON P ON OOP.SSN = P.SOCIAL_SECURITY_NUMBER 
      INNER JOIN MARINE M ON P.PERSON_ID = M.MARINE_ID 
 ) AS SS ON SS.MARINE_ID = M.MARINE_ID 
 
--- IF THE OFFICER IS NOT IN THE MARINE TABLE, ADD IT 
INSERT INTO MARINE 
( 
 MARINE_ID,  
 PRESENT_REPORTING_UNIT_CODE,  
 RESERVE_REPORTING_UNIT_CODE,  
 USER_LOGIN,  
 UPDATE_DATE 
) 
SELECT  
 OPP.PERSON_ID,  
 OPP.PRESENT_REPORTING_UNIT_CODE,  
 OPP.RESERVE_REPORTING_UNIT_CODE,  
 'MCMODSINTERFACE',  
 GetDate() 
FROM 
 ODSE_OFFICERS_PRUC_DATA OPP 
WHERE 
 NOT EXISTS(SELECT 1 FROM MARINE M WHERE M.MARINE_ID = OPP.PERSON_ID) 
 
-- Clean Up 
DROP TABLE MCRISS_OFFICERS_STAGING 
DROP TABLE ODSE_OFFICERS_PRUC_DATA]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>