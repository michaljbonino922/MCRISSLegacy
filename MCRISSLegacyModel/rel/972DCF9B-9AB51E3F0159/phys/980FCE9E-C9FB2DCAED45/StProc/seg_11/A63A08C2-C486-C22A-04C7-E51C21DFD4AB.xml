<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[InsertShipper]" directorySegmentName="seg_11" id="A63A08C2-C486-C22A-04C7-E51C21DFD4AB">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:43 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[(  
 @Ac.veDutyDate date.me, 
 @ContractID int, 
 @PayDate date.me, 
 @PayGradeE.ec.veDate date.me, 
 @PayGradeID varchar(3), 
 @ShipDate date.me, 
 @ShipToTrainingOrgID int, 
 @ShipTypeID varchar(4), 
 @DateDueHome date.me = NULL, 
 @DepartureDate date.me = NULL, 
 @LastEditBy varchar(50) 
) 
AS 
 
DECLARE @CompCode varchar(2) 
DECLARE @MarineCandidateID INT 
DECLARE @NWAID INT 
DECLARE @EDUCATION_VERIFICATION INT 
DECLARE @WAIVERS_VERIFICATION INT 
DECLARE @SF86_VERIFICATION INT 
DECLARE @MEDICAL_VERIFICATION INT 
DECLARE @ASVAB_VERIFICATION INT 
DECLARE @IST_VERIFICATION INT 
DECLARE @PROGRAM_QSN_VERIFICATION INT 
DECLARE @SHIP_DATE_PADD_VERIFICATION INT 
DECLARE @MEDICAL_WAIVER INT 
DECLARE @AFQT_SCORE INT 
DECLARE @GT_SCORE INT 
DECLARE @ASVAB_DATE DATETIME 
 
DECLARE @Educa.onCode NVARCHAR(4) 
DECLARE @Educa.onLevel INT 
 
SET @EDUCATION_VERIFICATION = 0 
SET @WAIVERS_VERIFICATION = 0 
SET @SF86_VERIFICATION = 0 
SET @MEDICAL_VERIFICATION = 0 
SET @ASVAB_VERIFICATION = 0 
SET @IST_VERIFICATION = 0 
SET @PROGRAM_QSN_VERIFICATION = 0 
SET @SHIP_DATE_PADD_VERIFICATION = 0 
SET @MEDICAL_WAIVER = 0 
SET @AFQT_SCORE = 0 
SET @GT_SCORE = 0 
 
SET @CompCode = (SELECT COMPONENT_CODE FROM [CONTRACT] WHERE CONTRACT_ID = @ContractID) 
 
SELECT  @MarineCandidateID = N.MARINE_CANDIDATE_ID 
  ,@NWAID = C.NWA_ID 
FROM NWA N 
INNER JOIN CONTRACT C ON C.NWA_ID = N.NWA_ID 
WHERE C.CONTRACT_ID = @ContractID 
 
IF EXISTS( SELECT MARINE_CANDIDATE_ID 
   FROM CANDIDATE_EDUCATION 
   WHERE MARINE_CANDIDATE_ID = @MarineCandidateID 
    AND (VERIFICATION = 'PENDING' OR SCHOOL_END_DATE > GETDATE())) 
BEGIN 
 SET @EDUCATION_VERIFICATION = 0 
END 
ELSE 
BEGIN 
 
 SELECT  @Educa.onCode = CE.EDUCATION_CODE 
   ,@Educa.onLevel = CE.EDUCATION_LEVEL 
   ,@EDUCATION_VERIFICATION = 1 
 FROM CANDIDATE_EDUCATION CE 
 WHERE MARINE_CANDIDATE_ID = @MarineCandidateID  
  AND CE.SCHOOL_END_DATE = ( SELECT MAX(E.SCHOOL_END_DATE)  
         FROM CANDIDATE_EDUCATION E 
         WHERE E.MARINE_CANDIDATE_ID = CE.MARINE_CANDIDATE_ID) 
  AND CE.SCHOOL_END_DATE <= GETDATE() 
END 
 
IF EXISTS( SELECT TOP 1 CANDIDATE_WAIVER_ID 
   FROM CANDIDATE_WAIVER 
   WHERE NWA_ID = @NWAID AND WAIVER_STATUS_CODE IN ('D','P')) 
BEGIN 
 SET @WAIVERS_VERIFICATION = 0 
END 
ELSE 
BEGIN 
  
 SET @WAIVERS_VERIFICATION = 1 
 
 IF EXISTS( SELECT TOP 1 CANDIDATE_WAIVER_ID 
    FROM CANDIDATE_WAIVER CW 
    INNER JOIN WAIVER W ON W.WAIVER_ID = CW.WAIVER_ID 
    WHERE WAIVER_CATEGORY_ID = 7 AND NWA_ID = @NWAID) 
 BEGIN 
  SET @MEDICAL_WAIVER = 1 
 END 
 ELSE 
 BEGIN 
  SET @MEDICAL_WAIVER = 0 
 END 
END 
 
EXEC [dbo].[sp_MIHasAEPUpload] @MarineCandidateID, @SF86_VERIFICATION OUTPUT 
 
IF EXISTS( SELECT TOP 1 MARINE_CANDIDATE_ID  
   FROM CANDIDATE_MEDICAL_EXAM CME 
   WHERE CME.MEDICAL_EXAM_DATE IN ( SELECT MAX(CME2.MEDICAL_EXAM_DATE) 
            FROM CANDIDATE_MEDICAL_EXAM CME2 
            WHERE CME2.MARINE_CANDIDATE_ID = @MarineCandidateID) 
    AND CME.MARINE_CANDIDATE_ID = @MarineCandidateID 
    AND (CME.MEDICAL_DISPOSITION = 'Q' OR (CME.MEDICAL_DISPOSITION = 'D' AND @MEDICAL_WAIVER = 1)) 
    AND DATEDIFF(DAY, CME.MEDICAL_EXAM_DATE, GETDATE()) <= 730)--LESS THAN 2 YEARS 
BEGIN 
 SET @MEDICAL_VERIFICATION = 1 
END 
ELSE 
BEGIN  
 SET @MEDICAL_VERIFICATION = 0 
END 
 
SELECT TOP 1  @GT_SCORE = CA.GT_SCORE 
    ,@AFQT_SCORE = CA.AFQT_SCORE 
    ,@ASVAB_DATE = CA.ASVAB_DATE 
FROM CANDIDATE_ASVAB CA 
WHERE CA.ASVAB_DATE IN (SELECT MAX(CA2.ASVAB_DATE) 
      FROM CANDIDATE_ASVAB CA2 
      WHERE CA2.MARINE_CANDIDATE_ID = @MarineCandidateID) 
 AND CA.MARINE_CANDIDATE_ID = @MarineCandidateID 
 
IF (@AFQT_SCORE > 20  
  AND @AFQT_SCORE IS NOT NULL  
  AND @GT_SCORE > 79  
  AND @GT_SCORE IS NOT NULL  
  AND DATEDIFF(DAY, @ASVAB_DATE, GETDATE()) <= 730  
  AND @ASVAB_DATE IS NOT NULL) 
BEGIN 
 SET @ASVAB_VERIFICATION = 1 
END 
ELSE 
BEGIN 
 SET @ASVAB_VERIFICATION = 0 
END 
 
IF EXISTS( SELECT CONTRACT_ID  
   FROM CONTRACT 
   WHERE CONTRACT_ID = @CONTRACTID 
    AND IST_RESULT = 'Y') 
BEGIN 
 SET @IST_VERIFICATION = 1 
END 
ELSE 
BEGIN 
 SET @IST_VERIFICATION = 0 
END 
 
IF EXISTS(SELECT QSN_ID FROM QSN WHERE CONTRACT_ID = @CONTRACTID) 
BEGIN 
 SET @PROGRAM_QSN_VERIFICATION = 1 
END 
 
IF EXISTS( SELECT PROGRAM_AVAILABILITY_ID  
   FROM PROGRAM_AVAILABILITY 
   WHERE CONTRACT_ID = @CONTRACTID) 
BEGIN 
 SET @PROGRAM_QSN_VERIFICATION = 1 
END 
 
IF EXISTS( SELECT CONTRACT_ID 
   FROM CONTRACT 
   WHERE CONTRACT_ID = @CONTRACTID 
    AND PROJECTED_SHIP_DATE = @ShipDate) 
BEGIN 
 SET @SHIP_DATE_PADD_VERIFICATION = 1 
END 
 
IF (@EDUCATION_VERIFICATION = 1 
 AND @WAIVERS_VERIFICATION = 1 
 AND @SF86_VERIFICATION = 1 
 AND @MEDICAL_VERIFICATION = 1 
 AND @ASVAB_VERIFICATION = 1 
 AND @IST_VERIFICATION = 1 
 AND @PROGRAM_QSN_VERIFICATION = 1 
 AND @SHIP_DATE_PADD_VERIFICATION = 1 
 AND @EDUCATION_VERIFICATION IS NOT NULL 
 AND @WAIVERS_VERIFICATION IS NOT NULL 
 AND @SF86_VERIFICATION IS NOT NULL 
 AND @MEDICAL_VERIFICATION IS NOT NULL 
 AND @ASVAB_VERIFICATION IS NOT NULL 
 AND @IST_VERIFICATION IS NOT NULL 
 AND @PROGRAM_QSN_VERIFICATION IS NOT NULL 
 AND @SHIP_DATE_PADD_VERIFICATION IS NOT NULL) 
BEGIN 
 
 INSERT INTO [mcriss].[dbo].[SHIPPER] 
      ([CONTRACT_ID] 
      ,[SHIP_TYPE] 
      ,[TRAINING_ORGANIZATION_ID] 
      ,[SHIP_DATE] 
      ,[DateDueHome] 
      ,[DepartureDate] 
      --,[SPECIAL_RECOGNITION] 
      ,[PAY_ENTRY_BASE_DATE] 
      --,[RECRUITER_ASSISTANCE_RECOM] 
      ,[PAY_GRADE_CODE] 
      ,[PAY_GRADE_ED_DATE] 
      ,[AFADBD] 
      --,[CONFIRM_CONTRACT] 
      ,[COMPONENT_CODE] 
      ,[USER_LOGIN] 
      ,[UPDATE_DATE] 
      ,[rowguid]) 
   VALUES 
      (@ContractID 
      ,@ShipTypeID 
      ,@ShipToTrainingOrgID 
      ,@ShipDate 
      ,CASE WHEN @DateDueHome IS NULL 
    THEN [usmc].[GetDateDueHome](@ShipDate) 
    ELSE @DateDueHome END 
      ,CASE WHEN @DepartureDate IS NULL 
    THEN [usmc].[GetDepartureDate](@ShipDate) 
    ELSE @DepartureDate END 
      --,<SPECIAL_RECOGNITION, char(1),> 
      ,@PayDate 
      --,<RECRUITER_ASSISTANCE_RECOM, char(1),> 
      ,@PayGradeID 
      ,@PayGradeE.ec.veDate 
      ,@Ac.veDutyDate 
      --,<CONFIRM_CONTRACT, char(1),> 
      ,@CompCode 
      ,@LastEditBy 
      ,GetDate() 
      ,NewID()) 
 
 IF EXISTS(SELECT NWA_ID FROM CONTRACT_ERROR WHERE NWA_ID = @NWAID) 
 BEGIN 
  UPDATE CONTRACT_ERROR 
  SET  EDUCATION_VERIFICATION = @EDUCATION_VERIFICATION 
   ,WAIVERS_VERIFICATION = @WAIVERS_VERIFICATION 
   ,SF86_VERIFICATION = @SF86_VERIFICATION 
   ,MEDICAL_VERIFICATION = @MEDICAL_VERIFICATION 
   ,ASVAB_VERIFICATION = @ASVAB_VERIFICATION 
  WHERE NWA_ID = @NWAID 
 END 
 ELSE 
 BEGIN 
  INSERT INTO CONTRACT_ERROR 
  SELECT  @NWAID 
    ,@EDUCATION_VERIFICATION 
    ,@WAIVERS_VERIFICATION 
    ,@SF86_VERIFICATION 
    ,@MEDICAL_VERIFICATION 
    ,@ASVAB_VERIFICATION 
 END 
 
 IF EXISTS( SELECT CONTRACT_ID 
    FROM SHIP_ERROR 
    WHERE CONTRACT_ID = @CONTRACTID) 
 BEGIN 
  UPDATE SHIP_ERROR 
  SET  IST_VERIFICATION = @IST_VERIFICATION 
   ,PROGRAM_QSN_VERIFICATION = @PROGRAM_QSN_VERIFICATION 
   ,SHIP_DATE_PADD_VERIFICATION = @SHIP_DATE_PADD_VERIFICATION  
  WHERE CONTRACT_ID = @CONTRACTID 
 END 
 ELSE 
 BEGIN 
  INSERT INTO SHIP_ERROR 
  SELECT @CONTRACTID, @IST_VERIFICATION, @PROGRAM_QSN_VERIFICATION, @SHIP_DATE_PADD_VERIFICATION 
 END 
END 
ELSE 
BEGIN 
 
 IF EXISTS(SELECT NWA_ID FROM CONTRACT_ERROR WHERE NWA_ID = @NWAID) 
 BEGIN 
  UPDATE CONTRACT_ERROR 
  SET  EDUCATION_VERIFICATION = @EDUCATION_VERIFICATION 
   ,WAIVERS_VERIFICATION = @WAIVERS_VERIFICATION 
   ,SF86_VERIFICATION = @SF86_VERIFICATION 
   ,MEDICAL_VERIFICATION = @MEDICAL_VERIFICATION 
   ,ASVAB_VERIFICATION = @ASVAB_VERIFICATION 
  WHERE NWA_ID = @NWAID 
 END 
 ELSE 
 BEGIN 
  INSERT INTO CONTRACT_ERROR 
  SELECT  @NWAID 
    ,@EDUCATION_VERIFICATION 
    ,@WAIVERS_VERIFICATION 
    ,@SF86_VERIFICATION 
    ,@MEDICAL_VERIFICATION 
    ,@ASVAB_VERIFICATION 
 END 
  
 IF EXISTS( SELECT CONTRACT_ID 
    FROM SHIP_ERROR 
    WHERE CONTRACT_ID = @CONTRACTID) 
 BEGIN 
  UPDATE SHIP_ERROR 
  SET  IST_VERIFICATION = @IST_VERIFICATION 
   ,PROGRAM_QSN_VERIFICATION = @PROGRAM_QSN_VERIFICATION 
   ,SHIP_DATE_PADD_VERIFICATION = @SHIP_DATE_PADD_VERIFICATION  
  WHERE CONTRACT_ID = @CONTRACTID 
 END 
 ELSE 
 BEGIN 
  INSERT INTO SHIP_ERROR 
  SELECT @CONTRACTID, @IST_VERIFICATION, @PROGRAM_QSN_VERIFICATION, @SHIP_DATE_PADD_VERIFICATION 
 END 
 
 DELETE FROM CANDIDATE_STATUS WHERE STATUS_TYPE + STATUS_CODE + DISPOSITION_CODE = 'ECN' AND NWA_ID = @NWAID 
  
END]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>