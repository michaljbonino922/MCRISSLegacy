<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetEnlistedShipView]" directorySegmentName="seg_17" id="1933C83A-98A1-3612-8D90-9CBD20434A54">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@FromDate date.me, 
 @ToDate date.me, 
 @RS  int = NULL, 
 @RSS  int = NULL, 
 @SortBy int = NULL 
AS 
 
SET NOCOUNT ON 
 
--- Create temp table to store Org IDs 
CREATE TABLE #ORG_ID (Organiza.onID int) 
 
IF (@RSS IS NOT NULL AND @RSS <> 0) 
BEGIN 
 INSERT INTO #ORG_ID 
 SELECT @RSS 
END 
ELSE 
BEGIN 
 INSERT INTO #ORG_ID 
 SELECT CHILD_ORGANIZATION_ID 
 FROM ORGANIZATION_MAP  
 WHERE PARENT_ORGANIZATION_ID = @RS 
END 
 
 
SELECT  
 COALESCE(RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME) + ' ' + RTRIM(P.LEGAL_MIDDLE_NAME),  
    RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME), RTRIM(P.LAST_NAME)) AS PERSON_NAME, 
 P.PERSON_ID, P.SOCIAL_SECURITY_NUMBER, 
 C.CONTRACT_ID, NWA.NWA_ID,  
 CONVERT(VARCHAR(11), S.SHIP_DATE, 106) AS SHIP_DATE, 
 CONVERT(VARCHAR(11), C.CONTRACT_BEGIN_DATE, 106) AS DATE_OF_ENLIST, 
 MC.GENDER_CODE, S.COMPONENT_CODE, CC.COMPONENT_DESCRIPTION,  
 PROGRAM_QSN = '',  
 RO.NAME AS RSS, 
 COALESCE(RTRIM(P2.LAST_NAME) + ' ' + RTRIM(P2.FIRST_NAME) + ' ' + RTRIM(P2.LEGAL_MIDDLE_NAME),  
    RTRIM(P2.LAST_NAME) + ' ' + RTRIM(P2.FIRST_NAME), RTRIM(P2.LAST_NAME)) AS RECRUITER, 
 SD.DISPOSITION_DESCRIPTION,  
 SORT_ORDER = CASE   
    WHEN @SortBy = 1 THEN CONVERT (VARCHAR, S.SHIP_DATE, 102) 
    WHEN @SortBy = 2 THEN COALESCE(RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME) + ' ' + RTRIM(P.LEGAL_MIDDLE_NAME),  
       RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME), RTRIM(P.LAST_NAME)) 
    WHEN @SortBy = 3 THEN MC.GENDER_CODE 
    WHEN @SortBy = 4 THEN CONVERT (VARCHAR, C.CONTRACT_BEGIN_DATE, 102) 
    WHEN @SortBy = 5 THEN CC.COMPONENT_DESCRIPTION 
    WHEN @SortBy = 6 THEN RO.NAME 
    WHEN @SortBy = 7 THEN SD.DISPOSITION_DESCRIPTION 
    ELSE CONVERT (VARCHAR, S.SHIP_DATE, 102) 
         END 
FROM  
 PERSON P INNER JOIN MARINE_CANDIDATE MC ON P.PERSON_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN NWA ON MC.MARINE_CANDIDATE_ID = NWA.MARINE_CANDIDATE_ID 
 INNER JOIN CONTRACT C ON NWA.NWA_ID = C.NWA_ID 
 INNER JOIN SHIPPER S ON C.CONTRACT_ID = S.CONTRACT_ID 
 INNER JOIN COMPONENT_CODE CC ON S.COMPONENT_CODE = CC.COMPONENT_CODE 
 INNER JOIN CANDIDATE_STATUS CS ON CS.NWA_ID = NWA.NWA_ID 
 INNER JOIN STATUS_DISPOSITION SD ON CS.DISPOSITION_CODE = SD.DISPOSITION_CODE  
 INNER JOIN RECRUITING_ORGANIZATION RO ON RO.ORGANIZATION_ID = NWA.ORGANIZATION_OF_RECORD_ID 
 INNER JOIN PERSON P2 ON NWA.RECRUITER_OF_RECORD_ID = P2.PERSON_ID 
WHERE  
 SD.STATUS_CODE = 'C'  
 AND S.SHIP_DATE BETWEEN @FromDate AND @ToDate 
 AND NWA.ORGANIZATION_OF_RECORD_ID in (SELECT Organiza.onID FROM #ORG_ID) 
 AND CS.CANDIDATE_STATUS_ID = (SELECT MAX(CANDIDATE_STATUS_ID) FROM CANDIDATE_STATUS  
     WHERE CANDIDATE_STATUS.NWA_ID = NWA.NWA_ID) 
ORDER BY 
 SORT_ORDER 
 
/* OLD WAY 
--- Create temp table to store Ship View data 
CREATE TABLE #SHIP_VIEW (PERSON_NAME VARCHAR(60), PERSON_ID INT, SOCIAL_SECURITY_NUMBER VARCHAR(9), CONTRACT_ID INT, 
   NWA_ID INT, SHIP_DATE VARCHAR(11), DATE_OF_ENLIST VARCHAR(11), GENDER_CODE CHAR(1),  
   COMPONENT_CODE VARCHAR(2), COMPONENT_DESCRIPTION VARCHAR(50), 
   PROGRAM_QSN VARCHAR(25), RSS VARCHAR(45), RECRUITER VARCHAR(60), DISPOSITION_DESCRIPTION VARCHAR(40),  
   SORT_ORDER VARCHAR(60)) 
 
--- Insert Ship View Data except for PROGRAM_QSN 
INSERT INTO #SHIP_VIEW 
SELECT  
 COALESCE(RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME) + ' ' + RTRIM(P.LEGAL_MIDDLE_NAME),  
    RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME), RTRIM(P.LAST_NAME)) AS PERSON_NAME, 
 P.PERSON_ID, P.SOCIAL_SECURITY_NUMBER, 
 C.CONTRACT_ID, NWA.NWA_ID,  
 CONVERT(VARCHAR(11), S.SHIP_DATE, 106) AS SHIP_DATE, 
 CONVERT(VARCHAR(11), C.CONTRACT_BEGIN_DATE, 106) AS DATE_OF_ENLIST, 
 MC.GENDER_CODE, S.COMPONENT_CODE, CC.COMPONENT_DESCRIPTION,  
 PROGRAM_QSN = NULL,  
 RO.NAME AS RSS, 
 COALESCE(RTRIM(P2.LAST_NAME) + ' ' + RTRIM(P2.FIRST_NAME) + ' ' + RTRIM(P2.LEGAL_MIDDLE_NAME),  
    RTRIM(P2.LAST_NAME) + ' ' + RTRIM(P2.FIRST_NAME), RTRIM(P2.LAST_NAME)) AS RECRUITER, 
 SD.DISPOSITION_DESCRIPTION,  
 'SORT_ORDER' = CASE   
    WHEN @SortBy = 1 THEN CONVERT (VARCHAR, S.SHIP_DATE, 102) 
    WHEN @SortBy = 2 THEN COALESCE(RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME) + ' ' + RTRIM(P.LEGAL_MIDDLE_NAME),  
       RTRIM(P.LAST_NAME) + ' ' + RTRIM(P.FIRST_NAME), RTRIM(P.LAST_NAME)) 
    WHEN @SortBy = 3 THEN MC.GENDER_CODE 
    WHEN @SortBy = 4 THEN CONVERT (VARCHAR, C.CONTRACT_BEGIN_DATE, 102) 
    WHEN @SortBy = 5 THEN CC.COMPONENT_DESCRIPTION 
    WHEN @SortBy = 6 THEN RO.NAME 
    WHEN @SortBy = 7 THEN SD.DISPOSITION_DESCRIPTION 
    ELSE CONVERT (VARCHAR, S.SHIP_DATE, 102) 
         END 
FROM  
 PERSON P INNER JOIN MARINE_CANDIDATE MC ON P.PERSON_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN NWA ON MC.MARINE_CANDIDATE_ID = NWA.MARINE_CANDIDATE_ID 
 INNER JOIN CONTRACT C ON NWA.NWA_ID = C.NWA_ID 
 INNER JOIN SHIPPER S ON C.CONTRACT_ID = S.CONTRACT_ID 
 INNER JOIN COMPONENT_CODE CC ON S.COMPONENT_CODE = CC.COMPONENT_CODE 
 INNER JOIN CANDIDATE_STATUS CS ON CS.NWA_ID = NWA.NWA_ID 
 INNER JOIN STATUS_DISPOSITION SD ON CS.DISPOSITION_CODE = SD.DISPOSITION_CODE  
 INNER JOIN RECRUITING_ORGANIZATION RO ON RO.ORGANIZATION_ID = NWA.ORGANIZATION_OF_RECORD_ID 
 INNER JOIN PERSON P2 ON NWA.RECRUITER_OF_RECORD_ID = P2.PERSON_ID 
WHERE  
 SD.STATUS_CODE = 'C'  
 AND S.SHIP_DATE BETWEEN @FromDate AND @ToDate 
 AND NWA.ORGANIZATION_OF_RECORD_ID in (SELECT Organiza.onID FROM #ORG_ID) 
 AND CS.CANDIDATE_STATUS_ID = (SELECT MAX(CANDIDATE_STATUS_ID) FROM CANDIDATE_STATUS  
     WHERE CANDIDATE_STATUS.NWA_ID = NWA.NWA_ID) 
 
 
--- Capture PROGRAM_QSN data 
DECLARE @ContractID int, @ComponentCode varchar(2) 
DECLARE @Skill varchar(5), @Bonus varchar(3), @MCCF varchar(3), @LOC varchar(2) 
DECLARE @ProgAssignDate varchar(8), @ProgramQSN varchar(25) 
--- DECLARE @AssignYear varchar(4), @AssignMonth varchar(2), @AssignDay varchar(2), @AssignDate date.me 
 
--- open cursor to update #SHIP_VIEW with PROGRAM_QSN data 
DECLARE PROGRAM_CURSOR CURSOR FOR  
SELECT SV.CONTRACT_ID, SV.COMPONENT_CODE FROM #SHIP_VIEW SV 
 
OPEN PROGRAM_CURSOR 
FETCH NEXT FROM PROGRAM_CURSOR INTO @ContractID, @ComponentCode 
 
WHILE @@FETCH_STATUS = 0 
BEGIN 
 IF @ComponentCode = 'K4' OR @ComponentCode = 'K8' OR @ComponentCode = 'K9' OR @ComponentCode = 'B5' 
  --- This shipper is a reserve.  Display their QSN data. 
  BEGIN 
  --- exec sp_GetMOSCode @ContractID, @ProgramQSN output 
  SELECT @ProgramQSN = QSN_ID + '/' + MOS FROM QSN WHERE CONTRACT_ID = @ContractID   
  END 
 ELSE 
  --- This shipper is a regular marine.  Display their program data. 
  BEGIN 
  --- DEFINE PROGRAM_QSN data 
  SET @Skill = (SELECT PG.PROGRAM_CODE FROM PROGRAM PG  
  WHERE PG.PROGRAM_ID IN (SELECT TOP 1 PA.PROGRAM_ID FROM PROGRAM_AVAILABILITY PA WHERE PA.CONTRACT_ID = @ContractID ORDER BY PA.PROGRAM_AVAILABILITY_ID DESC) 
  AND PG.PROGRAM_TYPE IN ('EOP', 'QEP', 'MEOP')) 
  
  IF @Skill IS NULL SET @Skill = '00000' 
  WHILE LEN(@Skill) < 5 
  BEGIN 
  SET @Skill = @Skill + '0'  
  END 
 
 
  SET @Bonus = (SELECT PG.PROGRAM_CODE FROM PROGRAM PG  
  WHERE PG.PROGRAM_ID IN (SELECT TOP 1 PA.PROGRAM_ID FROM PROGRAM_AVAILABILITY PA WHERE PA.CONTRACT_ID = @ContractID ORDER BY PA.PROGRAM_AVAILABILITY_ID DESC) 
  AND PG.PROGRAM_TYPE = 'EBP') 
   
  IF @Bonus IS NULL SET @Bonus = '000' 
  WHILE LEN(@Bonus) < 3 
  BEGIN 
  SET @Bonus = @Bonus + '0'  
  END 
 
 
  SET @MCCF = (SELECT PG.PROGRAM_CODE FROM PROGRAM PG  
  WHERE PG.PROGRAM_ID IN (SELECT TOP 1 PA.PROGRAM_ID FROM PROGRAM_AVAILABILITY PA WHERE PA.CONTRACT_ID = @ContractID ORDER BY PA.PROGRAM_AVAILABILITY_ID DESC) 
  AND PG.PROGRAM_TYPE = 'MCCF') 
  
  IF @MCCF IS NULL SET @MCCF = '000' 
  WHILE LEN(@MCCF) < 3  
  BEGIN 
  SET @MCCF = @MCCF + '0'  
  END 
 
 
  SET @LOC = (SELECT C1.DUTY_PREFERENCE1 FROM CONTRACT C1 INNER JOIN PROGRAM_AVAILABILITY PA ON C1.CONTRACT_ID = PA.CONTRACT_ID 
  INNER JOIN PROGRAM PG ON PA.PROGRAM_ID = PG.PROGRAM_ID  
  WHERE PA.CONTRACT_ID = @ContractID AND PG.PROGRAM_TYPE = 'QEP') 
 
  IF @LOC IS NULL SET @LOC = '00' 
  WHILE LEN(@LOC) < 2 
  BEGIN 
  SET @LOC = @LOC + '0'  
  END 
 
  SET @ProgAssignDate = ISNULL(CONVERT(VARCHAR(8), (SELECT MAX(PA.PROGRAM_ASSIGNMENT_DATE) FROM PROGRAM_AVAILABILITY PA WHERE PA.CONTRACT_ID = @ContractID), 112), '00000000') 
  SET @ProgramQSN = @Skill + '-' + @Bonus + '-' + @MCCF + '-' + @LOC + '-' + @ProgAssignDate   
 
  END 
 
 --- Update the #SHIP_VIEW table and move to the next record 
 UPDATE #SHIP_VIEW SET PROGRAM_QSN = @ProgramQSN WHERE CONTRACT_ID = @ContractID 
 
 --- clear variables for the next record in cursor 
 SET @ProgramQSN = ''   
 SET @Skill = '' 
 SET @Bonus = ''  
 SET @MCCF = ''  
 SET @LOC = '' 
 SET @ProgAssignDate = '' 
 
--- move to next record 
FETCH NEXT FROM PROGRAM_CURSOR INTO @ContractID, @ComponentCode 
   
END 
 
--- clean up cursor 
CLOSE PROGRAM_CURSOR 
DEALLOCATE PROGRAM_CURSOR 
 
--- return the ship view data 
SELECT  
 PERSON_NAME, PERSON_ID, SOCIAL_SECURITY_NUMBER, CONTRACT_ID, NWA_ID, SHIP_DATE,    
 DATE_OF_ENLIST, GENDER_CODE, COMPONENT_CODE, COMPONENT_DESCRIPTION, PROGRAM_QSN, RSS, 
 RECRUITER, DISPOSITION_DESCRIPTION 
FROM  
 #SHIP_VIEW 
ORDER BY 
 SORT_ORDER 
 
--- clean up temp tables 
DROP TABLE #ORG_ID 
DROP TABLE #SHIP_VIEW 
*/]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>