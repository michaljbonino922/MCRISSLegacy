<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetEnlistedPoolView]" directorySegmentName="seg_17" id="2F00F05A-802A-711B-C59F-B47B35672211">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@FromDate date.me, 
 @ToDate  date.me, 
 @RS  int = NULL, 
 @RSS  int = NULL, 
 @SortBy  int = NULL 
AS 
 
SET NOCOUNT ON 
 
--- CREATE A TEMP TABLE FOR ORG IDs 
CREATE TABLE #ORGID (ORGANIZATION_ID int NULL) 
 
--- INDEX TEMP TABLE 
CREATE CLUSTERED INDEX idxOrgID ON #ORGID (ORGANIZATION_ID) 
 
--- RETRIEVE THE ORG IDs  
IF (@RSS IS NOT NULL AND @RSS > 0) 
 BEGIN 
 INSERT INTO #ORGID  
 SELECT @RSS 
 END 
ELSE 
 BEGIN 
 INSERT INTO #ORGID  
 SELECT CHILD_ORGANIZATION_ID FROM ORGANIZATION_MAP WHERE PARENT_ORGANIZATION_ID = @RS 
 END  
 
--- CREATE A TEMP TABLE FOR POOL VIEW DATA 
CREATE TABLE #POOL_VIEW (PERSON_NAME VARCHAR(62) NULL,  
 PERSON_ID INT NULL, NWA_ID INT NULL, CONTRACT_ID INT NULL,  
 SSN CHAR(9) NULL, PROJECTED_SHIP_DATE DATETIME NULL, CONTRACT_BEGIN_DATE DATETIME NULL, IST_DATE DATETIME NULL, 
 GENDER_CODE CHAR(1) NULL, AFQT_SCORE INT NULL, COMPONENT_CODE VARCHAR(2) NULL, COMPONENT_DESCRIPTION VARCHAR(50) NULL,  
 RSS_NAME VARCHAR(45) NULL, DISPOSITION_DESCRIPTION VARCHAR(40) NULL, PROGRAM_MOS_CODE VARCHAR(25) NULL) 
 
--- INDEX TEMP TABLE 
CREATE CLUSTERED INDEX idxPOOL_VIEW_CONTRACT ON #POOL_VIEW (CONTRACT_ID) 
CREATE NONCLUSTERED INDEX idxPOOL_VIEW_CC ON #POOL_VIEW (COMPONENT_CODE) 
 
--- RETRIEVE POOL VIEW DATA 
INSERT INTO #POOL_VIEW (PERSON_NAME, PERSON_ID, NWA_ID, CONTRACT_ID, SSN, PROJECTED_SHIP_DATE,  
   CONTRACT_BEGIN_DATE, IST_DATE, GENDER_CODE, AFQT_SCORE, COMPONENT_CODE,  
   COMPONENT_DESCRIPTION, RSS_NAME, DISPOSITION_DESCRIPTION) 
SELECT  
 RTRIM(P.LAST_NAME) + SPACE(1) + RTRIM(P.FIRST_NAME) + SPACE(1) +  
  ISNULL(P.LEGAL_MIDDLE_NAME, SPACE(0)) AS PERSON_NAME, 
 P.PERSON_ID, NWA.NWA_ID, C.CONTRACT_ID, P.SOCIAL_SECURITY_NUMBER AS SSN, 
 C.PROJECTED_SHIP_DATE, C.CONTRACT_BEGIN_DATE, C.IST_DATE,  
 MC.GENDER_CODE, CA.AFQT_SCORE, C.COMPONENT_CODE,  
 CC.COMPONENT_DESCRIPTION, RO.NAME AS RSS_NAME, SD.DISPOSITION_DESCRIPTION 
FROM  
 PERSON P INNER JOIN MARINE_CANDIDATE MC ON P.PERSON_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN NWA ON MC.MARINE_CANDIDATE_ID = NWA.MARINE_CANDIDATE_ID 
 INNER JOIN CONTRACT C ON NWA.NWA_ID = C.NWA_ID 
 INNER JOIN CANDIDATE_ASVAB CA ON  
  (MC.MARINE_CANDIDATE_ID = CA.MARINE_CANDIDATE_ID AND 
  CA.ASVAB_DATE = dbo.GetMaxASVABDate(CA.MARINE_CANDIDATE_ID)) 
 INNER JOIN COMPONENT_CODE CC ON C.COMPONENT_CODE = CC.COMPONENT_CODE 
 INNER JOIN RECRUITING_ORGANIZATION RO ON NWA.ORGANIZATION_OF_RECORD_ID = RO.ORGANIZATION_ID 
 INNER JOIN CANDIDATE_STATUS CS ON  
  (NWA.NWA_ID = CS.NWA_ID AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 INNER JOIN STATUS_DISPOSITION SD ON  
  (CS.STATUS_TYPE = SD.STATUS_TYPE AND  
  CS.STATUS_CODE = SD.STATUS_CODE AND  
  CS.DISPOSITION_CODE = SD.DISPOSITION_CODE) 
WHERE  
 C.PROJECTED_SHIP_DATE BETWEEN @FromDate AND @ToDate AND 
 NWA.ORGANIZATION_OF_RECORD_ID IN (SELECT ORGANIZATION_ID FROM #ORGID) AND 
 CS.STATUS_TYPE = 'E' AND 
 CS.STATUS_CODE = 'B' AND 
 CS.DISPOSITION_CODE IN ('K', 'M') 
 
 
--- UPDATE POOL VIEW WITH PROGRAM_MOS_CODES 
UPDATE  
 #POOL_VIEW 
SET 
 PROGRAM_MOS_CODE = ISNULL (PMC.PROGRAM_MOS_CODE, CASE WHEN PV.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN SPACE(0)  
        ELSE '00000-000-000-00-' END) 
FROM 
 #POOL_VIEW PV INNER JOIN PROGRAM_MOS_CODES PMC ON PV.CONTRACT_ID = PMC.CONTRACT_ID 
 
--- RETURN THE POOL VIEW DATA 
SELECT  
 PERSON_NAME, 
 PERSON_ID, 
 NWA_ID, 
 CONTRACT_ID, 
 SSN,  
 CONVERT(VARCHAR(11), PROJECTED_SHIP_DATE, 106) AS PROJECTED_SHIP_DATE, 
 CONVERT(VARCHAR(11), CONTRACT_BEGIN_DATE, 106) AS CONTRACT_BEGIN_DATE, 
 CONVERT(VARCHAR(11), IST_DATE, 106) AS IST_DATE, 
 GENDER_CODE, 
 AFQT_SCORE, 
 COMPONENT_CODE, 
 COMPONENT_DESCRIPTION, 
 RSS_NAME, 
 DISPOSITION_DESCRIPTION,  
 PROGRAM_MOS_CODE,  
 PROJECTED_SHIP_DATE AS PROJECTED_SHIP_DATE_SORT, 
 CONTRACT_BEGIN_DATE AS CONTRACT_BEGIN_DATE_SORT, 
 IST_DATE AS IST_DATE_SORT 
FROM 
 #POOL_VIEW 
 
--- CLEAN UP 
DROP TABLE #ORGID 
DROP TABLE #POOL_VIEW  
 
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>