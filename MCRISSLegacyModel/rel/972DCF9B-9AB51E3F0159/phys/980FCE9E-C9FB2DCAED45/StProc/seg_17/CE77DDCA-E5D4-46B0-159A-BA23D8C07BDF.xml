<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetMedicalExamHistory]" directorySegmentName="seg_17" id="CE77DDCA-E5D4-46B0-159A-BA23D8C07BDF">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@PersonId int, 
 @StatusType char(1) = 'E' 
AS 
 
SET NOCOUNT ON 
 
CREATE TABLE #MEDICAL_EXAM_HISTORY  
 (EXAM_DATE DATETIME NULL, MEDICAL_EXAM_TYPE CHAR(4) NULL, PHYSICAL_EXAM_TYPE VARCHAR(15) NULL, MEDICAL_DISPOSITION VARCHAR(2) NULL, 
 EXAM_PURPOSE_ID INT NULL, EXAM_PURPOSE VARCHAR(15) NULL) 
 
INSERT INTO #MEDICAL_EXAM_HISTORY 
SELECT  
 MEDICAL_EXAM_DATE, 
 MEDICAL_EXAM_TYPE, 
 CASE @StatusType 
  WHEN 'O' THEN 'MEPS PHYSICAL' 
  ELSE NULL 
 END AS PHYSICAL_EXAM_TYPE,  
 CASE MD.MEDICAL_DISPOSITION_CODE 
  WHEN 'DQ' THEN 'D' 
  ELSE COALESCE(MD.MEDICAL_DISPOSITION_CODE, SPACE(0)) 
 END AS MEDICAL_DISPOSITION,   
 NULL, NULL 
FROM  
 CANDIDATE_MEDICAL_EXAM CME LEFT OUTER JOIN MEDICAL_DISPOSITION MD ON  
  CASE CME.MEDICAL_DISPOSITION  
   WHEN 'D' THEN 'DQ'  
   ELSE CME.MEDICAL_DISPOSITION 
   END = MD.MEDICAL_DISPOSITION_CODE 
WHERE  
 MARINE_CANDIDATE_ID = @PersonId 
 
 
 
 
 
IF @StatusType = 'O' 
BEGIN 
 
 INSERT INTO #MEDICAL_EXAM_HISTORY 
 SELECT  
  EXAM_DATE, 
  NULL, 
  'ANNUAL PHYSICAL',  
  COALESCE(MD.MEDICAL_DISPOSITION_CODE, SPACE(0)) AS MEDICAL_DISPOSITION, 
  AP.EXAM_PURPOSE_ID, PEP.EXAM_PURPOSE    
 FROM  
  ANNUAL_PHYSICAL AP INNER JOIN PHYSICAL_EXAM_PURPOSE PEP ON AP.EXAM_PURPOSE_ID = PEP.EXAM_PURPOSE_ID 
  LEFT OUTER JOIN MEDICAL_DISPOSITION MD ON AP.MEDICAL_DISPOSITION_ID = MD.MEDICAL_DISPOSITION_ID 
 WHERE  
  MARINE_CANDIDATE_ID = @PersonId 
 
 INSERT INTO #MEDICAL_EXAM_HISTORY 
 SELECT  
  EXAM_DATE, 
  NULL, 
  'FLIGHT PHYSICAL',  
  COALESCE(MD.MEDICAL_DISPOSITION_CODE, SPACE(0)) AS MEDICAL_DISPOSITION, 
  FP.EXAM_PURPOSE_ID, PEP.EXAM_PURPOSE    
 FROM  
  FLIGHT_PHYSICAL FP INNER JOIN PHYSICAL_EXAM_PURPOSE PEP ON FP.EXAM_PURPOSE_ID = PEP.EXAM_PURPOSE_ID 
  LEFT OUTER JOIN MEDICAL_DISPOSITION MD ON FP.MEDICAL_DISPOSITION_ID = MD.MEDICAL_DISPOSITION_ID 
 WHERE  
  MARINE_CANDIDATE_ID = @PersonId 
END 
 
 
SELECT  
 CONVERT(CHAR(11), EXAM_DATE, 106) AS EXAM_DATE, 
 COALESCE(PHYSICAL_EXAM_TYPE, SPACE(0)) AS PHYSICAL_EXAM_TYPE, 
 COALESCE(MEDICAL_EXAM_TYPE, SPACE(0)) AS MEDICAL_EXAM_TYPE, 
 MEDICAL_DISPOSITION, 
 COALESCE(EXAM_PURPOSE_ID, 0) AS EXAM_PURPOSE_ID, 
 COALESCE(EXAM_PURPOSE, SPACE(0)) AS EXAM_PURPOSE 
FROM  
 #MEDICAL_EXAM_HISTORY 
 
--- CLEAN UP 
DROP TABLE #MEDICAL_EXAM_HISTORY 
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>