<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetJPASApplicantData]" directorySegmentName="seg_5" id="A46CB912-DFA2-872E-0850-868CE703F31F">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[( 
 @PersonID int 
) 
AS 
 
SET NOCOUNT ON  
 
CREATE TABLE #APPLICANT_DATA  
 (PERSON_ID INT NULL, 
 NWA_ID INT NULL, 
 CONTRACT_ID INT NULL, 
 SHIP_ID INT NULL, 
 RSS_ID INT NULL, 
 CANDIDATE_STATUS_ID INT NULL,  
 STATUS_TYPE CHAR(1) NULL, 
 CONTRACT_DATE DATETIME NULL, 
 SHIP_DATE DATETIME NULL, 
 DISTRICT VARCHAR(15) NULL,  
 CATEGORY_CODE CHAR(1) NOT NULL DEFAULT '', 
 EXTRA_COVERAGE VARCHAR(1) NOT NULL DEFAULT '', 
 POSITION_TITLE VARCHAR(30) NOT NULL DEFAULT '', 
 PROJECTED_TRAINING_ORG_ID INT NULL, 
 UNIT_IDENTIFICATION_CODE VARCHAR(50) NULL) 
 
--- GET IDs AND DATES 
INSERT INTO #APPLICANT_DATA  
 (PERSON_ID, 
 NWA_ID, 
 CONTRACT_ID, 
 SHIP_ID, 
 RSS_ID, 
 CANDIDATE_STATUS_ID, 
 CONTRACT_DATE, 
 SHIP_DATE, 
 PROJECTED_TRAINING_ORG_ID) 
SELECT 
 @PersonID, 
 N.NWA_ID, 
 C.CONTRACT_ID, 
 S.SHIP_ID, 
 N.ORGANIZATION_OF_RECORD_ID, 
 dbo.GetMaxStatusID(N.NWA_ID),  
 C.CONTRACT_BEGIN_DATE, 
 S.SHIP_DATE, 
 C.PROJECTED_TRAINING_ORG_ID 
FROM 
 NWA N 
 LEFT OUTER JOIN CONTRACT C ON N.NWA_ID = C.NWA_ID   
 LEFT OUTER JOIN SHIPPER S ON C.CONTRACT_ID = S.CONTRACT_ID 
WHERE 
 N.MARINE_CANDIDATE_ID = @PersonID AND  
 N.NWA_ID = dbo.GetMaxNWAID(@PersonID) 
 
 
--- Check PROJECTED_TRAINING_ORG_ID 
DECLARE @ProjectedTrainingOrgID INT = null 
 
SELECT @ProjectedTrainingOrgID = PROJECTED_TRAINING_ORG_ID 
FROM #APPLICANT_DATA 
 
IF (@ProjectedTrainingOrgID IS NULL) 
BEGIN  
 SELECT @ProjectedTrainingOrgID =  
  (CASE  
   WHEN Region = 901 AND org.OSS IS NULL THEN '1' -- enlisted EASTERN REGION Parris Island 
   WHEN Region = 902 AND org.OSS IS NULL THEN '2' -- enlisted WESTERN REGION San Diego 
   WHEN org.RSS IS NULL THEN '4' -- o.cer OCS Quan.co VA 
  END) 
 FROM 
  #APPLICANT_DATA A  
  INNER JOIN [USMC].[vwRecrui.ngOrgIDs] org 
   ON (A.RSS_ID = org.RSS AND OSS IS NULL)  
    OR 
      (A.RSS_ID = org.OSS AND RSS IS NULL) 
  INNER JOIN [dbo].[MARINE_CANDIDATE] mc 
   ON mc.MARINE_CANDIDATE_ID = A.PERSON_ID 
 
 UPDATE 
  #APPLICANT_DATA 
 SET 
  PROJECTED_TRAINING_ORG_ID = @ProjectedTrainingOrgID 
END  
 
--- Set UNIT_IDENTIFICATION_CODE 
UPDATE 
 #APPLICANT_DATA 
SET 
 UNIT_IDENTIFICATION_CODE = 
  CASE  
   WHEN PROJECTED_TRAINING_ORG_ID = 1 THEN 'M30401-1 - USMC Accessions East-1' --Parris Island: USMC Accessions East-1 
   WHEN PROJECTED_TRAINING_ORG_ID = 2 THEN 'M30407-2 - USMC Accessions West-1' --San Diego: USMC Accessions West-1 
   ELSE 'UNK' 
  END 
   
--- GET STATUS TYPE 
UPDATE 
 #APPLICANT_DATA 
SET 
 STATUS_TYPE = CS.STATUS_TYPE 
FROM 
 #APPLICANT_DATA A 
 INNER JOIN CANDIDATE_STATUS CS ON A.CANDIDATE_STATUS_ID = CS.CANDIDATE_STATUS_ID  
 
--- GET DISTRICT 
UPDATE 
 #APPLICANT_DATA 
SET 
 DISTRICT = DIST.SHORT_NAME 
FROM 
 #APPLICANT_DATA A 
 INNER JOIN ORGANIZATION_MAP RSS ON A.RSS_ID = RSS.CHILD_ORGANIZATION_ID 
 INNER JOIN ORGANIZATION_MAP RS ON RSS.PARENT_ORGANIZATION_ID = RS.CHILD_ORGANIZATION_ID 
 INNER JOIN RECRUITING_ORGANIZATION DIST ON RS.PARENT_ORGANIZATION_ID = DIST.ORGANIZATION_ID 
 
--- SET CATEGORY CODE 
UPDATE 
 #APPLICANT_DATA 
SET 
 CATEGORY_CODE = CASE  
    --- OFFICERS 
    WHEN STATUS_TYPE = 'O' THEN 'X' 
    --- DIRECT SHIPPERS AND PRIOR SERVICE 
    WHEN (SHIP_ID IS NOT NULL AND DATEDIFF(DAY, CONTRACT_DATE, SHIP_DATE) = 0) THEN 'B' 
    ELSE 'S' 
    END 
 
--- SET EXTRA COVERAGE 
UPDATE 
 #APPLICANT_DATA 
SET 
 --- SET TO 3 IF THE APPLICANT HAS A UV OR UW PROGRAM 
 EXTRA_COVERAGE = '3' 
 
FROM 
 #APPLICANT_DATA A 
 INNER JOIN PROGRAM_AVAILABILITY PA ON A.CONTRACT_ID = PA.CONTRACT_ID 
 INNER JOIN PROGRAM P ON  
  (PA.PROGRAM_ID = P.PROGRAM_ID AND  
  P.PROGRAM_CODE IN ('UV', 'UW')) 
 
--- SET POSITION TITLE 
UPDATE 
 #APPLICANT_DATA 
SET 
 POSITION_TITLE = CASE STATUS_TYPE 
    WHEN 'O' THEN 'MARINE CORPS OFFICER CANDIDATE' 
    ELSE 'MARINE CORPS ENLISTED' 
    END 
   
--- RETURN DATA 
SELECT  
 COALESCE(CATEGORY_CODE, '') AS CATEGORY_CODE, 
 COALESCE(UNIT_IDENTIFICATION_CODE, 'UNK') AS UNIT_IDENTIFICATION_CODE, 
 COALESCE(EXTRA_COVERAGE, '') AS EXTRA_COVERAGE,  
 COALESCE(POSITION_TITLE, '') AS POSITION_TITLE 
FROM  
 #APPLICANT_DATA  
 
--- CLEAN UP 
DROP TABLE #APPLICANT_DATA  
SET NOCOUNT OFF]]></body>
<schema>E9C4E37D-78A2-31F9-D580-7C2848ACFCB7</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>