<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetFourKData]" directorySegmentName="seg_5" id="79FDF037-51B5-E92D-707B-730384913AB4">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:42 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[( 
 @PersonID int, 
 @NwaID int,  
 @MepsOrgID int 
)  
AS 
 
 --- MEPS DATA PARAMETERS 
DECLARE @MepsIPAddress varchar(20)  
DECLARE @MepsIPAddressUser varchar(20)  
DECLARE @MepsIPAddressPwd varchar(20) 
DECLARE @MepsSta.onID char(3) 
DECLARE @OtherMEPSRecordExists char(1) 
 --- EDUCATION DATA 
DECLARE @MaxEdLevel char(2) 
DECLARE @MaxEdCode char(1) 
 --- LANGUAGE DATA  
DECLARE @LangCode1 char(2) 
DECLARE @LangCode2 char(2) 
DECLARE @LangDesc1 char(22) 
DECLARE @LangDesc2 char(22) 
 --- MEDICAL, ASVAB DEPENDENT AND PRIOR SERVICE DATA 
DECLARE @LastFullMedicalDate char(8) 
DECLARE @LastASVABDate char(8) 
DECLARE @DependentCount int 
DECLARE @PriorService char(1) 
 --- RECRUITER SSN 
DECLARE @RecruiterSSN char(9) 
 --- ADDRESS DATA 
DECLARE @CurStreetAddress char(29) 
DECLARE @CurCityCode char(4)  
DECLARE @CurCityText char(21) 
DECLARE @CurCountyCode char(3) 
DECLARE @CurCountyText char(36) 
DECLARE @CurStateCode char(2) 
DECLARE @CurStateText char(2) 
DECLARE @CurZipcode char(9) 
DECLARE @HorStreetAddress char(29) 
DECLARE @HorCityCode char(4) 
DECLARE @HorCityText char(21) 
DECLARE @HorCountyCode char(3) 
DECLARE @HorCountyText char(36) 
DECLARE @HorStateCode char(2) 
DECLARE @HorStateText char(2) 
DECLARE @HorZipcode char(9) 
 --- COUNTRY AND MCC CODE 
DECLARE @Country char(12) 
DECLARE @RSSMCCCode char(5) 
 --- MEPCOM RACE/ETHNIC CODES 
DECLARE @MEPCOMEthnicCode char(1)  
DECLARE @MEPCOMRaceCode char(1) 
DECLARE @MEPCOMEthnicDesc char(8) 
DECLARE @MEPCOMRaceDesc char(8) 
DECLARE @AlienRegistra.onNumber char(9) 
 
 
DECLARE @BIRTH_CITY char(17) 
DECLARE @BIRTH_COUNTY char(2) 
DECLARE @BIRTH_COUNTRY char(2) 
DECLARE @BIRTH_STATE char(2) 
 
DECLARE @ReligionCode char(2) 
DECLARE @ReligionText char(11) 
 
 
DECLARE @DBID  INT 
DECLARE @DBNAME NVARCHAR(128) 
 
SELECT  
 @DBID = DB_ID(), 
 @DBNAME = DB_NAME() 
 
 
--- MAKE SURE THE PERSON EXISTS IN THE PERSON TABLE 
IF NOT EXISTS (SELECT P.PERSON_ID FROM PERSON P WITH (NOLOCK) WHERE P.PERSON_ID = @PersonID) 
BEGIN 
 RAISERROR ('The Person does not exist in the PERSON table.', 16, 1, @DBID, @DBNAME) 
 RETURN 
END 
 
--- MAKE SURE THE PERSON EXISTS IN THE MARINE_CANDIDATE TABLE 
IF NOT EXISTS (SELECT MC.MARINE_CANDIDATE_ID FROM MARINE_CANDIDATE MC WITH (NOLOCK) INNER JOIN PERSON P ON  
  (MC.MARINE_CANDIDATE_ID = P.PERSON_ID AND 
  P.PERSON_ID = @PersonID)) 
BEGIN 
 RAISERROR ('The Person does not exist in the MARINE_CANDIDATE table.', 16, 2, @DBID, @DBNAME) 
 RETURN 
END 
 
--- MAKE SURE THE PERSON EXISTS IN THE NWA TABLE 
IF NOT EXISTS (SELECT N.NWA_ID FROM NWA N WITH (NOLOCK) INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
  INNER JOIN PERSON P ON  
 (MC.MARINE_CANDIDATE_ID = P.PERSON_ID AND 
 P.PERSON_ID = @PersonID)) 
BEGIN 
 RAISERROR ('The Person does not exist in the NWA table.', 16, 3, @DBID, @DBNAME) 
 RETURN 
END 
 
 
--- MEPS DATA 
SELECT 
 @MepsSta.onID = MOL.MEPS_CODE, 
 @MepsIPAddress = MOL.MEPS_IP_ADDRESS, 
 @MepsIPAddressUser = MOL.MEPS_IPADDRESS_USER,  
 @MepsIPAddressPwd = MOL.MEPS_IPADDRESS_PWD 
FROM 
 MEPS_ORGANIZATION_LOOKUP MOL WITH (NOLOCK) 
WHERE 
 MOL.MEPS_ORGANIZATION_ID = @MepsOrgID  
 
--- OTHER MEPS RECORD EXISTS 
SELECT 
 @OtherMEPSRecordExists = CASE 
   WHEN EXISTS (SELECT 1 FROM MEPS_SCHEDULE MS 
   WHERE MS.NWA_ID = @NWAID AND 
   MS.MEPS_ORGANIZATION_ID != @MEPSOrgID)  
   THEN 'Y' 
   ELSE 'N' 
   END 
 
--- EDUCATION DATA 
SELECT 
 @MaxEdLevel = CE.EDUCATION_LEVEL, 
 @MaxEdCode = CE.EDUCATION_CODE 
FROM 
 CANDIDATE_EDUCATION CE WITH (NOLOCK) 
WHERE  
 CE.MARINE_CANDIDATE_ID = @PersonID AND 
 CE.SCHOOL_END_DATE = (SELECT MAX(CE1.SCHOOL_END_DATE) FROM CANDIDATE_EDUCATION CE1 
  WHERE CE1.MARINE_CANDIDATE_ID = CE.MARINE_CANDIDATE_ID) 
 
--- RELIGION DATA 
SELECT 
 @ReligionCode = mc.RELIGION_CODE, 
 @ReligionText = r.RELIGION_CODE_DESC 
FROM 
 MARINE_CANDIDATE mc WITH (NOLOCK) 
 LEFT JOIN RELIGION r on mc.Religion_Code = r.Religion_Code 
WHERE  
 mc.MARINE_CANDIDATE_ID = @PersonID 
 
 
----------------------- 
--- LANGUAGE DATA  
----------------------- 
SELECT 
 @LangCode1 = CASE (SELECT COUNT(CL1.MARINE_CANDIDATE_ID) FROM CANDIDATE_LANGUAGE CL1 WITH (NOLOCK)  
  WHERE CL1.MARINE_CANDIDATE_ID = CL.MARINE_CANDIDATE_ID AND 
  CL1.LANGUAGE_CODE < CL.LANGUAGE_CODE)  
 WHEN 0 THEN CL.LANGUAGE_CODE 
 ELSE @LangCode1 
 END, 
 @LangCode2 = CASE (SELECT COUNT(CL1.MARINE_CANDIDATE_ID) FROM CANDIDATE_LANGUAGE CL1  
  WHERE CL1.MARINE_CANDIDATE_ID = CL.MARINE_CANDIDATE_ID AND 
  CL1.LANGUAGE_CODE < CL.LANGUAGE_CODE)  
 WHEN 1 THEN CL.LANGUAGE_CODE 
 ELSE @LangCode2 
 END 
FROM 
 CANDIDATE_LANGUAGE CL WITH (NOLOCK) 
WHERE 
 CL.MARINE_CANDIDATE_ID = @PersonID 
 
SELECT 
 @LangCode1 = COALESCE(@LangCode1, SPACE(0)), 
 @LangCode2 = COALESCE(@LangCode2, SPACE(0)) 
 
IF @LangCode1 IS NOT NULL 
BEGIN 
 SELECT 
  @LangDesc1 = L.LANGUAGE_CODE_DESCRIPTION  
 FROM 
  LANGUAGE L WITH (NOLOCK) 
 WHERE  
  L.LANGUAGE_CODE = @LangCode1 
 
 
 SELECT @LangDesc1 = COALESCE(@LangDesc1, SPACE(0)) 
END  
 
IF @LangCode2 IS NOT NULL 
BEGIN 
 SELECT 
  @LangDesc2 = L.LANGUAGE_CODE_DESCRIPTION  
 FROM 
  LANGUAGE L WITH (NOLOCK) 
 WHERE  
  L.LANGUAGE_CODE = @LangCode2 
 
 
 SELECT @LangDesc2 = COALESCE(@LangDesc2, SPACE(0)) 
END  
 
 
--- MEDICAL, ASVAB DEPENDENT AND PRIOR SERVICE DATA 
SELECT 
 @LastFullMedicalDate = COALESCE(CONVERT(CHAR(8), (SELECT MAX(CME.MEDICAL_EXAM_DATE) FROM CANDIDATE_MEDICAL_EXAM CME 
    WHERE CME.MARINE_CANDIDATE_ID = @PersonID AND 
    CME.MEDICAL_EXAM_TYPE = 'FULL'), 112), '00000000'), 
 @LastASVABDate = COALESCE(CONVERT(CHAR(8), (SELECT MAX(CA.ASVAB_DATE) FROM CANDIDATE_ASVAB CA 
   WHERE CA.MARINE_CANDIDATE_ID = @PersonID), 112), '00000000'), 
 @DependentCount = (SELECT COUNT(CD.MARINE_CANDIDATE_ID) FROM CANDIDATE_DEPENDENT CD 
  WHERE CD.MARINE_CANDIDATE_ID = @PersonID), 
 @PriorService = CASE  
  WHEN EXISTS (SELECT 1 FROM CANDIDATE_PRIOR_SERVICE CPS  
  WHERE CPS.MARINE_CANDIDATE_ID = @PersonID) THEN 'Y' 
  ELSE 'N' 
 END 
 
 
 
--- RECRUITER SSN 
IF @RecruiterSSN IS NULL OR LEN(RTRIM(LTRIM(@RecruiterSSN))) = 0 
BEGIN 
 SELECT 
  @RecruiterSSN = P.SOCIAL_SECURITY_NUMBER 
 FROM 
  NWA N WITH (NOLOCK) INNER JOIN PERSON P ON  
 (N.RECRUITER_OF_RECORD_ID = P.PERSON_ID AND 
 N.NWA_ID = @NWAID) 
END 
 
----------------------- 
--- ADDRESS DATA 
----------------------- 
 
--- RETRIEVE CUR ADDRESS 
IF (@CurStreetAddress IS NULL OR LEN(RTRIM(LTRIM(@CurStreetAddress))) = 0) OR 
 (@CurStateCode IS NULL OR LEN(RTRIM(LTRIM(@CurStateCode))) = 0) OR 
 (@CurZipcode IS NULL OR LEN(RTRIM(LTRIM(@CurZipcode))) = 0) 
BEGIN 
 SELECT 
  @CurStreetAddress = CUR.STREET_ADDRESS, 
  @CurCityCode = CUR.CITY_CODE,  
  @CurCityText = (SELECT TOP 1 GL.CITY_TEXT FROM GEO_LOCATION GL 
  WHERE GL.CITY_CODE = CUR.CITY_CODE AND 
  GL.COUNTY_CODE = CUR.COUNTY_CODE AND 
  GL.STATE_CODE = CUR.STATE_CODE),  
  @CurCountyCode = CUR.COUNTY_CODE, 
  @CurCountyText = (SELECT TOP 1 GL.COUNTY_TEXT FROM GEO_LOCATION GL 
  WHERE GL.COUNTY_CODE = CUR.COUNTY_CODE AND 
  GL.STATE_CODE = CUR.STATE_CODE), 
  @CurStateCode = CUR.STATE_CODE, 
  @CurStateText = (SELECT TOP 1 GL.STATE_TEXT FROM GEO_LOCATION GL 
  WHERE GL.STATE_CODE = CUR.STATE_CODE), 
  @CurZipcode = CUR.ZIPCODE 
 FROM 
  CANDIDATE_ADDRESS CUR WITH (NOLOCK) 
 WHERE 
  CUR.MARINE_CANDIDATE_ID = @PersonID AND 
  CUR.ADDRESS_TYPE = 'C'  
END 
 
 
--- RETRIEVE HOR ADDRESS 
IF (@HorStreetAddress IS NULL OR LEN(RTRIM(LTRIM(@HorStreetAddress))) = 0) OR 
 (@HorStateCode IS NULL OR LEN(RTRIM(LTRIM(@HorStateCode))) = 0) OR 
 (@HorZipcode IS NULL OR LEN(RTRIM(LTRIM(@HorZipcode))) = 0) 
BEGIN 
 SELECT 
 
  @HorStreetAddress = HOR.STREET_ADDRESS, 
  @HorCityCode = HOR.CITY_CODE,  
  @HorCityText = (SELECT TOP 1 GL.CITY_TEXT FROM GEO_LOCATION GL 
  WHERE GL.CITY_CODE = HOR.CITY_CODE AND 
  GL.COUNTY_CODE = HOR.COUNTY_CODE AND 
  GL.STATE_CODE = HOR.STATE_CODE),  
  @HorCountyCode = HOR.COUNTY_CODE, 
  @HorCountyText = (SELECT TOP 1 GL.COUNTY_TEXT FROM GEO_LOCATION GL 
  WHERE GL.COUNTY_CODE = HOR.COUNTY_CODE AND 
  GL.STATE_CODE = HOR.STATE_CODE), 
  @HorStateCode = HOR.STATE_CODE, 
  @HorStateText = (SELECT TOP 1 GL.STATE_TEXT FROM GEO_LOCATION GL 
  WHERE GL.STATE_CODE = HOR.STATE_CODE), 
  @HorZipcode = HOR.ZIPCODE 
 FROM 
  CANDIDATE_ADDRESS HOR WITH (NOLOCK) 
 WHERE 
  HOR.MARINE_CANDIDATE_ID = @PersonID AND 
  HOR.ADDRESS_TYPE = 'H' 
END 
 
  
--- RETRIEVE COUNTRY OF ORIGIN 
IF @Country IS NULL OR LEN(LTRIM(RTRIM(@Country))) = 0 
BEGIN 
 --SELECT 
 -- @Country = C.COUNTRY_DESCRITION 
 --FROM  
 -- COUNTRY C INNER JOIN MARINE_CANDIDATE MC ON 
 --  (C.COUNTRY_CODE = MC.COUNTRY_OF_ORIGIN AND 
 --  MC.MARINE_CANDIDATE_ID = @PersonID) 
 SELECT 
  @Country = G.COUNTRY_DESCRIPTION 
 FROM  
  GEO_LOCATION G WITH (NOLOCK) INNER JOIN MARINE_CANDIDATE MC ON 
 (G.STATE_CODE = MC.COUNTRY_OF_ORIGIN AND 
 MC.MARINE_CANDIDATE_ID = @PersonID) 
 
 SELECT @Country = COALESCE(@Country, SPACE(0)) 
END  
 
--- RETRIEVE RSS MCC CODE 
IF @RSSMCCCode IS NULL OR LEN(LTRIM(RTRIM(@RSSMCCCode))) = 0 
BEGIN 
 SELECT  
  @RSSMCCCode = RO.MCC_CODE 
 FROM 
  RECRUITING_ORGANIZATION RO WITH (NOLOCK) INNER JOIN NWA N ON 
 (RO.ORGANIZATION_ID = N.ORGANIZATION_OF_RECORD_ID AND 
 N.NWA_ID = @NWAID) 
 
 SELECT @RSSMCCCode = COALESCE(@RSSMCCCode, SPACE(0)) 
END  
 
--- RETRIEVE MEPCOM RACE/ETHNIC CODES 
IF (@MEPCOMEthnicCode IS NULL OR LEN(LTRIM(RTRIM(@MEPCOMEthnicCode))) = 0) OR 
 (@MEPCOMRaceCode IS NULL OR LEN(LTRIM(RTRIM(@MEPCOMRaceCode))) = 0) 
BEGIN 
 SELECT  
  @MEPCOMEthnicCode = MC.MEPCOM_ETHNIC_CODE, 
  @MEPCOMRaceCode = MC.MEPCOM_RACE_CODE, 
  @BIRTH_CITY = MC.BIRTH_CITY, 
  @BIRTH_COUNTY = MC.BIRTH_COUNTY, 
  @BIRTH_COUNTRY = MC.COUNTRY_OF_ORIGIN, 
  @BIRTH_STATE = MC.BIRTH_STATE 
 FROM  
  MARINE_CANDIDATE MC WITH (NOLOCK) 
 WHERE  
  MC.MARINE_CANDIDATE_ID = @PersonID 
 
 SELECT  
  @MEPCOMEthnicCode = COALESCE(@MEPCOMEthnicCode, SPACE(0)), 
  @MEPCOMRaceCode = COALESCE(@MEPCOMRaceCode, SPACE(0)) 
END  
 
 
--- RETRIEVE MEPCOM RACE/ETHNIC DESCRIPTIONS 
IF (@MEPCOMEthnicDesc IS NULL OR LEN(LTRIM(RTRIM(@MEPCOMEthnicDesc))) = 0) 
BEGIN 
 SELECT  
  @MEPCOMEthnicDesc = MEC.ETHNIC_CATEGORY_DESC 
 FROM  
  MEPCOM_ETHNIC_CATEGORY MEC WITH (NOLOCK) 
 WHERE  
  MEC.ETHNIC_CATEGORY_CODE = @MEPCOMEthnicCode 
 
 SELECT @MEPCOMEthnicDesc = COALESCE(@MEPCOMEthnicDesc, SPACE(0)) 
END 
 
IF (@MEPCOMRaceDesc IS NULL OR LEN(LTRIM(RTRIM(@MEPCOMRaceDesc))) = 0) 
BEGIN 
 SELECT  
  @MEPCOMRaceDesc = MRC.RACE_CATEGORY_DESC 
 FROM  
  MEPCOM_RACE_CATEGORY MRC WITH (NOLOCK) 
 WHERE  
  MRC.RACE_CATEGORY_CODE = @MEPCOMRaceCode 
 
 SELECT @MEPCOMRaceDesc = COALESCE(@MEPCOMRaceDesc, SPACE(0)) 
END 
 
--- RETRIEVE ALIEN REGISTRATION NUMBER 
IF (@AlienRegistra.onNumber IS NULL OR LEN(LTRIM(RTRIM(@AlienRegistra.onNumber))) = 0)  
BEGIN 
 IF EXISTS (SELECT 1 FROM ALIEN_REGISTRATION WHERE MARINE_CANDIDATE_ID = @PersonID) 
 BEGIN 
  SELECT  
 @AlienRegistra.onNumber = ARN 
  FROM  
 ALIEN_REGISTRATION 
  WHERE 
 MARINE_CANDIDATE_ID = @PersonID  
 END 
 
 SET @AlienRegistra.onNumber = COALESCE(@AlienRegistra.onNumber, SPACE(0)) 
END 
 
SELECT 
@AlienRegistra.onNumber AS AlienRegistra.onNumber, 
@BIRTH_CITY AS BIRTH_CITY, 
@BIRTH_COUNTY AS BIRTH_COUNTY, 
@BIRTH_COUNTRY AS BIRTH_COUNTRY, 
@BIRTH_STATE AS BIRTH_STATE, 
@Country AS Country, 
@CurCityCode AS CurCityCode, 
@CurCityText AS CurCityText, 
@CurCountyCode AS CurCountyCode, 
@CurCountyText AS CurCountyText, 
@CurStateCode AS CurStateCode, 
@CurStateText AS CurStateText, 
@CurStreetAddress AS CurStreetAddress, 
@CurZipcode AS CurZipcode, 
@DependentCount AS DependentCount, 
@HorCityCode AS HorCityCode, 
@HorCityText AS HorCityText, 
@HorCountyCode AS HorCountyCode, 
@HorCountyText AS HorCountyText, 
@HorStateCode AS HorStateCode, 
@HorStateText AS HorStateText, 
@HorStreetAddress AS HorStreetAddress, 
@HorZipcode AS HorZipcode, 
@LangCode1 AS LangCode1, 
@LangCode2 AS LangCode2, 
@LangDesc1 AS LangDesc1, 
@LangDesc2 AS LangDesc2, 
@LastASVABDate AS LastASVABDate, 
@LastFullMedicalDate AS LastFullMedicalDate, 
@MaxEdCode AS MaxEdCode, 
@MaxEdLevel AS MaxEdLevel, 
@MEPCOMEthnicCode AS MEPCOMEthnicCode, 
@MEPCOMEthnicDesc AS MEPCOMEthnicDesc, 
@MEPCOMRaceCode AS MEPCOMRaceCode, 
@MEPCOMRaceDesc AS MEPCOMRaceDesc, 
@MepsIPAddress AS MepsIPAddress, 
@MepsIPAddressPwd AS MepsIPAddressPwd, 
@MepsIPAddressUser AS MepsIPAddressUser, 
@MepsSta.onID AS MepsSta.onID, 
@OtherMEPSRecordExists AS OtherMEPSRecordExists, 
@PriorService AS PriorService, 
@RecruiterSSN AS RecruiterSSN, 
@ReligionCode AS ReligionCode, 
@ReligionText AS ReligionText, 
@RSSMCCCode AS RSSMCCCode]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>