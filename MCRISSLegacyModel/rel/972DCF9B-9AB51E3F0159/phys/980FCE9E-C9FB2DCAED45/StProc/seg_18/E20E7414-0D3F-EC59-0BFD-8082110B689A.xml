<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetMIRSImportView]" directorySegmentName="seg_18" id="E20E7414-0D3F-EC59-0BFD-8082110B689A">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@SSN char(9) 
 
 
AS 
 
SET NOCOUNT ON 
 
--- CREATE TEMP TABLE TO HOLD DATA 
CREATE TABLE #MIRS_IMPORT_VIEW  
 (MIRS_IMPORT_ID INT NULL, PERSON_ID INT NULL, NWA_ID INT NULL, CONTRACT_ID INT NULL, SHIP_ID INT NULL,   
 STATUS_TYPE CHAR(1) NOT NULL DEFAULT SPACE(0), STATUS_CODE CHAR(1) NOT NULL DEFAULT SPACE(0), DISPOSITION_CODE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 FULL_NAME VARCHAR(60) NULL, [FILE_NAME] VARCHAR(40) NULL, SSN CHAR(9), WORK_ID VARCHAR(5),  
 REPROCESS CHAR(1) NULL, PENDING_EDUCATION CHAR(1) NOT NULL DEFAULT SPACE(0),  
 EDUCATION_LEVEL CHAR(1) NOT NULL DEFAULT SPACE(0), PENDING_WAIVER CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_DEPENDENT CHAR(1) NOT NULL DEFAULT SPACE(0),  IST_BLOCK_INCOMPLETE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 RESERVIST_WITHOUT_QSN CHAR(1) NOT NULL DEFAULT SPACE(0)) 
 
 
--- GET MIRS IMPORT DATA 
INSERT INTO #MIRS_IMPORT_VIEW (MIRS_IMPORT_ID, PERSON_ID, NWA_ID, CONTRACT_ID, SHIP_ID, FULL_NAME, [FILE_NAME], SSN, WORK_ID, REPROCESS)  
SELECT  
 L.MIRS_IMPORT_ID,  
 COALESCE(P.PERSON_ID, 0) AS PERSON_ID,  
 COALESCE(N.NWA_ID, 0) AS NWA_ID,  
 COALESCE(C.CONTRACT_ID, 0) AS CONTRACT_ID,  
 COALESCE(S.SHIP_ID, 0) AS SHIP_ID,  
 LTRIM(RTRIM(P.LAST_NAME)) + ', ' + LTRIM(RTRIM(P.FIRST_NAME)) + SPACE(1) + COALESCE(LEFT(P.LEGAL_MIDDLE_NAME, 1), SPACE(0)) AS FULL_NAME,  
 L.[FILE_NAME], L.SSN, L.MIRS_TRANSACTION AS WORK_ID, 
 CASE  
  WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG EL ON  
     (E.ERROR_LOG_ID = EL.ERROR_LOG_ID AND 
     EL.ERROR_CD != 38 AND 
     EL.STATUS = 'UNRESOLVED' AND  
     EL.REPROCESS = 'Y') 
    WHERE 
     E.MIRS_IMPORT_ID = L.MIRS_IMPORT_ID) THEN 'Y' 
   ELSE 'N' 
 END AS REPROCESS 
    
FROM 
 [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_LOG L  
 LEFT OUTER JOIN PERSON P ON L.SSN = P.SOCIAL_SECURITY_NUMBER 
 LEFT OUTER JOIN NWA N ON  
  (P.PERSON_ID = N.MARINE_CANDIDATE_ID AND 
  N.NWA_ID = dbo.GetMaxNWAID(N.MARINE_CANDIDATE_ID)) 
 LEFT OUTER JOIN CONTRACT C ON N.NWA_ID = C.NWA_ID 
 LEFT OUTER JOIN SHIPPER S ON C.CONTRACT_ID = S.CONTRACT_ID 
WHERE 
 L.SSN = @SSN 
 
--- GET STATUS/DISPOSITION DATA 
UPDATE 
 #MIRS_IMPORT_VIEW  
SET 
 STATUS_TYPE   = CS.STATUS_TYPE,  
 STATUS_CODE   = CS.STATUS_CODE,  
 DISPOSITION_CODE  = CS.DISPOSITION_CODE 
FROM 
 #MIRS_IMPORT_VIEW V INNER JOIN CANDIDATE_STATUS CS ON  
  (V.NWA_ID = CS.NWA_ID AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 
 
--- GET MIRS REPROCESSOR/ERROR DATA 
UPDATE 
 #MIRS_IMPORT_VIEW  
SET 
 PENDING_EDUCATION = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD = 66 AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
    ELSE SPACE(0) 
    END,    
 EDUCATION_LEVEL = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD IN (67, 68) AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
 
    ELSE SPACE(0) 
    END,   
 PENDING_WAIVER = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD = 69 AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
    ELSE SPACE(0) 
    END,    
 PENDING_DEPENDENT = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD = 70 AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
    ELSE SPACE(0) 
    END,    
 IST_BLOCK_INCOMPLETE = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD = 73 AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
    ELSE SPACE(0) 
    END,   
 RESERVIST_WITHOUT_QSN = CASE  
    WHEN EXISTS (SELECT 1 FROM [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.MIRS_IMPORT_ERROR E INNER JOIN [MCRISS-vdb02\REPORT].MCRISS_ERROR.dbo.ERROR_LOG L ON 
      (E.ERROR_LOG_ID = L.ERROR_LOG_ID AND 
      L.ERROR_CD = 74 AND 
      L.STATUS = 'UNRESOLVED' AND 
      L.REPROCESS = 'Y' AND 
      E.MIRS_IMPORT_ID = V.MIRS_IMPORT_ID)) 
     THEN 'Y' 
    ELSE SPACE(0) 
    END  
FROM 
 #MIRS_IMPORT_VIEW V 
WHERE 
 REPROCESS = 'Y' 
  
 
--- RETURN DATA 
SELECT 
 MIRS_IMPORT_ID, PERSON_ID, NWA_ID, CONTRACT_ID,  
 SHIP_ID, STATUS_TYPE, STATUS_CODE, DISPOSITION_CODE,  
 FULL_NAME, [FILE_NAME], SSN, WORK_ID,  
 PENDING_EDUCATION, EDUCATION_LEVEL, PENDING_WAIVER,  
 PENDING_DEPENDENT, IST_BLOCK_INCOMPLETE, RESERVIST_WITHOUT_QSN 
FROM 
 #MIRS_IMPORT_VIEW  
 
--- CLEAN UP 
DROP TABLE #MIRS_IMPORT_VIEW  
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>