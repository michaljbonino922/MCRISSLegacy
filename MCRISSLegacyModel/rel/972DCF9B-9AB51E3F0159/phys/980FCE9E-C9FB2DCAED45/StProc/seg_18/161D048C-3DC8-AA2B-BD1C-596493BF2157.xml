<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetMUDNewFIPS]" directorySegmentName="seg_18" id="161D048C-3DC8-AA2B-BD1C-596493BF2157">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[AS 
 
 
SET NOCOUNT ON 
 
--- REMOVE TYPE M ZIPS 
DELETE MUD_STAGING 
WHERE 
 TYPE = 'M' 
 
 
 
--- CREATE TABLE OF NEW FIPS 
CREATE TABLE #TEMP_NEW_FIPS 
( 
FIPS VARCHAR(5) NULL, 
STATE VARCHAR(2) NULL 
) 
 
INSERT INTO #TEMP_NEW_FIPS 
SELECT DISTINCT MS.FIPS, MS.STATE 
FROM 
 MUD_STAGING MS 
WHERE 
 NOT EXISTS (SELECT 1 FROM MUD_REGIONS MR WHERE MR.FIPS = MS.FIPS) 
  
 
 --- CREATE TABLE OF FIPS WHICH CROSS MORE THAN 1 DISTRICT 
 CREATE TABLE #TEMP_DUP_FIPS 
 ( 
 ID INT IDENTITY, 
 FIPS VARCHAR(5) NULL 
 ) 
 
 INSERT INTO #TEMP_DUP_FIPS 
 
 SELECT FIPS  
 FROM #TEMP_NEW_FIPS 
 GROUP BY FIPS 
 HAVING COUNT(FIPS) > 1 
 
 DELETE FROM #TEMP_NEW_FIPS 
 WHERE FIPS IN (SELECT FIPS FROM #TEMP_DUP_FIPS) 
 
 
 --- LOOP THROUGH AN ADD THE FIPS BACK INTO THE TABLE 
 DECLARE @CNT AS INT 
 
 SET @CNT = 1 
 
 WHILE @CNT <= (SELECT COUNT(1) FROM #TEMP_DUP_FIPS) 
 
 BEGIN 
 
  --- DEFAULT TO EASTERN REGION FOR FIPS CROSSING MULTI-DISTRICTS 
  INSERT INTO #TEMP_NEW_FIPS (FIPS, STATE) 
  SELECT FIPS, 'VA'  
  FROM #TEMP_DUP_FIPS WHERE ID = @CNT 
 
  SET @CNT = @CNT + 1 
 
 END 
 
 
 
--- CHECK IF THERE ANY NEW FIPS CODES ADD THEM INTO THE MUD_REGIONS TABLE 
 
IF EXISTS (SELECT 1 FROM #TEMP_NEW_FIPS) 
BEGIN 
  
 
 
 IF (SELECT COUNT(1) FROM #TEMP_NEW_FIPS) > 0 
 BEGIN 
  INSERT INTO MUD_REGIONS (FIPS, REGION_NAME, REGION_ID, DIST_NAME, DIST_ID, USER_LOGIN, UPDATE_DATE) 
   
  SELECT DISTINCT TF.FIPS AS NEWFIPS,  
    ISNULL(MU.MUD_ORG_NAME, 'E') AS REGION,   
    ISNULL(MU.ORG_ID, 901) AS ORG_ID,  
    MR.DIST_NAME,  
    MU2.ORG_ID, 
    'DTS' AS USER_LOGIN, 
    GETDATE() AS UPDATE_DATE 
  FROM  
   #TEMP_NEW_FIPS TF LEFT OUTER JOIN MUD_REGIONS MR ON 
   TF.STATE = MR.STATE 
   LEFT OUTER JOIN MUD_USER_DATA MU ON 
   MR.REGION_NAME = MU.MUD_ORG_NAME 
   LEFT OUTER JOIN MUD_USER_DATA MU2 ON 
   MR.DIST_NAME = MU2.MUD_ORG_NAME 
 
 END 
 
 
 
END 
 
 
 
DROP TABLE #TEMP_NEW_FIPS 
DROP TABLE #TEMP_DUP_FIPS 
 
SET NOCOUNT OFF]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>