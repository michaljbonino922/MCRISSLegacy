<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetPersonnelByUnit]" directorySegmentName="seg_19" id="03ADB2B4-BB38-180D-6E1C-BEE6ECD6599D">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@Organiza.onID int 
AS 
 
SET NOCOUNT ON 
 
DECLARE 
 @MonthBeginDate date.me, 
 @OrgType char(3) 
 
SET  @MonthBeginDate = CONVERT(date.me, CONVERT(varchar, month(getdate())) + '/1/' + CONVERT(varchar, year(getdate()))) 
SET  @OrgType = (SELECT TOP 1 ORGANIZATION_TYPE FROM RECRUITING_ORGANIZATION WHERE ORGANIZATION_ID = @Organiza.onID) 
 
CREATE TABLE #TEMP_RECRUITING_PERSON ( 
 RECRUITING_PERSON_ID INT NOT NULL, 
 ORGANIZATION_ID INT NOT NULL, 
 RECRUITING_ROLE_ID CHAR(1) NOT NULL, 
 SHORT_DESCRIPTION CHAR(20) NULL, 
 SHORT_NAME CHAR(20) NULL, 
 [NAME] CHAR(50) NULL, 
 RANK CHAR(7) NULL, 
 ORGANIZATION_TYPE CHAR(4) NULL 
) 
 
 
INSERT INTO #TEMP_RECRUITING_PERSON 
 
--- SELECT PERSONNEL FROM THE ORGANIZATION 
SELECT 
 RP.RECRUITING_PERSON_ID,  
 RP.ORGANIZATION_ID, 
 RR.RECRUITING_ROLE_ID, 
 RR.SHORT_DESCRIPTION, 
 NULL AS SHORT_NAME, 
 P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) AS [NAME], 
 COALESCE(RP.RANK_CODE, SPACE(0)) AS RANK, 
 NULL AS ORGANIZATION_TYPE 
FROM  
 RECRUITING_PERSON RP INNER JOIN PERSON P ON 
  (RP.RECRUITING_PERSON_ID = P.PERSON_ID AND 
  RP.ORGANIZATION_ID = @Organiza.onID AND 
  --- TOUR END DATE IS NULL FOR ALL PEOPLE CURRENTLY ASSIGNED TO THE UNIT 
  RP.TOUR_END_DATE IS NULL) 
 INNER JOIN RECRUITING_ROLE RR ON RP.RECRUITING_ROLE_ID = RR.RECRUITING_ROLE_ID 
WHERE 
 (@OrgType = 'RS' AND RR.SHORT_DESCRIPTION != 'OSO') OR  
 (@OrgType != 'RS') 
 
UNION 
 
--- SELECT STAFF PERSONNEL FROM THE CHILD ORGANIZATIONS 
SELECT 
 RP.RECRUITING_PERSON_ID, 
 RP.ORGANIZATION_ID, 
 RR.RECRUITING_ROLE_ID, 
 RR.SHORT_DESCRIPTION, 
 RO.SHORT_NAME, 
 P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) AS [NAME], 
 COALESCE(RP.RANK_CODE, SPACE(0)) AS RANK, 
 RO.ORGANIZATION_TYPE 
FROM  
 ORGANIZATION_MAP OM INNER JOIN RECRUITING_ORGANIZATION RO ON  
  (OM.PARENT_ORGANIZATION_ID = @Organiza.onID AND 
  OM.CHILD_ORGANIZATION_ID = RO.ORGANIZATION_ID) 
 INNER JOIN RECRUITING_PERSON RP ON  
  (OM.CHILD_ORGANIZATION_ID = RP.ORGANIZATION_ID AND 
  --- TOUR END DATE IS NULL FOR ALL PEOPLE CURRENTLY ASSIGNED TO THE UNIT 
  RP.TOUR_END_DATE IS NULL) 
 INNER JOIN PERSON P ON RP.RECRUITING_PERSON_ID = P.PERSON_ID 
 INNER JOIN RECRUITING_ROLE RR ON RP.RECRUITING_ROLE_ID = RR.RECRUITING_ROLE_ID 
WHERE 
 (@OrgType = 'RS' AND RR.SHORT_DESCRIPTION != 'OSO') OR  
 (@OrgType != 'RS') 
ORDER BY  
 RO.SHORT_NAME, [NAME] 
 
 
SELECT  
 TP.*, 
 ON_PRODUCTION = ISNULL((SELECT TOP 1 PSH.ON_PRODUCTION FROM PRODUCTION_STATUS_HISTORY PSH  
    WHERE PSH.PERSON_ID = RP.RECRUITING_PERSON_ID AND  
    DATEDIFF(MONTH, CONVERT(DATETIME, CONVERT(VARCHAR(2), PSH.MONTH_CODE) + '/1/' +  
     CONVERT(VARCHAR(4), PSH.CALENDAR_YEAR)), @MonthBeginDate) >= 0 
    ORDER BY PSH.CALENDAR_YEAR DESC, PSH.MONTH_CODE DESC),0) 
FROM  
 #TEMP_RECRUITING_PERSON TP LEFT OUTER JOIN RECRUITING_PERSON RP ON TP.RECRUITING_PERSON_ID = RP.RECRUITING_PERSON_ID 
ORDER BY  
 SHORT_NAME 
 
 
--- CLEAN UP 
DROP TABLE #TEMP_RECRUITING_PERSON 
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>