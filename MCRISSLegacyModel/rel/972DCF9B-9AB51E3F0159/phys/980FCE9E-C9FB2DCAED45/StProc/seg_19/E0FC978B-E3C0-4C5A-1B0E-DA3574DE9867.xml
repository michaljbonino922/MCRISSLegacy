<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetPersonbySSN]" directorySegmentName="seg_19" id="E0FC978B-E3C0-4C5A-1B0E-DA3574DE9867">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@SSN char(9) 
AS 
 
SET NOCOUNT ON  
 
DECLARE @PERSON_DATA TABLE 
 (PERSON_ID INT NULL, NWA_ID INT NULL, CONTRACT_ID INT NULL, SHIP_ID INT NULL, CANDIDATE_STATUS_ID INT NULL,  
 LAST_NAME VARCHAR(20) NULL, FIRST_NAME VARCHAR(20) NULL, MIDDLE_NAME VARCHAR(20) NULL,  
 SSN CHAR(9) NULL, RS VARCHAR(45) NULL, RSS VARCHAR(45) NULL, STATUS_DESCRIPTION VARCHAR(40) NULL, 
 DISPOSITION_DESCRIPTION VARCHAR(40) NULL, STATUS_EFFECTIVE_DATE DATETIME NULL, STATUS_TYPE CHAR(1) NULL,  
 DISPOSITION_CODE VARCHAR(20) NULL, MARINE CHAR(1) NULL, STATUS_CODE VARCHAR(10) NULL) 
 
INSERT INTO @PERSON_DATA  
 (PERSON_ID, NWA_ID, CANDIDATE_STATUS_ID,  
 LAST_NAME, FIRST_NAME, MIDDLE_NAME, SSN,  
 RS, RSS, STATUS_DESCRIPTION, DISPOSITION_DESCRIPTION, STATUS_EFFECTIVE_DATE,  
 STATUS_TYPE, DISPOSITION_CODE, STATUS_CODE) 
SELECT  
 P.PERSON_ID,  
 NWA.NWA_ID,  
 CS.CANDIDATE_STATUS_ID,  
 P.LAST_NAME,  
 P.FIRST_NAME,  
 P.LEGAL_MIDDLE_NAME,  
 P.SOCIAL_SECURITY_NUMBER, 
 COALESCE(R2.NAME, R1.SHORT_NAME, SPACE(0)) AS RS,  
 COALESCE(R1.NAME, SPACE(0)) AS RSS, 
 SD.STATUS_DESCRIPTION,  
 SD.DISPOSITION_DESCRIPTION, 
 CS.STATUS_EFFECTIVE_DATE,  
 CS.STATUS_TYPE,  
 CS.DISPOSITION_CODE,  
 CS.STATUS_CODE 
FROM  
 PERSON P INNER JOIN NWA ON  
  (P.PERSON_ID = NWA.MARINE_CANDIDATE_ID AND 
  P.SOCIAL_SECURITY_NUMBER = @SSN) 
 INNER JOIN RECRUITING_ORGANIZATION R1 ON NWA.ORGANIZATION_OF_RECORD_ID = R1.ORGANIZATION_ID  
 INNER JOIN CANDIDATE_STATUS CS ON  
  (NWA.NWA_ID = CS.NWA_ID AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 INNER JOIN STATUS_DISPOSITION SD ON (CS.STATUS_TYPE = SD.STATUS_TYPE AND CS.STATUS_CODE = SD.STATUS_CODE AND 
     CS.DISPOSITION_CODE = SD.DISPOSITION_CODE)   
 LEFT OUTER JOIN ORGANIZATION_MAP OM ON R1.ORGANIZATION_ID = OM.CHILD_ORGANIZATION_ID  
 LEFT OUTER JOIN RECRUITING_ORGANIZATION R2 ON OM.PARENT_ORGANIZATION_ID = R2.ORGANIZATION_ID  
 
--- UPDATE THE CONTRACT_ID, SHIP_ID AND MARINE FLAG 
UPDATE 
 @PERSON_DATA 
SET 
 CONTRACT_ID  = CASE P.STATUS_TYPE 
    WHEN 'E' THEN COALESCE((SELECT C.CONTRACT_ID FROM CONTRACT C WHERE C.NWA_ID = P.NWA_ID), 0) 
    WHEN 'O' THEN COALESCE((SELECT OC.CONTRACT_ID FROM OFFICER_CONTRACT OC WHERE OC.NWA_ID = P.NWA_ID), 0) 
    END, 
 MARINE  = CASE  
    WHEN EXISTS (SELECT 1 FROM MARINE M WHERE M.MARINE_ID = P.PERSON_ID) THEN 'Y' 
    ELSE 'N' 
    END 
FROM 
 @PERSON_DATA P 
 
 
UPDATE 
 @PERSON_DATA 
SET 
 SHIP_ID  = CASE P.STATUS_TYPE 
    WHEN 'E' THEN COALESCE((SELECT S.SHIP_ID FROM SHIPPER S WHERE S.CONTRACT_ID = P.CONTRACT_ID), 0) 
    ELSE 0 
    END 
FROM 
 @PERSON_DATA P 
 
 
--- RETURN THE DATA 
SELECT 
 P.PERSON_ID, P.NWA_ID,  
 COALESCE(P.CONTRACT_ID, 0) AS CONTRACT_ID, 
 COALESCE(RTRIM(P.LAST_NAME) + ', ', SPACE(0)) + COALESCE(RTRIM(P.FIRST_NAME) + SPACE(1), SPACE(0)) +  
  COALESCE(LEFT(P.MIDDLE_NAME, 1), SPACE(0)) AS [NAME], 
 P.SSN, P.RS, P.RSS,  
 P.STATUS_DESCRIPTION, P.DISPOSITION_DESCRIPTION,  
 COALESCE(CONVERT(VARCHAR(11), P.STATUS_EFFECTIVE_DATE, 106), SPACE(0)) AS STATUS_EFFECTIVE_DATE, 
 P.STATUS_TYPE, P.DISPOSITION_CODE, P.STATUS_EFFECTIVE_DATE, P.MARINE, P.STATUS_CODE,  
 COALESCE(P.SHIP_ID, 0) AS SHIP_ID 
FROM 
 @PERSON_DATA P 
ORDER BY 
 P.CANDIDATE_STATUS_ID DESC  
 
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>