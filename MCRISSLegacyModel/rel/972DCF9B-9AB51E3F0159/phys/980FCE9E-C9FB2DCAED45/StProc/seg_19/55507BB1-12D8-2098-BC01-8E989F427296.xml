<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetPersonExt]" directorySegmentName="seg_19" id="55507BB1-12D8-2098-BC01-8E989F427296">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@LastName   varchar(20) = NULL,  
 @FirstName  varchar(20) = NULL,  
 @Last4DigitsOfSSN varchar(4) = NULL,  
 @FullName   varchar(80) = NULL,  
 @PersonID   int = 0,  
 @NWAID   int = 0,  
 @SearchBackwards  bit = 0 
AS 
 
SET NOCOUNT ON  
 
DECLARE @LastNameFilter  varchar(20) 
DECLARE @FirstNameFilter varchar(20) 
DECLARE @MiddleIni.alFilter char(1)  
 
--- CREATE TEMP TABLES TO IMPROVE RETRIEVAL TIME 
CREATE TABLE #PERSON_FILTER (PERSON_ID INT NULL) 
CREATE TABLE #NWA_FILTER (NWA_ID INT NULL) 
 
CREATE TABLE #PERSON (PERSON_ID INT NOT NULL, NWA_ID INT NOT NULL, ORGANIZATION_OF_RECORD_ID INT NULL,  
   SSN CHAR(9) NULL, FIRST_NAME VARCHAR(20) NULL, MIDDLE_NAME VARCHAR(20) NULL, LAST_NAME VARCHAR(20) NULL, SUFFIX VARCHAR(5) NULL, [NAME] VARCHAR(60) NULL,  
   PERSON_ID_SORT_ASC INT NULL, NWA_ID_SORT_ASC INT NULL, FIRST_NAME_SORT_ASC VARCHAR(20) NULL, MIDDLE_NAME_SORT_ASC VARCHAR(20) NULL, LAST_NAME_SORT_ASC VARCHAR(20) NULL, FULL_NAME_SORT_ASC VARCHAR(60) NULL,  
   PERSON_ID_SORT_DESC INT NULL, NWA_ID_SORT_DESC INT NULL, FIRST_NAME_SORT_DESC VARCHAR(20) NULL, MIDDLE_NAME_SORT_DESC VARCHAR(20) NULL, LAST_NAME_SORT_DESC VARCHAR(20) NULL, FULL_NAME_SORT_DESC VARCHAR(60) NULL) 
 
--- POPULATE THE PERSON_FILTER TABLE 
IF @PersonID = 0  
BEGIN 
 --- DEFINE THE FIRST NAME, LAST NAME AND MIDDLE INITIAL FILTERS 
 SELECT 
  @LastNameFilter  = SPACE(0),  
  @FirstNameFilter = SPACE(0),  
  @MiddleIni.alFilter = SPACE(0) 
 
 INSERT INTO #PERSON_FILTER (PERSON_ID) 
 VALUES (0) 
 
 
 INSERT INTO #NWA_FILTER (NWA_ID) 
 VALUES (0) 
END 
ELSE 
BEGIN 
 --- DEFINE THE FIRST NAME, LAST NAME AND MIDDLE INITIAL FILTERS 
 SELECT 
  @LastNameFilter  = P.LAST_NAME,  
  @FirstNameFilter = P.FIRST_NAME,  
  @MiddleIni.alFilter = LTRIM(RTRIM(LEFT(COALESCE(P.LEGAL_MIDDLE_NAME, SPACE(0)), 1))) 
 FROM  
  PERSON P  
 WHERE  
  P.PERSON_ID = @PersonID  
 
 
 --- GET RECORDS WITH SAME FIRST NAME, LAST NAME AND MIDDLE INITIAL 
 INSERT INTO #PERSON_FILTER (PERSON_ID) 
 SELECT  
  P.PERSON_ID  
 FROM  
  PERSON P INNER JOIN NWA N ON P.PERSON_ID = N.MARINE_CANDIDATE_ID  
 WHERE  
  LAST_NAME = @LastNameFilter AND  
  FIRST_NAME = @FirstNameFilter AND  
  COALESCE(LEFT(P.LEGAL_MIDDLE_NAME, 1), SPACE(0)) = @MiddleIni.alFilter AND  
  ((@SearchBackwards = 1 AND P.PERSON_ID > @PersonID) OR  
  (@SearchBackwards = 0 AND P.PERSON_ID < @PersonID)) 
 
 --- GET ADDITIONAL NWA RECORDS FOR THE PERSON ID  
 INSERT INTO #NWA_FILTER (NWA_ID) 
 SELECT  
  N.NWA_ID 
 FROM  
  PERSON P INNER JOIN NWA N ON  
   (P.PERSON_ID = N.MARINE_CANDIDATE_ID AND  
   P.PERSON_ID = @PersonID AND  
   ((@SearchBackwards = 1 AND N.NWA_ID >= @NWAID) OR  
   (@SearchBackwards = 0 AND N.NWA_ID <= @NWAID))) 
END 
  
--- POPULATE TEMP TABLE 
INSERT INTO #PERSON (PERSON_ID, NWA_ID, ORGANIZATION_OF_RECORD_ID, SSN, FIRST_NAME, MIDDLE_NAME, LAST_NAME, SUFFIX, [NAME],  
   PERSON_ID_SORT_ASC, NWA_ID_SORT_ASC, FIRST_NAME_SORT_ASC, MIDDLE_NAME_SORT_ASC, LAST_NAME_SORT_ASC, FULL_NAME_SORT_ASC,   
   PERSON_ID_SORT_DESC, NWA_ID_SORT_DESC, FIRST_NAME_SORT_DESC, MIDDLE_NAME_SORT_DESC, LAST_NAME_SORT_DESC, FULL_NAME_SORT_DESC) 
SELECT TOP 50 
 P.PERSON_ID,  
 N.NWA_ID AS NWA_ID,  
 N.ORGANIZATION_OF_RECORD_ID,  
 P.SOCIAL_SECURITY_NUMBER,  
 P.FIRST_NAME,  
 P.LEGAL_MIDDLE_NAME,  
 P.LAST_NAME,  
 P.SUFFIX_CD,  
 dbo.GetFullName(P.LAST_NAME, P.FIRST_NAME, P.LEGAL_MIDDLE_NAME, 1) AS [NAME],  
 CASE @SearchBackwards 
  WHEN 0 THEN P.PERSON_ID 
  ELSE NULL 
 END AS PERSON_ID_SORT_ASC, 
 CASE @SearchBackwards 
  WHEN 0 THEN N.NWA_ID 
  ELSE NULL 
 END AS NWA_ID_SORT_ASC,  
 CASE @SearchBackwards 
  WHEN 0 THEN P.FIRST_NAME 
  ELSE NULL 
 END AS FIRST_NAME_SORT_ASC,  
 CASE @SearchBackwards 
  WHEN 0 THEN P.LEGAL_MIDDLE_NAME 
  ELSE NULL 
 END AS MIDDLE_NAME_SORT_ASC,  
 CASE @SearchBackwards 
  WHEN 0 THEN P.LAST_NAME 
  ELSE NULL 
 END AS LAST_NAME_SORT_ASC,   
 CASE @SearchBackwards 
  WHEN 0 THEN dbo.GetFullName(P.LAST_NAME, P.FIRST_NAME, P.LEGAL_MIDDLE_NAME, 1) 
  ELSE NULL 
 END AS NAME_SORT_ASC,  
 CASE @SearchBackwards 
  WHEN 1 THEN P.PERSON_ID 
  ELSE NULL 
 END AS PERSON_ID_SORT_DESC, 
 CASE @SearchBackwards 
  WHEN 1 THEN N.NWA_ID 
  ELSE NULL 
 END AS NWA_ID_SORT_DESC, 
 CASE @SearchBackwards 
  WHEN 1 THEN P.FIRST_NAME 
  ELSE NULL 
 END AS FIRST_NAME_SORT_DESC,  
 CASE @SearchBackwards 
  WHEN 1 THEN P.LEGAL_MIDDLE_NAME 
  ELSE NULL 
 END AS MIDDLE_NAME_SORT_DESC,  
 CASE @SearchBackwards 
  WHEN 1 THEN P.LAST_NAME 
  ELSE NULL 
 END AS LAST_NAME_SORT_DESC,  
 CASE @SearchBackwards 
  WHEN 1 THEN dbo.GetFullName(P.LAST_NAME, P.FIRST_NAME, P.LEGAL_MIDDLE_NAME, 1) 
  ELSE NULL 
 END AS NAME_SORT_DESC 
FROM  
 PERSON P INNER JOIN NWA N ON  
  (P.PERSON_ID = N.MARINE_CANDIDATE_ID AND  
  N.ORGANIZATION_OF_RECORD_ID IS NOT NULL AND 
  ---((N.MARINE_CANDIDATE_ID = @PersonID AND N.NWA_ID != @NWAID) OR N.MARINE_CANDIDATE_ID != @PersonID) AND 
  ---N.NWA_ID != @NWAID AND 
  NOT EXISTS (SELECT 1 FROM #PERSON_FILTER PF WHERE PF.PERSON_ID = P.PERSON_ID) AND  
  NOT EXISTS (SELECT 1 FROM #NWA_FILTER NF WHERE NF.NWA_ID = N.NWA_ID) AND  
  P.LAST_NAME = COALESCE(@LastName, P.LAST_NAME) AND  
  P.FIRST_NAME = COALESCE(@FirstName, P.FIRST_NAME) AND  
  RIGHT(P.SOCIAL_SECURITY_NUMBER, 4) = COALESCE(@Last4DigitsOfSSN, RIGHT(P.SOCIAL_SECURITY_NUMBER, 4)) AND  
  CASE @SearchBackwards 
   WHEN 1 THEN @FullName + CONVERT(VARCHAR, N.NWA_ID) 
   ELSE dbo.GetFullName(P.LAST_NAME, P.FIRST_NAME, P.LEGAL_MIDDLE_NAME, 1) + CONVERT(VARCHAR, N.NWA_ID) 
  END >=  CASE @SearchBackwards 
   WHEN 1 THEN dbo.GetFullName(P.LAST_NAME, P.FIRST_NAME, P.LEGAL_MIDDLE_NAME, 1) + CONVERT(VARCHAR, N.NWA_ID) 
   ELSE @FullName + CONVERT(VARCHAR, N.NWA_ID) 
  END) 
ORDER BY  
 NAME_SORT_ASC ASC,  
 PERSON_ID_SORT_ASC ASC, 
 NWA_ID_SORT_ASC ASC, 
 NAME_SORT_DESC DESC,   
 PERSON_ID_SORT_DESC DESC, 
 NWA_ID_SORT_DESC DESC 
 
--- USE TEMP TABLE TO GET RESULT SET 
SELECT  
 P.PERSON_ID, P.NWA_ID,   
 CASE CS.STATUS_TYPE 
  WHEN 'E' THEN (SELECT C.CONTRACT_ID FROM CONTRACT C WHERE C.NWA_ID = P.NWA_ID) 
  WHEN 'O' THEN (SELECT OC.CONTRACT_ID FROM OFFICER_CONTRACT OC WHERE OC.NWA_ID = P.NWA_ID) 
 END AS CONTRACT_ID, 
 --- COALESCE(RTRIM(LTRIM(P.LAST_NAME)) + ', ', SPACE(0)) + COALESCE(RTRIM(LTRIM(P.FIRST_NAME)) + SPACE(1), SPACE(0)) + COALESCE(LEFT(P.MIDDLE_NAME, 1), SPACE(0)) AS NAME, 
 P.[NAME],  
 CONVERT(CHAR(9), P.SSN) AS SOCIAL_SECURITY_NUMBER,  
 COALESCE(RS.NAME, RSS.SHORT_NAME, SPACE(0)) AS RS,  
 RSS.NAME AS RSS,  
 SD.STATUS_DESCRIPTION, SD.DISPOSITION_DESCRIPTION, 
 CONVERT(VARCHAR(11), CS.STATUS_EFFECTIVE_DATE, 106) AS STATUS_EFFECTIVE_DATE, 
 CS.STATUS_TYPE, CS.DISPOSITION_CODE, CS.STATUS_EFFECTIVE_DATE, 
 --- CHECK TO SEE IF THERE IS A MARINE RECORD FOR THIS PERSON 
 CASE  
  WHEN EXISTS (SELECT 1 FROM MARINE M WHERE M.MARINE_ID = P.PERSON_ID) THEN 'Y' 
  ELSE 'N' 
 END AS MARINE, 
 CS.STATUS_CODE 
FROM  
 #PERSON P INNER JOIN RECRUITING_ORGANIZATION RSS ON P.ORGANIZATION_OF_RECORD_ID = RSS.ORGANIZATION_ID  
 INNER JOIN CANDIDATE_STATUS CS ON  
  (P.NWA_ID = CS.NWA_ID AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 INNER JOIN STATUS_DISPOSITION SD ON  
  (CS.STATUS_TYPE = SD.STATUS_TYPE AND  
  CS.STATUS_CODE = SD.STATUS_CODE AND 
  CS.DISPOSITION_CODE = SD.DISPOSITION_CODE) 
 LEFT OUTER JOIN ORGANIZATION_MAP OM ON RSS.ORGANIZATION_ID = OM.CHILD_ORGANIZATION_ID  
 LEFT OUTER JOIN RECRUITING_ORGANIZATION RS ON OM.PARENT_ORGANIZATION_ID = RS.ORGANIZATION_ID  
ORDER BY 
 P.[NAME] ASC, 
 P.PERSON_ID ASC, 
 P.NWA_ID ASC,  
 CS.STATUS_EFFECTIVE_DATE DESC, 
 CS.CANDIDATE_STATUS_ID DESC 
 
--- CLEAN UP 
DROP TABLE #PERSON  
DROP TABLE #PERSON_FILTER 
DROP TABLE #NWA_FILTER  
SET NOCOUNT OFF]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>