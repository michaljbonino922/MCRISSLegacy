<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_OCSClassExport]" directorySegmentName="seg_22" id="7A50A482-4251-E8A4-EC61-CC32DE7DC8FE">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:42 UTC</createdTime>
<ownerDesignName>MCRISSLegacyModel</ownerDesignName>
<body><![CDATA[@Class   varchar(8), 
 @FY   int, 
 @ClassNumber int, 
 @Class2  varchar(8) = NULL, 
 @FY2  int = NULL, 
 @ClassNumber2 int = NULL 
AS 
 
SET NOCOUNT ON 
SET ANSI_WARNINGS OFF 
 
--- CREATE THE TABLE 
CREATE TABLE #OCS_CLASS_EXPORT  
 (PERSON_ID INT, NWA_ID INT, CONTRACT_ID INT, OCS_ID INT, COMMISSIONEE_ID INT NULL,  
 MAX_STATUS_ID INT, OCS_CLASS_ID INT,  OSS_ID INT,  
 ENLISTED_CONTRACT_DATE DATETIME NULL,  
 TRANSACTION_RUC CHAR(5) NOT NULL DEFAULT SPACE(0), PRESENT_RUC CHAR(5) NOT NULL DEFAULT SPACE(0),  
 PRESENT_MCC CHAR(3) NOT NULL DEFAULT SPACE(0), UNIT_DIARY_NUMBER CHAR(5) NOT NULL DEFAULT SPACE(0), 
 JURISDICTION_CODE CHAR(2) NOT NULL DEFAULT SPACE(0), SOURCE_INPOUR_CODE CHAR(3) NOT NULL DEFAULT SPACE(0), 
 APPLICATION_SYSTEMS_SOURCE_CODE CHAR(1) NOT NULL DEFAULT SPACE(0), DIARY_TYPE_CODE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 HISTORY_ACTION_CODE CHAR(1) NOT NULL DEFAULT SPACE(0), PROGRAM_ELEMENT_NUMBER CHAR(8) NOT NULL DEFAULT SPACE(0),  
 RESPONSIBILITY_CENTER_NUMBER CHAR(6) NOT NULL DEFAULT SPACE(0), PRESENT_SAT_DP_INSTALLATION CHAR(2) NOT NULL DEFAULT SPACE(0),  
 INDIVIDUAL_LOCATION_COUNTY_CODE CHAR(3) NOT NULL DEFAULT SPACE(0), INDIVIDUAL_LOCATION_CODE CHAR(2) NOT NULL DEFAULT SPACE(0),  
 EFFECTIVE_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 ARMED_FORCES_ORIG_ENTRY_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 ARMED_FORCES_ACT_DU_BASE_DATE CHAR(8) NOT NULL DEFAULT SPACE(0), CURRENT_ACTIVE_DUTY_BEGAN_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 CURRENT_TOUR_BEGIN_DATE CHAR(8) NOT NULL DEFAULT SPACE(0), PAY_ENTRY_BASE_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 PRESENT_RANK_DATE CHAR(8) NOT NULL DEFAULT SPACE(0), PRESENT_GRADE_EFFECTIVE_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 PRESENT_GRADE_CODE CHAR(3) NOT NULL DEFAULT SPACE(0), PRIMARY_MOS_CODE CHAR(4) NOT NULL DEFAULT SPACE(0),  
 DISTRICT_CODE CHAR(2) NOT NULL DEFAULT SPACE(0),  
 OSS_MCC_CODE CHAR(5) NOT NULL DEFAULT SPACE(0),  
 CONTRACT_BEGIN_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 OFFICER_PROGRAM CHAR(2) NOT NULL DEFAULT SPACE(0), COMPONENT_CODE CHAR(2) NOT NULL DEFAULT SPACE(0), CURRENT_SOURCE_OF_ENTRY CHAR(4) NOT NULL DEFAULT SPACE(0),  
 SSN_01 CHAR(1) NOT NULL DEFAULT SPACE(0), SSN_02_10 CHAR(9) NOT NULL DEFAULT SPACE(0),  
 LAST_NAME CHAR(26) NOT NULL DEFAULT SPACE(0), FIRST_NAME CHAR(20) NOT NULL DEFAULT SPACE(0), MIDDLE_NAME CHAR(20) NOT NULL DEFAULT SPACE(0),  
 CADENCY_NAME_TEXT CHAR(4) NOT NULL DEFAULT SPACE(0), LAST_INITIAL CHAR(1) NOT NULL DEFAULT SPACE(0), FIRST_INITIAL CHAR(1) NOT NULL DEFAULT SPACE(0),  
 MIDDLE_INITIAL CHAR(1) NOT NULL DEFAULT SPACE(0), MID_INITIALS CHAR(2) NOT NULL DEFAULT SPACE(0), SEX CHAR(1) NOT NULL DEFAULT SPACE(0),  
 RELIGION CHAR(2) NOT NULL DEFAULT SPACE(0), DATE_OF_BIRTH CHAR(8) NOT NULL DEFAULT SPACE(0), RACE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 ETHNIC CHAR(1) NOT NULL DEFAULT SPACE(0), CITIZENSHIP CHAR(2) NOT NULL DEFAULT SPACE(0),  
 COUNTRY_OF_ORIGIN CHAR(2) NOT NULL DEFAULT SPACE(0), MARITAL_STATUS CHAR(1) NOT NULL DEFAULT SPACE(0),  
 CURRENT_STREET_ADDRESS CHAR(40) NOT NULL DEFAULT SPACE(0), CURRENT_CITY_CODE CHAR(4) NOT NULL DEFAULT SPACE(0),  
 CURRENT_CITY_TEXT CHAR(30) NOT NULL DEFAULT SPACE(0), CURRENT_COUNTY_CODE CHAR(3) NOT NULL DEFAULT SPACE(0),  
 CURRENT_STATE_CODE CHAR(2) NOT NULL DEFAULT SPACE(0), CURRENT_ZIP_CODE CHAR(9) NOT NULL DEFAULT SPACE(0),  
 HOR_TELEPHONE_NUMBER CHAR(10) NOT NULL DEFAULT SPACE(0), HOR_CITY_CODE CHAR(4) NOT NULL DEFAULT SPACE(0),  
 HOR_COUNTY CHAR(3) NOT NULL DEFAULT SPACE(0), HOR_STATE_CODE CHAR(2) NOT NULL DEFAULT SPACE(0),  
 HOR_ZIP_CODE CHAR(9) NOT NULL DEFAULT SPACE(0),  
 EDUCATION_CERTIFICATION CHAR(1) NOT NULL DEFAULT SPACE(0), EDUCATION_LEVEL CHAR(2) NOT NULL DEFAULT SPACE(0),  
 MEPS_MCC CHAR(3) NOT NULL DEFAULT SPACE(0),  
 ASVAB_VERSION CHAR(3) NOT NULL DEFAULT SPACE(0), ASVAB_DATE CHAR(8) NOT NULL DEFAULT SPACE(0),  
 GT_SCORE CHAR(3) NOT NULL DEFAULT SPACE(0), EL_SCORE CHAR(3) NOT NULL DEFAULT SPACE(0),  
 MM_SCORE CHAR(3) NOT NULL DEFAULT SPACE(0), AFQT_SCORE CHAR(2) NOT NULL DEFAULT SPACE(0),  
 DLAB_DATE CHAR(8) NOT NULL DEFAULT SPACE(0), DLAB_SCORE CHAR(3) NOT NULL DEFAULT SPACE(0),  
 ARC_DATE CHAR(8) NOT NULL DEFAULT SPACE(0), ARC_SCORE CHAR(3) NOT NULL DEFAULT SPACE(0),  
 MEPS_MEDICAL_EXAM_DATE DATETIME NULL,  
 MEPS_MEDICAL_HEIGHT CHAR(2) NOT NULL DEFAULT SPACE(0), MEPS_MEDICAL_WEIGHT CHAR(3) NOT NULL DEFAULT SPACE(0),  
 MEPS_MEDICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0), MEPS_MEDICAL_LEFT_UNCORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0),  
 MEPS_MEDICAL_RIGHT_CORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0), MEPS_MEDICAL_LEFT_CORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0),  
 MEPS_MEDICAL_VISUAL_COLOR_CODE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 FLIGHT_PHYSICAL_DATE DATETIME NULL,  
 FLIGHT_PHYSICAL_HEIGHT CHAR(2) NOT NULL DEFAULT SPACE(0), FLIGHT_PHYSICAL_WEIGHT CHAR(3) NOT NULL DEFAULT SPACE(0),  
 FLIGHT_PHYSICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0), FLIGHT_PHYSICAL_LEFT_UNCORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0),  
 FLIGHT_PHYSICAL_RIGHT_CORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0), FLIGHT_PHYSICAL_LEFT_CORRECTED_VISUAL_ACUITY CHAR(3) NOT NULL DEFAULT SPACE(0),  
 FLIGHT_PHYSICAL_VISUAL_COLOR_CODE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 MAX_MEDICAL_EXAM_TYPE CHAR(1) NULL,  
 RACE_AGGREGATE CHAR(1) NOT NULL DEFAULT SPACE(0), FILLER CHAR(99) NOT NULL DEFAULT SPACE(0))  
 
--- CREATE TABLE OF CLASSES 
CREATE TABLE #OCS_CLASS_INFO 
 (CLASS_TYPE CHAR(8), FY INT, CLASS_NUMBER INT) 
 
--- POPULATE CLASSES TABLE 
INSERT INTO #OCS_CLASS_INFO 
 (CLASS_TYPE, FY, CLASS_NUMBER) 
VALUES (@Class, @FY, @ClassNumber) 
 
---  
--- 
IF LEN(COALESCE(@Class2,'')) > 0 AND COALESCE(@FY2,0) != 0 AND COALESCE(@ClassNumber2, 0) != 0 
BEGIN 
 INSERT INTO #OCS_CLASS_INFO 
  (CLASS_TYPE, FY, CLASS_NUMBER) 
 VALUES (@Class2, @FY2, @ClassNumber2) 
END 
 
--- POPULATE TABLE 
INSERT INTO #OCS_CLASS_EXPORT  
 (PERSON_ID, NWA_ID, CONTRACT_ID, OCS_ID,  
 COMMISSIONEE_ID, MAX_STATUS_ID, OCS_CLASS_ID, OSS_ID,  
 EFFECTIVE_DATE,  
 --- ARMED_FORCES_ORIG_ENTRY_DATE,  
 ARMED_FORCES_ACT_DU_BASE_DATE, CURRENT_ACTIVE_DUTY_BEGAN_DATE,  
 CURRENT_TOUR_BEGIN_DATE, PAY_ENTRY_BASE_DATE,  
 PRESENT_RANK_DATE, PRESENT_GRADE_EFFECTIVE_DATE,  
 CONTRACT_BEGIN_DATE, OFFICER_PROGRAM,  
 SSN_01, SSN_02_10,  
 LAST_NAME, FIRST_NAME, MIDDLE_NAME, CADENCY_NAME_TEXT,  
 SEX,  
 RELIGION, DATE_OF_BIRTH, RACE,  
 ETHNIC, CITIZENSHIP,  
 COUNTRY_OF_ORIGIN, MARITAL_STATUS,  
 RACE_AGGREGATE)  
SELECT 
 P.PERSON_ID, N.NWA_ID, C.CONTRACT_ID, O.OCS_ID,  
 C1.COMMISSIONEE_ID, CS.CANDIDATE_STATUS_ID, O.OCS_CLASS_ID,  
 N.ORGANIZATION_OF_RECORD_ID AS OSS_ID,  
 COALESCE(CONVERT(CHAR(8), O.PEBD, 112), SPACE(0)) AS EFFECTIVE_DATE,  
 COALESCE(CONVERT(CHAR(8), CL.CLASS_BEGIN_DATE, 112), SPACE(0)) AS ARMED_FORCES_ACT_DU_BASE_DATE,  
 COALESCE(CONVERT(CHAR(8), CL.CLASS_BEGIN_DATE, 112), SPACE(0)) AS CURRENT_ACTIVE_DUTY_BEGAN_DATE,  
 COALESCE(CONVERT(CHAR(8), O.PEBD, 112), SPACE(0)) AS CURRENT_TOUR_BEGIN_DATE,  
 COALESCE(CONVERT(CHAR(8), O.PEBD, 112), SPACE(0)) AS PAY_ENTRY_BASE_DATE,   
 COALESCE(CONVERT(CHAR(8), CL.CLASS_BEGIN_DATE, 112), SPACE(0)) AS PRESENT_RANK_DATE,  
 COALESCE(CONVERT(CHAR(8), CL.CLASS_BEGIN_DATE, 112), SPACE(0)) AS PRESENT_GRADE_EFFECTIVE_DATE,  
 COALESCE(CONVERT(CHAR(8), C.CONTRACT_BEGIN_DATE, 112), SPACE(0)) AS CONTRACT_BEGIN_DATE,  
 COALESCE(O.COMPONENT_CODE, C.COMPONENT_CODE, N.OFFICER_COMPONENT_CODE, SPACE(0)) AS OFFICER_PROGRAM,  
 '0' AS SSN_01, P.SOCIAL_SECURITY_NUMBER AS SSN_02_10, P.LAST_NAME, P.FIRST_NAME,  
 COALESCE(P.LEGAL_MIDDLE_NAME, SPACE(0)) AS MIDDLE_NAME,   
 COALESCE(P.SUFFIX_CD, SPACE(0)) AS CADENCY_NAME_TEXT, 
 COALESCE(MC.GENDER_CODE, SPACE(0)) AS SEX,  
 COALESCE(MC.RELIGION_CODE, SPACE(0)) AS RELIGION,  
 COALESCE(CONVERT(CHAR(8), MC.DATE_OF_BIRTH, 112), SPACE(0)),  
 COALESCE(MC.RACE_CODE, SPACE(0)) AS RACE,  
 COALESCE(MC.ETHNIC_CODE, SPACE(0)) AS ETHNIC,  
 COALESCE(MC.CITIZENSHIP, SPACE(0)) AS CITIZENSHIP, 
 COALESCE(MC.COUNTRY_OF_ORIGIN, SPACE(0)) AS COUNTRY_OF_ORIGIN, 
 COALESCE(MC.MARITAL_STATUS_CODE, SPACE(0)) AS MARITAL_STATUS,  
 COALESCE(MC.MEPCOM_RACE_CODE, SPACE(0)) AS RACE_AGGREGATE 
FROM 
 PERSON P  
 INNER JOIN NWA N ON P.PERSON_ID = N.MARINE_CANDIDATE_ID 
 INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN OFFICER_CONTRACT C ON N.NWA_ID = C.NWA_ID 
 INNER JOIN OCS O ON  
  (N.NWA_ID = O.NWA_ID AND 
  O.OCS_ID = dbo.GetMaxOCSID(O.NWA_ID, 'Y')) 
 INNER JOIN OCS_CLASS CL ON O.OCS_CLASS_ID = CL.CLASS_ID  
 INNER JOIN #OCS_CLASS_INFO OCI ON  
  (CL.TRAINING_TYPE_CODE = OCI.CLASS_TYPE AND 
  CL.CLASS_NUMBER = OCI.CLASS_NUMBER AND 
  CL.FISCAL_YEAR = OCI.FY) 
 INNER JOIN CANDIDATE_STATUS CS ON  
  (N.NWA_ID = CS.NWA_ID AND 
  CS.DISPOSITION_code IN ('AP','R','W','X','BC','AP','AQ','AR')  AND 
  CS.STATUS_TYPE = 'O' AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 LEFT OUTER JOIN COMMISSIONEE C1 ON C.CONTRACT_ID = C1.CONTRACT_ID 
 
 
--- ENLISTED CONTRACT BEGIN DATE (IF THERE IS ONE) 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 ENLISTED_CONTRACT_DATE = C.CONTRACT_BEGIN_DATE 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN PERSON P ON OE.PERSON_ID = P.PERSON_ID 
 INNER JOIN NWA N ON P.PERSON_ID = N.MARINE_CANDIDATE_ID  
 INNER JOIN CONTRACT C ON N.NWA_ID = C.NWA_ID 
 
 
--- ARMED_FORCES_ORIG_ENTRY_DATE - GET THE EARLIEST OF THE APPLICANT'S OFFICER CONTRACT BEGIN DATE AND  
--- ENLISTED CONTRACT BEGIN DATE (IF THERE IS ONE) 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 ARMED_FORCES_ORIG_ENTRY_DATE = COALESCE(CONVERT(CHAR(8), 
     (SELECT MIN(CONTRACT_BEGIN_DATE) FROM 
     (SELECT CONVERT(DATETIME, CONTRACT_BEGIN_DATE) AS CONTRACT_BEGIN_DATE FROM #OCS_CLASS_EXPORT OE1 
     WHERE OE1.CONTRACT_ID = OE.CONTRACT_ID 
     UNION 
     SELECT CONVERT(DATETIME, ENLISTED_CONTRACT_DATE) FROM #OCS_CLASS_EXPORT OE2 
     WHERE OE2.CONTRACT_ID = OE.CONTRACT_ID) C), 112), SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE  
 
 
--- CURRENT ADDRESS DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 CURRENT_CITY_CODE = COALESCE(CUR.CITY_CODE, SPACE(0)), 
 CURRENT_CITY_TEXT  = COALESCE(GL.CITY_TEXT, SPACE(0)), 
 CURRENT_COUNTY_CODE = COALESCE(CUR.COUNTY_CODE, SPACE(0)), 
 CURRENT_STATE_CODE = COALESCE(CUR.STATE_CODE, SPACE(0)), 
 CURRENT_ZIP_CODE  = COALESCE(CUR.ZIPCODE, SPACE(0)), 
 CURRENT_STREET_ADDRESS = COALESCE(CUR.STREET_ADDRESS, SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_ADDRESS CUR ON  
  (OE.PERSON_ID = CUR.MARINE_CANDIDATE_ID AND 
  CUR.ADDRESS_TYPE = 'C') 
 LEFT OUTER JOIN GEO_LOCATION GL ON 
  (CUR.STATE_CODE = GL.STATE_CODE AND 
  CUR.COUNTY_CODE = GL.COUNTY_CODE AND 
  CUR.CITY_CODE = GL.CITY_CODE) 
 
 
--- HOR ADDRESS DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 HOR_CITY_CODE   = COALESCE(HOR.CITY_CODE, SPACE(0)), 
 HOR_COUNTY   = COALESCE(HOR.COUNTY_CODE, SPACE(0)), 
 HOR_STATE_CODE   = COALESCE(HOR.STATE_CODE, SPACE(0)), 
 HOR_ZIP_CODE  = COALESCE(HOR.ZIPCODE, SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_ADDRESS HOR ON  
  (OE.PERSON_ID = HOR.MARINE_CANDIDATE_ID AND 
  HOR.ADDRESS_TYPE = 'H') 
 
 
--- HOME TELEPHONE DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 HOR_TELEPHONE_NUMBER = LEFT(COALESCE(CT.AREA_CODE, SPACE(0)) + COALESCE(REPLACE(CT.TELEPHONE_NUMBER, '-', SPACE(0)), SPACE(0)), 10) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_TELEPHONE CT ON  
  (OE.PERSON_ID = CT.MARINE_CANDIDATE_ID AND 
  CT.TELEPHONE_TYPE = 'H') 
 
 
-- ARC DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 ARC_SCORE = COALESCE(REPLICATE('0', 3 - LEN(ARC.SPECIAL_EXAM_SCORE)) +  
     CONVERT(CHAR(3), ARC.SPECIAL_EXAM_SCORE), SPACE(0)), 
 ARC_DATE  = COALESCE(CONVERT(CHAR(8), ARC.SPECIAL_EXAM_DATE, 112), SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_SPECIAL_EXAM ARC ON  
  (OE.PERSON_ID = ARC.MARINE_CANDIDATE_ID AND 
  ARC.SPECIAL_EXAM_TYPE = 'ARC' AND 
  ARC.SPECIAL_EXAM_DATE = (SELECT MAX(ARC1.SPECIAL_EXAM_DATE) FROM CANDIDATE_SPECIAL_EXAM ARC1 
      WHERE ARC1.MARINE_CANDIDATE_ID = ARC.MARINE_CANDIDATE_ID AND 
      ARC1.SPECIAL_EXAM_TYPE = ARC.SPECIAL_EXAM_TYPE)) 
 
--- DLAB DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 DLAB_SCORE = COALESCE(REPLICATE('0', 3 - LEN(DLAB.SPECIAL_EXAM_SCORE)) +  
     CONVERT(CHAR(3), DLAB.SPECIAL_EXAM_SCORE), SPACE(0)), 
 DLAB_DATE  = COALESCE(CONVERT(CHAR(8), DLAB.SPECIAL_EXAM_DATE, 112), SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_SPECIAL_EXAM DLAB ON  
  (OE.PERSON_ID = DLAB.MARINE_CANDIDATE_ID AND 
  DLAB.SPECIAL_EXAM_TYPE = 'DLAB' AND 
  DLAB.SPECIAL_EXAM_DATE = (SELECT MAX(DLAB1.SPECIAL_EXAM_DATE) FROM CANDIDATE_SPECIAL_EXAM DLAB1 
      WHERE DLAB1.MARINE_CANDIDATE_ID = DLAB.MARINE_CANDIDATE_ID AND 
      DLAB1.SPECIAL_EXAM_TYPE = DLAB.SPECIAL_EXAM_TYPE)) 
 
 
 
--- EDUCATION DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 EDUCATION_LEVEL  = CASE  
     --- FOR EDUCATION LEVEL BETWEEN 2 AND 6 ADD 10, FOR EDUCATION LEVEL = 7 ADD 5 
     WHEN ISNUMERIC(CE.EDUCATION_LEVEL) = 1 AND CONVERT(INT, CE.EDUCATION_LEVEL) BETWEEN 2 AND 7  
      THEN CONVERT(VARCHAR, CONVERT(INT, CE.EDUCATION_LEVEL) + CASE CONVERT(INT, CE.EDUCATION_LEVEL) WHEN 7 THEN 5 ELSE 10 END) 
     --- FOR EDUCATION LEVEL BETWEEN 10 AND 19, USE EDUCATION LEVEL 
     WHEN ISNUMERIC(CE.EDUCATION_LEVEL) = 1 AND CONVERT(INT, CE.EDUCATION_LEVEL) BETWEEN 10 AND 19 THEN CE.EDUCATION_LEVEL 
     WHEN CE.EDUCATION_LEVEL = 'K' THEN '16' 
     WHEN CE.EDUCATION_LEVEL = 'N' THEN '17' 
     WHEN CE.EDUCATION_LEVEL = 'W' THEN '18' 
     ELSE SPACE(0) 
     END,  
 EDUCATION_CERTIFICATION = CASE  
     WHEN ISNUMERIC(CE.EDUCATION_LEVEL) = 1 AND (CONVERT(INT, CE.EDUCATION_LEVEL) BETWEEN 2 AND 6 OR CONVERT(INT, CE.EDUCATION_LEVEL) BETWEEN 12 AND 16) THEN 'L' 
     WHEN CE.EDUCATION_LEVEL IN  ('7', 'K', 'N', 'W') THEN COALESCE(CE.EDUCATION_CODE, SPACE(0)) 
     ELSE SPACE(0) 
     END 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_EDUCATION CE ON  
  (OE.PERSON_ID = CE.MARINE_CANDIDATE_ID AND 
  CE.SCHOOL_END_DATE = dbo.GetMaxSchoolEndDate(CE.MARINE_CANDIDATE_ID)) 
 
 
--- ASVAB DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 AFQT_SCORE  = COALESCE(CONVERT(CHAR(2), REPLICATE('0', 2 - LEN(CA.AFQT_SCORE)) +  
    CONVERT(CHAR(2), CA.AFQT_SCORE)), '00'), 
 GT_SCORE  = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3 - LEN(CA.GT_SCORE)) +  
    CONVERT(CHAR(3), CA.GT_SCORE)), '000'), 
 MM_SCORE  = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3 - LEN(CA.MM_SCORE)) +  
    CONVERT(CHAR(3), CA.MM_SCORE)), '000'), 
 EL_SCORE  = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3 - LEN(CA.EL_SCORE)) +  
    CONVERT(CHAR(3), CA.EL_SCORE)), '000'), 
 ASVAB_VERSION  = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3 - LEN(CA.VERSION)) +  
    CONVERT(CHAR(3), CA.VERSION)), '000'), 
 ASVAB_DATE  = COALESCE(CONVERT(CHAR(8), CA.ASVAB_DATE, 112), SPACE(0)), 
 MEPS_MCC  = COALESCE(M.MCC_CODE, SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_ASVAB CA ON  
  (OE.PERSON_ID = CA.MARINE_CANDIDATE_ID AND 
  CA.ASVAB_DATE = dbo.GetMaxASVABDate(CA.MARINE_CANDIDATE_ID)) 
 INNER JOIN MEPS_ORGANIZATION_LOOKUP M ON CA.MEPS_ORGANIZATION_ID = M.MEPS_ORGANIZATION_ID 
 
--- ARC DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 ARC_SCORE = COALESCE(REPLICATE('0', 3 - LEN(ARC.SPECIAL_EXAM_SCORE)) +  
     CONVERT(CHAR(3), ARC.SPECIAL_EXAM_SCORE), SPACE(0)), 
 ARC_DATE  = COALESCE(CONVERT(CHAR(8), ARC.SPECIAL_EXAM_DATE, 112), SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_SPECIAL_EXAM ARC ON  
  (OE.PERSON_ID = ARC.MARINE_CANDIDATE_ID AND 
  ARC.SPECIAL_EXAM_TYPE = 'ARC' AND 
  ARC.SPECIAL_EXAM_DATE = (SELECT MAX(ARC1.SPECIAL_EXAM_DATE) FROM CANDIDATE_SPECIAL_EXAM ARC1 
      WHERE ARC1.MARINE_CANDIDATE_ID = ARC.MARINE_CANDIDATE_ID AND 
      ARC1.SPECIAL_EXAM_TYPE = ARC.SPECIAL_EXAM_TYPE)) 
 
--- DLAB DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 DLAB_SCORE = COALESCE(REPLICATE('0', 3 - LEN(DLAB.SPECIAL_EXAM_SCORE)) +  
     CONVERT(CHAR(3), DLAB.SPECIAL_EXAM_SCORE), SPACE(0)), 
 DLAB_DATE  = COALESCE(CONVERT(CHAR(8), DLAB.SPECIAL_EXAM_DATE, 112), SPACE(0)) 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_SPECIAL_EXAM DLAB ON  
  (OE.PERSON_ID = DLAB.MARINE_CANDIDATE_ID AND 
  DLAB.SPECIAL_EXAM_TYPE = 'DLAB' AND 
  DLAB.SPECIAL_EXAM_DATE = (SELECT MAX(DLAB1.SPECIAL_EXAM_DATE) FROM CANDIDATE_SPECIAL_EXAM DLAB1 
      WHERE DLAB1.MARINE_CANDIDATE_ID = DLAB.MARINE_CANDIDATE_ID AND 
      DLAB1.SPECIAL_EXAM_TYPE = DLAB.SPECIAL_EXAM_TYPE)) 
 
 
--- OSS MCC CODE  
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 OSS_MCC_CODE = OSS.MCC_CODE 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN RECRUITING_ORGANIZATION OSS ON OE.OSS_ID = OSS.ORGANIZATION_ID 
 
--- DISTRICT CODE 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 DISTRICT_CODE = CASE DIST.SHORT_NAME 
    WHEN '1MCD' THEN  '01'                
    WHEN '4MCD' THEN  '04'                
    WHEN '6MCD' THEN  '06'                
    WHEN '8MCD' THEN  '08'                
    WHEN '9MCD' THEN  '09'                
    WHEN '12MCD' THEN  '12'                
    ELSE SPACE(0) 
    END  
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN ORGANIZATION_MAP OSS ON OE.OSS_ID = OSS.CHILD_ORGANIZATION_ID 
 INNER JOIN ORGANIZATION_MAP RS ON OSS.PARENT_ORGANIZATION_ID = RS.CHILD_ORGANIZATION_ID 
 INNER JOIN RECRUITING_ORGANIZATION DIST ON RS.PARENT_ORGANIZATION_ID = DIST.ORGANIZATION_ID 
 
 
--- COMPONENT CODE, SOURCE OF ENTRY 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 COMPONENT_CODE = CASE 
    WHEN OFFICER_PROGRAM IN ('1A', '1B', '1C', '1D', '1H', '1L', '4D') THEN 'C9' 
    WHEN OFFICER_PROGRAM IN ('0A', '0B', '0C', '0E') THEN 'KP' 
    WHEN OFFICER_PROGRAM IN ('26', '11', '2E', 'C1') THEN '20' 
    ELSE SPACE(0) 
    END,  
 CURRENT_SOURCE_OF_ENTRY = CASE  
     WHEN OFFICER_PROGRAM IN ('0A', '0C', '0C', '0E', '0G', '0L', '1A', '1B', '1C', '1D', '1H', '1L', '4D', 'AD') THEN 'HAAA' 
     WHEN OFFICER_PROGRAM IN ('21', '24', '26', '2D', '2E') THEN SPACE(2) + '7G' 
     ELSE SPACE(0) 
     END 
 
 
--- INITIALS 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 LAST_INITIAL = COALESCE(LEFT(LAST_NAME, 1), SPACE(0)),   
 FIRST_INITIAL = COALESCE(LEFT(FIRST_NAME, 1), SPACE(0)),   
 MIDDLE_INITIAL = COALESCE(LEFT(MIDDLE_NAME, 1), SPACE(0)),   
 MID_INITIALS = SPACE(1) + COALESCE(LEFT(MIDDLE_NAME, 1), SPACE(0)) 
 
 
--- MEPS MEDICAL EXAM DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 MEPS_MEDICAL_EXAM_DATE     = CME.MEDICAL_EXAM_DATE,  
 MEPS_MEDICAL_LEFT_CORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(CME.LEFT_CORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), CME.LEFT_CORR_VISUAL_ACUITY)), SPACE(0)), 
 MEPS_MEDICAL_RIGHT_CORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(CME.RIGHT_CORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), CME.RIGHT_CORR_VISUAL_ACUITY)), SPACE(0)), 
 MEPS_MEDICAL_LEFT_UNCORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(CME.LEFT_UNCORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), CME.LEFT_UNCORR_VISUAL_ACUITY)), SPACE(0)),  
 MEPS_MEDICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(CME.RIGHT_UNCORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), CME.RIGHT_UNCORR_VISUAL_ACUITY)), SPACE(0)), 
 MEPS_MEDICAL_VISUAL_COLOR_CODE    = COALESCE(CME.VISUAL_COLOR, SPACE(0)), 
 MEPS_MEDICAL_HEIGHT     = COALESCE(REPLICATE('0', 2 - LEN(CME.HEIGHT)) + CME.HEIGHT, '00'), 
 MEPS_MEDICAL_WEIGHT     = COALESCE(REPLICATE('0', 3 - LEN(CME.WEIGHT)) + CME.WEIGHT, '000') 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN CANDIDATE_MEDICAL_EXAM CME ON  
  (OE.PERSON_ID = CME.MARINE_CANDIDATE_ID AND 
  CME.MEDICAL_EXAM_TYPE = 'FULL' AND 
  CME.MEDICAL_EXAM_DATE = dbo.GetMaxMedicalExamDate(CME.MARINE_CANDIDATE_ID, CME.MEDICAL_EXAM_TYPE)) 
 
 
 
--- FLIGHT PHYSICAL EXAM DATA 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 FLIGHT_PHYSICAL_DATE    = FP.EXAM_DATE,  
 FLIGHT_PHYSICAL_LEFT_CORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(FP.LEFT_CORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), FP.LEFT_CORR_VISUAL_ACUITY)), SPACE(0)), 
 FLIGHT_PHYSICAL_RIGHT_CORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(FP.RIGHT_CORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), FP.RIGHT_CORR_VISUAL_ACUITY)), SPACE(0)), 
 FLIGHT_PHYSICAL_LEFT_UNCORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(FP.LEFT_UNCORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), FP.LEFT_UNCORR_VISUAL_ACUITY)), SPACE(0)),  
 FLIGHT_PHYSICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY = COALESCE(CONVERT(CHAR(3), REPLICATE('0', 3- LEN(FP.RIGHT_UNCORR_VISUAL_ACUITY)) + 
        CONVERT(CHAR(3), FP.RIGHT_UNCORR_VISUAL_ACUITY)), SPACE(0)), 
 FLIGHT_PHYSICAL_VISUAL_COLOR_CODE    = COALESCE(FP.VISUAL_COLOR, SPACE(0)), 
 FLIGHT_PHYSICAL_HEIGHT     = COALESCE(REPLICATE('0', 2 - LEN(FP.HEIGHT)) + FP.HEIGHT, '00'), 
 FLIGHT_PHYSICAL_WEIGHT     = COALESCE(REPLICATE('0', 3 - LEN(FP.WEIGHT)) + FP.WEIGHT, '000') 
FROM 
 #OCS_CLASS_EXPORT OE INNER JOIN FLIGHT_PHYSICAL FP ON  
  (OE.PERSON_ID = FP.MARINE_CANDIDATE_ID AND 
  FP.EXAM_DATE = (SELECT MAX(FP1.EXAM_DATE) FROM FLIGHT_PHYSICAL FP1  
     WHERE FP1.MARINE_CANDIDATE_ID = FP.MARINE_CANDIDATE_ID)) 
 
 
--- DEFINE THE MAX MEDICAL TYPE 
SET ANSI_WARNINGS OFF 
 
UPDATE  
 #OCS_CLASS_EXPORT  
SET 
 MAX_MEDICAL_EXAM_TYPE = CASE (SELECT MAX(EXAM_DATE) FROM  
     ((SELECT MEPS_MEDICAL_EXAM_DATE AS EXAM_DATE FROM #OCS_CLASS_EXPORT OE1 WHERE OE1.PERSON_ID = OE.PERSON_ID) UNION 
     (SELECT FLIGHT_PHYSICAL_DATE FROM #OCS_CLASS_EXPORT OE1 WHERE OE1.PERSON_ID = OE.PERSON_ID)) AS MEDICAL_DATES) 
     WHEN MEPS_MEDICAL_EXAM_DATE THEN 'M' 
     WHEN FLIGHT_PHYSICAL_DATE  THEN 'F' 
     --- DEFAULT TO MEPS MEDICAL 
     ELSE 'M' 
     END 
FROM 
 #OCS_CLASS_EXPORT OE  
 
 
--- HARD CODED VALUES 
UPDATE 
 #OCS_CLASS_EXPORT  
SET 
 TRANSACTION_RUC   = '30382',  
 PRESENT_RUC   = '30382',  
 PRESENT_MCC   = '068',  
 UNIT_DIARY_NUMBER  = SPACE(2) + '555',  
 JURISDICTION_CODE  = '16',  
 SOURCE_INPOUR_CODE  = 'KCT',  
 APPLICATION_SYSTEMS_SOURCE_CODE = 'R',   
 DIARY_TYPE_CODE   = 'A',  
 HISTORY_ACTION_CODE  = 'A', 
 PROGRAM_ELEMENT_NUMBER  = '0084722M',  
 RESPONSIBILITY_CENTER_NUMBER = '010016',  
 PRESENT_SAT_DP_INSTALLATION = '09',  
 INDIVIDUAL_LOCATION_COUNTY_CODE = '153', 
 INDIVIDUAL_LOCATION_CODE  = '51', 
 PRESENT_GRADE_CODE  = 'E5', 
 PRIMARY_MOS_CODE  = '9900', 
 FILLER     = SPACE(99)  
 
 
--- RETRIEVE THE DATA AND CLEAN UP 
SELECT  
 PERSON_ID, NWA_ID, CONTRACT_ID, OCS_ID, COMMISSIONEE_ID,  
 MAX_STATUS_ID, OCS_CLASS_ID, OSS_ID,  
 TRANSACTION_RUC, PRESENT_RUC, PRESENT_MCC, UNIT_DIARY_NUMBER,  
 JURISDICTION_CODE, SOURCE_INPOUR_CODE, APPLICATION_SYSTEMS_SOURCE_CODE, DIARY_TYPE_CODE,  
 HISTORY_ACTION_CODE, PROGRAM_ELEMENT_NUMBER, RESPONSIBILITY_CENTER_NUMBER, PRESENT_SAT_DP_INSTALLATION,  
 INDIVIDUAL_LOCATION_COUNTY_CODE, INDIVIDUAL_LOCATION_CODE, EFFECTIVE_DATE, ARMED_FORCES_ORIG_ENTRY_DATE,  
 ARMED_FORCES_ACT_DU_BASE_DATE, CURRENT_ACTIVE_DUTY_BEGAN_DATE, CURRENT_TOUR_BEGIN_DATE, PAY_ENTRY_BASE_DATE,  
 PRESENT_RANK_DATE, PRESENT_GRADE_EFFECTIVE_DATE, PRESENT_GRADE_CODE, PRIMARY_MOS_CODE,  
 DISTRICT_CODE, OSS_MCC_CODE, CONTRACT_BEGIN_DATE,  
 COMPONENT_CODE, CURRENT_SOURCE_OF_ENTRY,  
 SSN_01, SSN_02_10, LAST_NAME, FIRST_NAME, MIDDLE_NAME, CADENCY_NAME_TEXT, LAST_INITIAL, FIRST_INITIAL,  
 MIDDLE_INITIAL, MID_INITIALS, SEX, RELIGION, DATE_OF_BIRTH, RACE,  
 ETHNIC, CITIZENSHIP, COUNTRY_OF_ORIGIN, MARITAL_STATUS, CURRENT_STREET_ADDRESS, CURRENT_CITY_CODE,  
 CURRENT_CITY_TEXT, CURRENT_COUNTY_CODE, CURRENT_STATE_CODE, CURRENT_ZIP_CODE,  
 HOR_TELEPHONE_NUMBER, HOR_CITY_CODE, HOR_COUNTY, HOR_STATE_CODE, HOR_ZIP_CODE,  
 EDUCATION_CERTIFICATION, EDUCATION_LEVEL, MEPS_MCC, ASVAB_VERSION, ASVAB_DATE,  
 GT_SCORE, EL_SCORE, MM_SCORE, AFQT_SCORE, DLAB_DATE, DLAB_SCORE, ARC_DATE, ARC_SCORE,  
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_HEIGHT  
  ELSE MEPS_MEDICAL_HEIGHT 
 END AS HEIGHT, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_WEIGHT  
  ELSE MEPS_MEDICAL_WEIGHT 
 END AS WEIGHT, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY  
  ELSE MEPS_MEDICAL_RIGHT_UNCORRECTED_VISUAL_ACUITY 
 END AS RIGHT_UNCORRECTED_VISUAL_ACUITY, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_LEFT_UNCORRECTED_VISUAL_ACUITY  
  ELSE MEPS_MEDICAL_LEFT_UNCORRECTED_VISUAL_ACUITY 
 END AS LEFT_UNCORRECTED_VISUAL_ACUITY, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_RIGHT_CORRECTED_VISUAL_ACUITY  
  ELSE MEPS_MEDICAL_RIGHT_CORRECTED_VISUAL_ACUITY 
 END AS RIGHT_CORRECTED_VISUAL_ACUITY, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_LEFT_CORRECTED_VISUAL_ACUITY  
  ELSE MEPS_MEDICAL_LEFT_CORRECTED_VISUAL_ACUITY 
 END AS LEFT_CORRECTED_VISUAL_ACUITY, 
 CASE MAX_MEDICAL_EXAM_TYPE 
  WHEN 'F' THEN FLIGHT_PHYSICAL_VISUAL_COLOR_CODE 
  ELSE MEPS_MEDICAL_VISUAL_COLOR_CODE 
 END AS VISUAL_COLOR_CODE, 
 RACE_AGGREGATE, FILLER 
FROM  
 #OCS_CLASS_EXPORT  
 
--- CLEAN UP 
DROP TABLE #OCS_CLASS_EXPORT  
DROP TABLE #OCS_CLASS_INFO 
SET NOCOUNT OFF 
SET ANSI_WARNINGS ON]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>