<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetApplicantJPASData]" directorySegmentName="seg_16" id="AEE0DF41-2962-F76C-35E4-C837B86A7574">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:47 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@AEPLogID int 
AS 
 
SET NOCOUNT ON  
 
CREATE TABLE #APPLICANT_DATA  
 (PERSON_ID INT NULL, NWA_ID INT NULL, CONTRACT_ID INT NULL, SHIP_ID INT NULL, RSS_ID INT NULL, CANDIDATE_STATUS_ID INT NULL,  
 STATUS_TYPE CHAR(1) NULL, CONTRACT_DATE DATETIME NULL, SHIP_DATE DATETIME NULL, DISTRICT VARCHAR(15) NULL,  
 CATEGORY_CODE CHAR(1) NOT NULL DEFAULT '', EXTRA_COVERAGE VARCHAR(1) NOT NULL DEFAULT '', POSITION_TITLE VARCHAR(30) NOT NULL DEFAULT '') 
 
DECLARE @PersonID int 
 
SET @PersonID = (SELECT PERSON_ID FROM AEP_FILE_UPLOAD_LOG WHERE AEP_FILE_UPLOAD_LOG_ID = @AEPLogID) 
 
--- GET IDs AND DATES 
INSERT INTO #APPLICANT_DATA  
 (PERSON_ID, NWA_ID, CONTRACT_ID, SHIP_ID, RSS_ID, CANDIDATE_STATUS_ID, CONTRACT_DATE, SHIP_DATE) 
SELECT 
 @PersonID, N.NWA_ID, C.CONTRACT_ID, S.SHIP_ID, N.ORGANIZATION_OF_RECORD_ID, dbo.GetMaxStatusID(N.NWA_ID),  
 C.CONTRACT_BEGIN_DATE, S.SHIP_DATE 
FROM 
 NWA N LEFT OUTER JOIN CONTRACT C ON N.NWA_ID = C.NWA_ID   
 LEFT OUTER JOIN SHIPPER S ON C.CONTRACT_ID = S.CONTRACT_ID 
WHERE 
 N.MARINE_CANDIDATE_ID = @PersonID AND  
 N.NWA_ID = dbo.GetMaxNWAID(@PersonID) 
   
--- GET STATUS TYPE 
UPDATE 
 #APPLICANT_DATA 
SET 
 STATUS_TYPE = CS.STATUS_TYPE 
FROM 
 #APPLICANT_DATA A INNER JOIN CANDIDATE_STATUS CS ON A.CANDIDATE_STATUS_ID = CS.CANDIDATE_STATUS_ID  
 
--- GET DISTRICT 
UPDATE 
 #APPLICANT_DATA 
SET 
 DISTRICT = DIST.SHORT_NAME 
FROM 
 #APPLICANT_DATA A INNER JOIN ORGANIZATION_MAP RSS ON A.RSS_ID = RSS.CHILD_ORGANIZATION_ID 
 INNER JOIN ORGANIZATION_MAP RS ON RSS.PARENT_ORGANIZATION_ID = RS.CHILD_ORGANIZATION_ID 
 INNER JOIN RECRUITING_ORGANIZATION DIST ON RS.PARENT_ORGANIZATION_ID = DIST.ORGANIZATION_ID 
 
--- SET CATEGORY CODE 
UPDATE 
 #APPLICANT_DATA 
SET 
 CATEGORY_CODE = CASE  
    --- OFFICERS 
    WHEN STATUS_TYPE = 'O' THEN 'X' 
    --- DIRECT SHIPPERS AND PRIOR SERVICE 
    WHEN (SHIP_ID IS NOT NULL AND DATEDIFF(DAY, CONTRACT_DATE, SHIP_DATE) = 0) THEN 'B' 
    --- DEPPERS 
    /* 
    WHEN (CONTRACT_ID IS NOT NULL AND SHIP_ID IS NULL) OR  
     (SHIP_ID IS NOT NULL AND DATEDIFF(DAY, CONTRACT_DATE, SHIP_DATE) != 0) THEN 'S' 
    */ 
    ELSE 'S' 
    END 
 
--- SET EXTRA COVERAGE 
UPDATE 
 #APPLICANT_DATA 
SET 
 --- SET TO 3 IF THE APPLICANT HAS A UV OR UW PROGRAM 
 EXTRA_COVERAGE = '3' 
 
FROM 
 #APPLICANT_DATA A INNER JOIN PROGRAM_AVAILABILITY PA ON A.CONTRACT_ID = PA.CONTRACT_ID 
 INNER JOIN PROGRAM P ON  
  (PA.PROGRAM_ID = P.PROGRAM_ID AND  
  P.PROGRAM_CODE IN ('UV', 'UW')) 
 
--- SET POSITION TITLE 
UPDATE 
 #APPLICANT_DATA 
SET 
 POSITION_TITLE = CASE STATUS_TYPE 
    WHEN 'O' THEN 'MARINE CORPS OFFICER CANDIDATE' 
    ELSE 'MARINE CORPS ENLISTED' 
    END 
   
--- RETURN DATA 
SELECT  
 COALESCE(CATEGORY_CODE, '') AS CATEGORY_CODE, 
 'UNK' AS UNIT_IDENTIFICATION_CODE, 
 COALESCE(EXTRA_COVERAGE, '') AS EXTRA_COVERAGE,  
 COALESCE(POSITION_TITLE, '') AS POSITION_TITLE 
FROM  
 #APPLICANT_DATA  
 
--- CLEAN UP 
DROP TABLE #APPLICANT_DATA  
SET NOCOUNT OFF]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>