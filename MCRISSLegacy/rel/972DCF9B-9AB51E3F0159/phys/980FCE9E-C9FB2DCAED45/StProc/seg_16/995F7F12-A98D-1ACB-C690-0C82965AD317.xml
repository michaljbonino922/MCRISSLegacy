<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetCandidatesWithUpdatedCriteria]" directorySegmentName="seg_16" id="995F7F12-A98D-1ACB-C690-0C82965AD317">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[AS 
 
SET NOCOUNT ON 
 
/* CREATE A TEMP TABLE TO STORE CONTRACT IDs FOR CONTRACTS WITH ASSIGNED PROGRAMS OR QSNS */ 
CREATE TABLE #ASSIGNED_CONTRACTS (CONTRACT_ID INT) 
 
/* GET CONTRACTS WITH ASSIGNED PROGRAMS */ 
INSERT INTO #ASSIGNED_CONTRACTS  
SELECT DISTINCT  
 PA.CONTRACT_ID  
FROM  
 PROGRAM_AVAILABILITY PA  
WHERE  
 PA.CONTRACT_ID IS NOT NULL AND 
 NOT EXISTS (SELECT * FROM CANDIDATE_CRITERIA_CONFIRMATION CCC WHERE  
   CCC.CONTRACT_ID = PA.CONTRACT_ID AND 
   CCC.PROGRAM_AVAILABILITY_ID = PA.PROGRAM_AVAILABILITY_ID) 
 
 
/* GET CONTRACTS WITH ASSIGNED QSNs */ 
INSERT INTO #ASSIGNED_CONTRACTS  
SELECT DISTINCT  
 QSN.CONTRACT_ID  
FROM  
 QSN  
WHERE  
 QSN.CONTRACT_ID IS NOT NULL AND 
 NOT EXISTS (SELECT * FROM CANDIDATE_CRITERIA_CONFIRMATION CCC WHERE  
   CCC.CONTRACT_ID = QSN.CONTRACT_ID AND 
   CCC.QSN = QSN.QSN_ID) 
 
/*  
GET THE CONTRACT POOLEES WITH PROGRAM(s)/QSNs ASSIGNED WHO HAVE HAD ANY CHANGES TO THEIR CRITERIA 
DATA SINCE THE PROGRAM/QSN WAS ASSIGNED. 
*/ 
INSERT INTO CANDIDATE_CRITERIA_CONFIRMATION (PERSON_ID, NWA_ID, CONTRACT_ID,  
 PROGRAM_AVAILABILITY_ID, QSN, USER_LOGIN, UPDATE_DATE) 
SELECT  
 P.PERSON_ID, NWA.NWA_ID, C.CONTRACT_ID,  
 PA.PROGRAM_AVAILABILITY_ID, QSN.QSN_ID, 
 'SA', GETDATE() 
FROM 
 PERSON P INNER JOIN MARINE_CANDIDATE MC ON P.PERSON_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN NWA ON P.PERSON_ID = NWA.MARINE_CANDIDATE_ID  
 INNER JOIN CANDIDATE_STATUS CS ON NWA.NWA_ID = CS.NWA_ID 
 INNER JOIN CONTRACT C ON NWA.NWA_ID = C.NWA_ID 
 LEFT OUTER JOIN PROGRAM_AVAILABILITY PA ON C.CONTRACT_ID = PA.CONTRACT_ID 
 LEFT OUTER JOIN QSN ON C.CONTRACT_ID = QSN.CONTRACT_ID 
WHERE 
 /* ONLY RETRIEVE RECORDS THAT WE HAVEN'T PROCESSED BEFORE */ 
 /* ONLY CHECK POOLEES WITH PROGRAMS OR QSNs ASSIGNED */ 
 C.CONTRACT_ID IN (SELECT CONTRACT_ID FROM #ASSIGNED_CONTRACTS) AND 
 CS.STATUS_CODE = 'B' AND 
 CS.DISPOSITION_CODE = 'K' AND 
 CS.CANDIDATE_STATUS_ID = (SELECT MAX(CS2.CANDIDATE_STATUS_ID) FROM CANDIDATE_STATUS CS2 
     WHERE CS2.NWA_ID = CS.NWA_ID) AND 
 ( 
 C.UPDATE_DATE > CASE  
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 MC.UPDATE_DATE > CASE 
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CE.UPDATE_DATE FROM CANDIDATE_EDUCATION CE WHERE CE.MARINE_CANDIDATE_ID = P.PERSON_ID 
  ORDER BY CE.SCHOOL_END_DATE DESC) > CASE  
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CA.UPDATE_DATE FROM CANDIDATE_ASVAB CA WHERE CA.MARINE_CANDIDATE_ID = P.PERSON_ID 
  ORDER BY CA.ASVAB_DATE DESC) > CASE 
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CME.UPDATE_DATE FROM CANDIDATE_MEDICAL_EXAM CME WHERE CME.MARINE_CANDIDATE_ID = P.PERSON_ID 
  AND CME.MEDICAL_EXAM_TYPE = 'FULL' ORDER BY CME.MEDICAL_EXAM_DATE DESC) > CASE 
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CW.UPDATE_DATE FROM CANDIDATE_WAIVER CW INNER JOIN WAIVER W ON CW.WAIVER_ID = W.WAIVER_ID 
  INNER JOIN WAIVER_CATEGORY WC ON W.WAIVER_CATEGORY_ID = WC.WAIVER_CATEGORY_ID 
  INNER JOIN WAIVER_LEVEL WL ON W.WAIVER_LEVEL_ID = WL.WAIVER_LEVEL_ID 
  WHERE CW.NWA_ID = NWA.NWA_ID AND 
  -- W.WAIVER_CATEGORY_ID IN (4, 6) 
  WC.WAIVER_CATEGORY_CODE IN ('D', 'F')) > CASE  
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CPE.UPDATE_DATE FROM CANDIDATE_PROFESSED_EXAM CPE WHERE CPE.MARINE_CANDIDATE_ID = P.PERSON_ID 
  AND CPE.PROFESSED_EXAM_TYPE IN ('B', 'M', 'P') ORDER BY CPE.EXAM_DATE DESC) > CASE 
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END OR 
 (SELECT TOP 1 CSE.UPDATE_DATE FROM CANDIDATE_SPECIAL_EXAM CSE WHERE CSE.MARINE_CANDIDATE_ID = P.PERSON_ID 
  AND CSE.SPECIAL_EXAM_TYPE IN ('APT', 'DLAB', 'EDPT') ORDER BY CSE.SPECIAL_EXAM_DATE DESC) > CASE 
  WHEN C.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN QSN.PROGRAM_ASSIGNMENT_DATE  
  ELSE PA.PROGRAM_ASSIGNMENT_DATE  
  END 
 ) 
 
/*  
UPDATE CONTRACT POOLEES IN CANDIDATE_CRITERIA_CONFIRMATION IN CASE THEY'VE BEEN UPDATED 
SINCE THEY WERE LAST CHECKED.  
*/ 
UPDATE  
 CANDIDATE_CRITERIA_CONFIRMATION  
SET  
 QUALIFIED = NULL 
WHERE  
 QUALIFIED IS NOT NULL AND 
 ( 
 (SELECT C.UPDATE_DATE FROM CONTRACT C WHERE C.CONTRACT_ID = CANDIDATE_CRITERIA_CONFIRMATION.CONTRACT_ID) >  
  CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT MC.UPDATE_DATE FROM MARINE_CANDIDATE MC WHERE MC.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID)  
  > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR   
 (SELECT TOP 1 CE.UPDATE_DATE FROM CANDIDATE_EDUCATION CE WHERE CE.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID 
  ORDER BY CE.SCHOOL_END_DATE DESC) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT TOP 1 CA.UPDATE_DATE FROM CANDIDATE_ASVAB CA WHERE CA.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID 
  ORDER BY CA.ASVAB_DATE DESC) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT TOP 1 CME.UPDATE_DATE FROM CANDIDATE_MEDICAL_EXAM CME WHERE CME.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID 
  AND CME.MEDICAL_EXAM_TYPE = 'FULL' ORDER BY CME.MEDICAL_EXAM_DATE DESC) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT TOP 1 CW.UPDATE_DATE FROM CANDIDATE_WAIVER CW INNER JOIN WAIVER W ON CW.WAIVER_ID = W.WAIVER_ID 
  INNER JOIN WAIVER_CATEGORY WC ON W.WAIVER_CATEGORY_ID = WC.WAIVER_CATEGORY_ID 
  INNER JOIN WAIVER_LEVEL WL ON W.WAIVER_LEVEL_ID = WL.WAIVER_LEVEL_ID 
  WHERE CW.NWA_ID = CANDIDATE_CRITERIA_CONFIRMATION.NWA_ID AND 
  -- W.WAIVER_CATEGORY_ID IN (4, 6) 
  WC.WAIVER_CATEGORY_CODE IN ('D', 'F')) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT TOP 1 CPE.UPDATE_DATE FROM CANDIDATE_PROFESSED_EXAM CPE WHERE CPE.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID 
  AND CPE.PROFESSED_EXAM_TYPE IN ('B', 'M', 'P') ORDER BY CPE.EXAM_DATE DESC) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE OR 
 (SELECT TOP 1 CSE.UPDATE_DATE FROM CANDIDATE_SPECIAL_EXAM CSE WHERE CSE.MARINE_CANDIDATE_ID = CANDIDATE_CRITERIA_CONFIRMATION.PERSON_ID 
  AND CSE.SPECIAL_EXAM_TYPE IN ('APT', 'DLAB', 'EDPT') ORDER BY CSE.SPECIAL_EXAM_DATE DESC) > CANDIDATE_CRITERIA_CONFIRMATION.UPDATE_DATE 
 ) AND 
 ( 
 (SELECT CS.STATUS_CODE + CS.DISPOSITION_CODE FROM CANDIDATE_STATUS CS  
  WHERE CS.NWA_ID = CANDIDATE_CRITERIA_CONFIRMATION.NWA_ID AND 
  CS.CANDIDATE_STATUS_ID = (SELECT MAX(CS2.CANDIDATE_STATUS_ID) FROM CANDIDATE_STATUS CS2 
      WHERE CS2.NWA_ID = CS.NWA_ID)) = 'BK'  
 )]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>