<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetRecruiterBilletDataByMonthCalendarYear]" directorySegmentName="seg_9" id="24ACF193-C990-29FF-099F-237FB0AA0912">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:42 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@Organiza.onID int, 
 @DisplayCode int, 
 @Month varchar(2), 
 @CalendarYear varchar(4) 
AS 
 
 
DECLARE @Temp TABLE (Org int) 
INSERT INTO @Temp VALUES(@Organiza.onID) 
INSERT INTO @Temp SELECT Decendent FROM vwDecendentRecrui.ngOrgs WITH (NOLOCK) WHERE Parent = @Organiza.onID 
 
CREATE TABLE #BILLET_DATA  
 (SHORT_DESCRIPTION VARCHAR(62),  
  BILLET_BEGIN_DATE VARCHAR(30),  
     BILLET_END_DATE VARCHAR(30),  
  UNIT_ABBREVIATION varchar(50),  
  RECRUITING_PERSON_ID int, 
  ORGANIZATION_ID int) 
 
 
INSERT INTO #BILLET_DATA 
SELECT   
 RR.SHORT_DESCRIPTION,  
 COALESCE(CONVERT(VARCHAR(11), RP.BILLET_BEGIN_DATE, 106), SPACE(0)) AS BILLET_BEGIN_DATE,  
 COALESCE(CONVERT(VARCHAR(11), RP.BILLET_END_DATE, 106), SPACE(0)) AS BILLET_END_DATE, 
 NULL AS UNIT_ABBREVIATION, 
 RP.RECRUITING_PERSON_ID, 
 ORGANIZATION_ID 
FROM  
 RECRUITING_PERSON RP WITH (NOLOCK) INNER JOIN RECRUITING_ROLE RR ON 
 RP.RECRUITING_ROLE_ID = RR.RECRUITING_ROLE_ID 
WHERE  
 ((BILLET_END_DATE IS NOT NULL AND (CONVERT(date.me, @Month + '/1/' + @CalendarYear) BETWEEN CONVERT(date.me, CAST(DATEPART(MONTH, BILLET_BEGIN_DATE) AS VARCHAR) + '/1/' + CAST(DATEPART(YEAR, BILLET_BEGIN_DATE) AS VARCHAR)) AND BILLET_END_DATE)) OR 
  (BILLET_END_DATE IS NULL AND TOUR_END_DATE IS NULL AND (CONVERT(date.me, @Month + '/1/' + @CalendarYear) BETWEEN CONVERT(date.me, CAST(DATEPART(MONTH, BILLET_BEGIN_DATE) AS VARCHAR) + '/1/' + CAST(DATEPART(YEAR, BILLET_BEGIN_DATE) AS VARCHAR)) AND GETDATE())) OR  
  (BILLET_END_DATE IS NULL AND TOUR_END_DATE IS NOT NULL AND (CONVERT(date.me, @Month + '/1/' + @CalendarYear) BETWEEN CONVERT(date.me, CAST(DATEPART(MONTH, BILLET_BEGIN_DATE) AS VARCHAR) + '/1/' + CAST(DATEPART(YEAR, BILLET_BEGIN_DATE) AS VARCHAR)) AND COALESCE(CONVERT(VARCHAR(11), RP.TOUR_END_DATE, 106), SPACE(0))))) 
 AND 
 ((@DisplayCode=1 AND ORGANIZATION_ID = @Organiza.onID) OR (@DisplayCode=2 AND ORGANIZATION_ID IN (SELECT Org FROM @Temp))) 
  
UNION 
 
SELECT  
 BILLET_DESC,  
 COALESCE(CONVERT(VARCHAR(11), BILLET_BEGIN_DATE, 106), SPACE(0)) AS BILLET_BEGIN_DATE,  
 COALESCE(CONVERT(VARCHAR(11), BILLET_END_DATE, 106), SPACE(0)) AS BILLET_END_DATE,  
 RTRIM(HQ_NAME) + RTRIM( 
    CASE 
   WHEN REGION_NAME IS NOT NULL THEN '\' + REGION_NAME 
   ELSE ''  
    END) + RTRIM( 
       CASE  
   WHEN DISTRICT_NAME IS NOT NULL THEN '\' + DISTRICT_NAME 
   ELSE ''  
       END)+ RTRIM( 
    CASE  
   WHEN RS_NAME IS NOT NULL THEN '\' + RS_NAME 
   ELSE ''  
       END) + RTRIM(  
    CASE  
   WHEN RSS_NAME IS NOT NULL THEN '\' + RSS_NAME 
   ELSE ''  
       END) AS UNIT_ABBREVIATION, 
 RECRUITING_PERSON_ID, 
 RO.ORGANIZATION_ID AS ORGANIZATION_ID 
FROM  
 RECRUITER_HISTORY RH WITH (NOLOCK) INNER JOIN dbo.RECRUITING_ORGANIZATION RO 
 ON RH.ORGANIZATION_TYPE=RO.ORGANIZATION_TYPE AND   
 RO.SHORT_NAME= 
 CASE 
  WHEN RH.ORGANIZATION_TYPE='RSS' OR RH.ORGANIZATION_TYPE='OSS' THEN RSS_NAME 
  WHEN RH.ORGANIZATION_TYPE='RS' THEN RS_NAME  
  WHEN RH.ORGANIZATION_TYPE='D' THEN DISTRICT_NAME 
  WHEN RH.ORGANIZATION_TYPE='R' THEN REGION_NAME 
  ELSE HQ_NAME 
 END  
 AND ((RH.RS_NAME IS NULL) OR  
   ((RH.RS_NAME = 
    CASE 
     WHEN RH.ORGANIZATION_TYPE='RSS' OR RH.ORGANIZATION_TYPE='OSS' THEN 
       (SELECT SHORT_NAME FROM dbo.RECRUITING_ORGANIZATION RO2 
       WHERE RO2.ORGANIZATION_ID= 
        (SELECT PARENT_ORGANIZATION_ID FROM dbo.ORGANIZATION_MAP WHERE CHILD_ORGANIZATION_ID=RO.ORGANIZATION_ID)) 
     ELSE  RS_NAME   
    END)) 
  ) 
WHERE  
 ((BILLET_BEGIN_DATE IS NOT NULL AND (CONVERT(date.me, @Month + '/1/' + @CalendarYear) BETWEEN CONVERT(date.me, CAST(DATEPART(MONTH, BILLET_BEGIN_DATE) AS VARCHAR) + '/1/' + CAST(DATEPART(YEAR, BILLET_BEGIN_DATE) AS VARCHAR)) AND BILLET_END_DATE)) OR  
  (BILLET_BEGIN_DATE IS NULL AND (CONVERT(date.me, @Month + '/1/' + @CalendarYear) BETWEEN CONVERT(date.me, CAST(DATEPART(MONTH, RH.EFFECTIVE_DATE) AS VARCHAR) + '/1/' + CAST(DATEPART(YEAR, RH.EFFECTIVE_DATE) AS VARCHAR)) AND BILLET_END_DATE))) 
 AND  
 ((@DisplayCode=1 AND ORGANIZATION_ID = @Organiza.onID) OR (@DisplayCode=2 AND ORGANIZATION_ID IN (SELECT Org FROM @Temp))) 
 
 
SELECT SHORT_DESCRIPTION, BILLET_BEGIN_DATE, BILLET_END_DATE, UNIT_ABBREVIATION, RECRUITING_PERSON_ID, ORGANIZATION_ID 
FROM #BILLET_DATA 
 
DROP TABLE #BILLET_DATA]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>