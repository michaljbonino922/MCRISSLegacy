<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetMissionBoardDetailActualDataByOrgFY]" directorySegmentName="seg_6" id="31D25B16-3DF7-4321-DD64-CAFD7244CBFE">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:42 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@Organiza.onID  as integer,  
 @FiscalYear   as integer 
 
AS 
 
 SET NOCOUNT ON 
 SET ARITHABORT ON 
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
 -- Get the withdrawn NWAs so the withdrawn contracts can be excluded 
 CREATE TABLE #Withdrawals(NWA_ID int) 
 Insert into #Withdrawals 
 Exec [MCRISS].[USMC].[GetWithdrawnNWAs]; 
 
--get nwaid's that are not reservist minus duplicates 
 SELECT N.NWA_ID  
 INTO #NWAIDs 
 FROM NWA N    
 INNER JOIN OCS O ON O.NWA_ID = N.NWA_ID  
 INNER JOIN OFFICER_CONTRACT OFC ON OFC.NWA_ID = N.NWA_ID 
 INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID  
 WHERE N.ORGANIZATION_OF_RECORD_ID = @Organiza.onID 
 AND N.OFFICER_COMPONENT_CODE IS NOT NULL AND N.OFFICER_COMPONENT_CODE IN ('0A', '0B', '0C', '0E', '1A', '1B', '1C', '1H')   
   AND n.Mission_Year_Work_For = @FiscalYear 
   AND o.OCS_ID = (SELECT MIN(OCS_ID) FROM MCRISS.dbo.OCS WHERE NWA_ID = N.NWA_ID AND OCS_CLASS_ID IS NOT NULL) 
   AND OFC.contract_begin_Date =  
         (SELECT MIN(contract_begin_Date) 
       FROM MCRISS.dbo.OFFICER_CONTRACT OC 
       INNER JOIN NWA N ON N.NWA_ID =  OC.NWA_ID 
       INNER JOIN OCS O ON O.NWA_ID = N.NWA_ID            
       INNER JOIN MARINE_CANDIDATE M ON  M.MARINE_CANDIDATE_ID = N.MARINE_CANDIDATE_ID 
       WHERE M.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
       AND n.Mission_Year_Work_For = @FiscalYear 
       AND o.OCS_ID = (SELECT MIN(OCS_ID) FROM MCRISS.dbo.OCS WHERE NWA_ID = N.NWA_ID AND OCS_CLASS_ID IS NOT NULL) 
       AND N.ORGANIZATION_OF_RECORD_ID = @Organiza.onID 
       AND N.OFFICER_COMPONENT_CODE IS NOT NULL AND N.OFFICER_COMPONENT_CODE IN ('0A', '0B', '0C', '0E', '1A', '1B', '1C', '1H')) 
 AND N.NWA_ID not in (SELECT NWA_ID FROM #Withdrawals) 
 
--get nwaid's for reservist minus duplicates 
INSERT INTO #NWAIDs 
SELECT N.NWA_ID 
FROM NWA N    
INNER JOIN OCS O ON O.NWA_ID = N.NWA_ID  
INNER JOIN OFFICER_CONTRACT OFC ON OFC.NWA_ID = N.NWA_ID 
INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID  
WHERE N.ORGANIZATION_OF_RECORD_ID = @Organiza.onID 
AND N.OFFICER_COMPONENT_CODE IS NOT NULL AND N.OFFICER_COMPONENT_CODE IN ('1E', '0F')   
  AND n.Mission_Year_Work_For = @FiscalYear 
  AND o.OCS_ID = (SELECT MIN(OCS_ID) FROM MCRISS.dbo.OCS WHERE NWA_ID = N.NWA_ID AND OCS_CLASS_ID IS NOT NULL) 
  AND OFC.contract_begin_Date =  
        (SELECT MIN(contract_begin_Date) 
         FROM MCRISS.dbo.OFFICER_CONTRACT OC 
      INNER JOIN NWA N ON N.NWA_ID =  OC.NWA_ID 
      INNER JOIN OCS O ON O.NWA_ID = N.NWA_ID               
      INNER JOIN MARINE_CANDIDATE M ON  M.MARINE_CANDIDATE_ID = N.MARINE_CANDIDATE_ID 
      WHERE M.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
      AND N.OFFICER_COMPONENT_CODE IN ('1E', '0F') 
      AND o.OCS_ID = (SELECT MIN(OCS_ID) FROM MCRISS.dbo.OCS WHERE NWA_ID = N.NWA_ID AND OCS_CLASS_ID IS NOT NULL) 
      AND n.Mission_Year_Work_For = @FiscalYear 
      AND N.ORGANIZATION_OF_RECORD_ID = @Organiza.onID) 
AND N.NWA_ID not in (SELECT NWA_ID FROM #Withdrawals) 
 
 
 
 SELECT 
  N.RowGuid AS NWARowID, 
   
  CASE 
   WHEN N.OFFICER_COMPONENT_CODE IN ('0A', '0B', '0C', '0E', '0F') THEN 'PLC' 
   WHEN N.OFFICER_COMPONENT_CODE IN ('1A', '1B', '1C', '1H', '1E') THEN 'OCC' 
  END AS OFFICER_SOURCE_CODE,  
 
  CASE WHEN N.OFFICER_COMPONENT_CODE IN ('1A', '1B', '1C', '1H', '1E') THEN  
   CASE 
    WHEN  OC.CLASS_NUMBER =  (SELECT MIN (OC.CLASS_NUMBER) FROM OCS_CLASS OC WHERE OC.FISCAL_YEAR =  @FiscalYear and TRAINING_TYPE_CODE = 'OCC') THEN 1 
    WHEN  OC.CLASS_NUMBER =  (SELECT MAX (OC.CLASS_NUMBER) FROM OCS_CLASS OC WHERE OC.FISCAL_YEAR = @FiscalYear and TRAINING_TYPE_CODE = 'OCC') THEN 3 
    WHEN (OC.CLASS_NUMBER >  (SELECT MIN (OC.CLASS_NUMBER) FROM OCS_CLASS OC WHERE OC.FISCAL_YEAR =  @FiscalYear and TRAINING_TYPE_CODE = 'OCC')  
          AND OC.CLASS_NUMBER < (SELECT MAX (OC.CLASS_NUMBER) FROM OCS_CLASS OC WHERE OC.FISCAL_YEAR = @FiscalYear and TRAINING_TYPE_CODE = 'OCC')) THEN 2 
   END 
   ELSE  
    CASE 
     WHEN n.SHIP_MISSION = @FiscalYear + 1 AND oc.TRAINING_TYPE_CODE ='PLCCOMB'  THEN 1 
     WHEN n.SHIP_MISSION = @FiscalYear + 2 AND  
          ( (oc.TRAINING_TYPE_CODE IN ('PLCJR', 'PLCSR')) OR 
         (oc.TRAINING_TYPE_CODE = 'PLCCOMB' AND N.OFFICER_COMPONENT_CODE = '0E') 
       )  THEN 2 
     WHEN n.SHIP_MISSION = @FiscalYear + 3 AND  
       ( (oc.TRAINING_TYPE_CODE IN ('PLCJR', 'PLCSR')) OR 
         (oc.TRAINING_TYPE_CODE = 'PLCCOMB' AND N.OFFICER_COMPONENT_CODE = '0E') 
       ) 
       THEN 3 
    END  
  END AS DATA_TABLE_NUM, 
 
  RTRIM (P.LAST_NAME) + ',' + RTRIM(P.FIRST_NAME) + '.' + IsNull(substring(P.LEGAL_MIDDLE_NAME,1,1),'') + '.'  AS CANDIDATE_NAME,  
   
  N.OFFICER_COMPONENT_CODE AS COMPONENT_CODE, 
   
  COALESCE(( 
     SELECT TOP 1 
      HS2.HIGHSCHOOL_NAME 
     FROM 
      dbo.CANDIDATE_EDUCATION CE2 
      INNER JOIN dbo.HIGH_SCHOOL HS2  ON (CE2.SCHOOL_CODE = HS2.SCHOOL_CODE) 
     WHERE 
      CE2.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
     ORDER BY 
      CE2.Educa.onType 
     ), '') 
  AS [HIGHSCHOOL_NAME], 
 
  CASE 
   WHEN (MC.RACE_CODE + MC.ETHNIC_CODE) IS NULL THEN NULL 
   WHEN (MC.RACE_CODE + MC.ETHNIC_CODE) IN 
     ('AA', 
      'C1','C2','C3','C4','C5','C6','C7','C9','CA','CB','CD','CE','CF','CG','CH','CJ', 
      'CK','CL','CP','CQ','CS','CT','CV','CW','CZ', 
      'EA','FA') THEN 'AA' 
   WHEN (MC.RACE_CODE + MC.ETHNIC_CODE) IN 
     ('EP','EZ','FP','FZ') THEN 'W' 
   WHEN (MC.RACE_CODE + MC.ETHNIC_CODE) IN 
     ('A4','A6','A9','AB','AS','BB','DB','E1','E4','E6','E9','EB','ES','F1','F4','F6', 
      'F9','FB','FS') THEN 'H' 
   ELSE 'O' 
  END AS DIVERSITY_CODE, 
   
  MC.GENDER_CODE AS GENDER_CODE, 
   
  CASE  
   WHEN N.OFFICER_COMPONENT_CODE IN ('0A', '0B', '0C', '0E', '0F') THEN  
    CASE 
     WHEN n.SHIP_MISSION = @FiscalYear + 1 AND oc.TRAINING_TYPE_CODE ='PLCCOMB'  THEN NULL 
     WHEN n.SHIP_MISSION = @FiscalYear + 2 AND  
          ( (oc.TRAINING_TYPE_CODE IN ('PLCJR', 'PLCSR')) OR 
         (oc.TRAINING_TYPE_CODE = 'PLCCOMB' AND N.OFFICER_COMPONENT_CODE = '0E') 
       )  THEN OC.CLASS_NUMBER 
     WHEN n.SHIP_MISSION = @FiscalYear + 3 AND  
       ( (oc.TRAINING_TYPE_CODE IN ('PLCJR', 'PLCSR')) OR 
         (oc.TRAINING_TYPE_CODE = 'PLCCOMB' AND N.OFFICER_COMPONENT_CODE = '0E') 
       ) 
       THEN OC.CLASS_NUMBER 
    END 
   ELSE  
    NULL  
  END AS INCREMENT 
   
 FROM NWA N    
   
  INNER JOIN OFFICER_CONTRACT OFC ON OFC.NWA_ID = N.NWA_ID 
  INNER JOIN OCS O ON O.NWA_ID = N.NWA_ID 
  INNER JOIN OCS_CLASS OC ON OC.CLASS_ID = O.OCS_CLASS_ID  
  INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
  INNER JOIN PERSON P ON (P.PERSON_ID = MC.MARINE_CANDIDATE_ID) 
 WHERE  N.NWA_ID in (SELECT NWA_ID FROM  #NWAIDs) 
  AND N.NWA_ID not in (SELECT NWA_ID FROM #Withdrawals) 
   
   
 
drop table #NWAIDs 
drop table #Withdrawals 
 
SET NOCOUNT OFF]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>