<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetNROTCContract]" directorySegmentName="seg_18" id="A5C42742-623D-095F-698F-A28DCE93E5D3">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@ContractID int 
AS 
 
SET NOCOUNT ON 
 
CREATE TABLE #CONTRACT  
 (CONTRACT_ID INT, NWA_ID INT, CONTRACT_BEGIN_DATE DATETIME, COMPONENT_CODE VARCHAR(2), PROGRAM_TYPE INT NULL,  
 BACKGROUND_COMPLETE_DATE DATETIME NULL, CONTRACT_GPA FLOAT NULL, PROJECTED_GRAD_DATE DATETIME NULL, PROJECTED_COMMISSION_DATE DATETIME NULL, 
 EMAIL_ADDRESS VARCHAR(50) NULL, NROTC_UNIT INT NULL, I_AND_I_STATE VARCHAR(2) NULL, I_AND_I_CITY VARCHAR(4) NULL, 
 DISCHARGE_CODE VARCHAR(3) NULL, DISCHARGE_DATE DATETIME NULL, LEAVE_OF_ABSENCE_REASON INT NULL, LEAVE_OF_ABSENCE_DATE DATETIME NULL,   
 OCS_ID INT NULL, OCS_CLASS VARCHAR(7) NULL, CLASS_NUMBER INT NULL, FISCAL_YEAR INT NULL, OCS_CLASS_BEGIN_DATE DATETIME NULL, OCS_CLASS_END_DATE DATETIME NULL, 
 RANK VARCHAR(10) NULL, PRIMARY_MOS VARCHAR(4) NULL, PRIMARY_MOS_DESCRIPTION VARCHAR(80) NULL, BILLET_MOS VARCHAR(4) NULL, BILLET_MOS_DESCRIPTION VARCHAR(80) NULL, 
 PROGRAM_BEGIN_DATE DATETIME NULL, PROGRAM_GRAD_DATE DATETIME NULL, ADVANCED_PROGRAM VARCHAR(2) NULL, ADVANCED_PROGRAM_DESCRIPTION VARCHAR(50) NULL) 
 
INSERT INTO #CONTRACT  
 (CONTRACT_ID, NWA_ID, CONTRACT_BEGIN_DATE, COMPONENT_CODE,  
 PROGRAM_TYPE,  
 BACKGROUND_COMPLETE_DATE, CONTRACT_GPA, PROJECTED_GRAD_DATE,  
 PROJECTED_COMMISSION_DATE, DISCHARGE_CODE, DISCHARGE_DATE,   
 EMAIL_ADDRESS,  
 NROTC_UNIT, I_AND_I_STATE, I_AND_I_CITY,  
 LEAVE_OF_ABSENCE_REASON, LEAVE_OF_ABSENCE_DATE,  
 PROGRAM_BEGIN_DATE, PROGRAM_GRAD_DATE, ADVANCED_PROGRAM, ADVANCED_PROGRAM_DESCRIPTION) 
SELECT  
 @ContractID, C.NWA_ID, C.CONTRACT_BEGIN_DATE, N.OFFICER_COMPONENT_CODE,  
 NC.PROGRAM_TYPE,  
 C.BACKGROUND_COMPLETE_DATE, C.CONTRACT_GPA, C.PROJECTED_GRAD_DATE,  
 C.PROJECTED_COMMISSION_DATE, C.DISCHARGE_CODE, C.DISCHARGE_DATE,  
 N.EMAIL_ADDRESS, 
 NC.NROTC_UNIT_ID, NC.I_AND_I_STATE, NC.I_AND_I_CITY,  
 NC.LEAVE_OF_ABSENCE_REASON, NC.LEAVE_OF_ABSENCE_DATE, 
 NB.PROGRAM_BEGIN_DATE, NB.PROGRAM_GRAD_DATE, NB.ADVANCED_PROGRAM, 
 CC_NB.COMPONENT_DESCRIPTION AS ADVANCED_PROGRAM_DESCRIPTION 
FROM  
 OFFICER_CONTRACT C INNER JOIN NWA N ON  
  (C.CONTRACT_ID = @ContractID AND 
  C.NWA_ID = N.NWA_ID) 
 LEFT OUTER JOIN COMPONENT_CODE CC ON N.OFFICER_COMPONENT_CODE = CC.COMPONENT_CODE 
 LEFT OUTER JOIN OCS ON  
  (C.NWA_ID = OCS.NWA_ID AND 
  OCS.OCS_ID = dbo.GetMaxOCSID(OCS.NWA_ID, NULL)) 
 LEFT OUTER JOIN OCS_CLASS CL ON OCS.OCS_CLASS_ID = CL.CLASS_ID 
 LEFT OUTER JOIN NROTC_CONTRACT NC ON C.CONTRACT_ID = NC.CONTRACT_ID 
 LEFT OUTER JOIN NROTC_BOOST NB ON  
  (N.NWA_ID = NB.NWA_ID AND  
  N.OFFICER_COMPONENT_CODE = 'N9') 
 LEFT OUTER JOIN COMPONENT_CODE CC_NB ON NB.ADVANCED_PROGRAM = CC_NB.COMPONENT_CODE 
 
 
 
--- GET OCS DATA 
UPDATE 
 #CONTRACT 
SET 
 OCS_ID    = O.OCS_ID, 
 OCS_CLASS   = CL.TRAINING_TYPE_CODE,  
 CLASS_NUMBER  = CL.CLASS_NUMBER, 
 FISCAL_YEAR  = CL.FISCAL_YEAR, 
 OCS_CLASS_BEGIN_DATE  = CL.CLASS_BEGIN_DATE,  
 OCS_CLASS_END_DATE  = CL.CLASS_END_DATE  
FROM 
 #CONTRACT C INNER JOIN OCS O ON  
  (C.NWA_ID = O.NWA_ID AND 
  O.OCS_ID = dbo.GetMaxOCSID(C.NWA_ID, NULL)) 
 INNER JOIN OCS_CLASS CL ON O.OCS_CLASS_ID = CL.CLASS_ID 
 
--- GET RANK/MOS DATA 
UPDATE 
 #CONTRACT 
SET 
 RANK    = PG.RANK_CODE, 
 PRIMARY_MOS   = M.PRIMARY_MOS, 
 BILLET_MOS   = M.BILLET_MOS 
FROM 
 #CONTRACT C INNER JOIN NWA N ON C.NWA_ID = N.NWA_ID 
 INNER JOIN MARINE M ON N.MARINE_CANDIDATE_ID = M.MARINE_ID 
 INNER JOIN PAY_GRADE PG ON M.PRESENT_GRADE_CODE = PG.PAY_GRADE_CODE 
 
--- GET MOS DESCRIPTION DATA 
UPDATE 
 #CONTRACT 
SET 
 PRIMARY_MOS_DESCRIPTION = M.SHORT_DESCRIPTION 
FROM   
 #CONTRACT C INNER JOIN MOS M ON  
  (C.PRIMARY_MOS = M.OCCUPATION_CODE AND 
  (C.PRIMARY_MOS + '00') = M.MOS_CODE) 
 
UPDATE 
 #CONTRACT 
SET 
 BILLET_MOS_DESCRIPTION  = M.SHORT_DESCRIPTION 
FROM   
 #CONTRACT C INNER JOIN MOS M ON C.BILLET_MOS = M.MOS_CODE 
 
DECLARE @PriorServiceHistoryPresent bit 
--- RETRIEVE THE PRIOR SERVICE HISTORY PRESENT FLAG 
SET @PriorServiceHistoryPresent = CASE  
    WHEN EXISTS (SELECT 1 FROM CANDIDATE_PRIOR_SERVICE PSH INNER JOIN NWA N ON PSH.MARINE_CANDIDATE_ID = N.MARINE_CANDIDATE_ID 
       INNER JOIN NROTC_CONTRACT NC ON N.NWA_ID = NC.NWA_ID       
       WHERE NC.CONTRACT_ID = @ContractID) 
    THEN 1 
    ELSE 0 
    END 
 
--- RETURN THE DATA 
SELECT  
 CONVERT(VARCHAR(11), CONTRACT_BEGIN_DATE, 106) AS ACCEPTANCE_DATE, 
 COALESCE(COMPONENT_CODE, SPACE(0)) AS COMPONENT_CODE, 
 COALESCE(OCS_ID, 0) AS OCS_ID, 
 COALESCE(OCS_CLASS, SPACE(0)) AS OCS_CLASS, 
 COALESCE(CLASS_NUMBER, 0) AS CLASS_NUMBER, 
 COALESCE(FISCAL_YEAR, 0) AS FISCAL_YEAR, 
 COALESCE(CONVERT(VARCHAR(11), OCS_CLASS_BEGIN_DATE, 106), SPACE(0)) AS OCS_CLASS_BEGIN_DATE, 
 COALESCE(CONVERT(VARCHAR(11), OCS_CLASS_END_DATE, 106), SPACE(0)) AS OCS_CLASS_END_DATE, 
 COALESCE(CONVERT(VARCHAR(11), BACKGROUND_COMPLETE_DATE, 106), SPACE(0)) AS BACKGROUND_COMPLETE_DATE, 
 COALESCE(CONTRACT_GPA, 0) AS CONTRACT_GPA, 
 COALESCE(CONVERT(VARCHAR(11), PROJECTED_GRAD_DATE, 106), SPACE(0)) AS PROJECTED_GRAD_DATE, 
 COALESCE(CONVERT(VARCHAR(11), PROJECTED_COMMISSION_DATE, 106), SPACE(0)) AS PROJECTED_COMMISSION_DATE, 
 COALESCE(EMAIL_ADDRESS, SPACE(0)) AS EMAIL_ADDRESS, 
 COALESCE(NROTC_UNIT, 0) AS NROTC_UNIT, 
 COALESCE(I_AND_I_STATE, SPACE(0)) AS I_AND_I_STATE,  
 COALESCE(I_AND_I_CITY, SPACE(0)) AS I_AND_I_CITY, 
 COALESCE(DISCHARGE_CODE, SPACE(0)) AS DISCHARGE_CODE, 
 COALESCE(CONVERT(VARCHAR(11), DISCHARGE_DATE, 106), SPACE(0)) AS DISCHARGE_DATE, 
 COALESCE(LEAVE_OF_ABSENCE_REASON, 0) AS LEAVE_OF_ABSENCE_REASON,  
 COALESCE(CONVERT(VARCHAR(11), LEAVE_OF_ABSENCE_DATE, 106), SPACE(0)) AS LEAVE_OF_ABSENCE_DATE, 
 COALESCE(PROGRAM_TYPE, 0) AS PROGRAM_TYPE, 
 COALESCE(RANK, SPACE(0)) AS RANK, 
 COALESCE(PRIMARY_MOS, SPACE(0)) AS PRIMARY_MOS, 
 COALESCE(PRIMARY_MOS_DESCRIPTION, SPACE(0)) AS PRIMARY_MOS_DESCRIPTION, 
 COALESCE(BILLET_MOS, SPACE(0)) AS BILLET_MOS, 
 COALESCE(BILLET_MOS_DESCRIPTION, SPACE(0)) AS BILLET_MOS_DESCRIPTION, 
 COALESCE(CONVERT(VARCHAR(11), PROGRAM_BEGIN_DATE, 106), SPACE(0)) AS PROGRAM_BEGIN_DATE, 
 COALESCE(CONVERT(VARCHAR(11), PROGRAM_GRAD_DATE, 106), SPACE(0)) AS PROGRAM_GRAD_DATE, 
 COALESCE(ADVANCED_PROGRAM, SPACE(0)) AS ADVANCED_PROGRAM, 
 COALESCE(ADVANCED_PROGRAM_DESCRIPTION, SPACE(0)) AS ADVANCED_PROGRAM_DESCRIPTION, 
 @PriorServiceHistoryPresent AS PRIOR_SERVICE_HISTORY_PRESENT_BIT  
FROM  
 #CONTRACT 
 
--- CLEAN UP 
DROP TABLE #CONTRACT  
SET NOCOUNT OFF]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>