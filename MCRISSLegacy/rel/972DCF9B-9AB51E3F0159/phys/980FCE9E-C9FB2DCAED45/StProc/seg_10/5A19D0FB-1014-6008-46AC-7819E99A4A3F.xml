<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetSixWeekShipView]" directorySegmentName="seg_10" id="5A19D0FB-1014-6008-46AC-7819E99A4A3F">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:49 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@Star.ngRow int, 
 @PageSize int, 
 @OrgID int, 
 @ScheduledShipDate date.me = NULL, 
 @SortBy int 
AS 
 
SET NOCOUNT ON  
 
--This will return one more row that they asked for so that they know if there is another page of data. 
DECLARE @LastRow int 
SET @LastRow = @Star.ngRow + @PageSize; 
 
DECLARE  
 @StartDate date,  
 @EndDate date 
 
SET @StartDate = @ScheduledShipDate 
SET @EndDate = DATEADD(DAY, 42, @StartDate) 
 
CREATE TABLE #Sor.ngTable_SixWeekShipView  
( 
 RowNumber int not null,  
 PERSON_ID INT,  
 NWA_ID INT,  
 CONTRACT_ID INT,  
 POOLEE_NAME VARCHAR(60),  
 SSN CHAR(9),  
 PADD DATETIME,  
 DATE_OF_ENLISTMENT DATETIME,  
 MEPS_CONTRACT_DATE DATETIME, 
 GENDER_CODE CHAR(1),  
 COMPONENT_CODE VARCHAR(2),  
 COMPONENT_DESCRIPTION VARCHAR(50),  
 RSS VARCHAR(15),  
 AFQT_SCORE int NULL,  
 EDUCATION_LEVEL VARCHAR(2) NULL,  
 EDUCATION_CODE CHAR(1) NULL,  
 IST_DATE DATETIME NULL,  
 IST_PULL_UPS INT NULL,  
 IST_PUSH_UPS INT NULL,  
 IST_HANG INT NULL,  
 IST_CRUNCHES INT NULL,  
 IST_MINUTES INT NULL,  
 IST_SECONDS INT NULL,  
 IST_HEIGHT INT NULL,  
 IST_WEIGHT INT NULL,  
 IST_RESULT VARCHAR(1) NULL,  
 PROGRAM_MOS_CODE VARCHAR(25) NULL,  
 COMMENTS TEXT NULL,  
 MISSING_DOCS VARCHAR(250) NULL,  
 PENDING_EDUCATION CHAR(1) NOT NULL DEFAULT SPACE(0),  
 EDUCATION_LEVEL_INVALID CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_WAIVER CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_DEPENDENT CHAR(1) NOT NULL DEFAULT SPACE(0),  
 IST_NOT_COMPLETE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 RESERVIST_WITHOUT_QSN CHAR(1) NOT NULL DEFAULT SPACE(0), 
 BIQ BIT NULL DEFAULT(0), 
 NWAID uniqueiden..er, 
 PRESHIPRECIEVED_DATE DATETIME NULL, 
 PENDING_PRESHIP CHAR(1) NOT NULL DEFAULT SPACE(0) 
 
) 
 
CREATE TABLE #Grid_SixWeekShipView ( 
 RowNumber int not null,  
 PERSON_ID INT,  
 NWA_ID INT,  
 CONTRACT_ID INT,  
 POOLEE_NAME VARCHAR(60),  
 SSN CHAR(9),  
 PADD DATETIME,  
 DATE_OF_ENLISTMENT DATETIME,  
 MEPS_CONTRACT_DATE DATETIME, 
 GENDER_CODE CHAR(1),  
 COMPONENT_CODE VARCHAR(2),  
 COMPONENT_DESCRIPTION VARCHAR(50),  
 RSS VARCHAR(15),  
 AFQT_SCORE int NULL,  
 EDUCATION_LEVEL VARCHAR(2) NULL,  
 EDUCATION_CODE CHAR(1) NULL,  
 IST_DATE DATETIME NULL,  
 IST_PULL_UPS INT NULL,  
 IST_PUSH_UPS INT NULL,  
 IST_HANG INT NULL,  
 IST_CRUNCHES INT NULL,  
 IST_MINUTES INT NULL,  
 IST_SECONDS INT NULL,  
 IST_HEIGHT INT NULL,  
 IST_WEIGHT INT NULL,  
 IST_RESULT VARCHAR(1) NULL,  
 PROGRAM_MOS_CODE VARCHAR(25) NULL,  
 COMMENTS TEXT NULL,  
 MISSING_DOCS VARCHAR(250) NULL,  
 PENDING_EDUCATION CHAR(1) NOT NULL DEFAULT SPACE(0),  
 EDUCATION_LEVEL_INVALID CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_WAIVER CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_DEPENDENT CHAR(1) NOT NULL DEFAULT SPACE(0),  
 IST_NOT_COMPLETE CHAR(1) NOT NULL DEFAULT SPACE(0),  
 RESERVIST_WITHOUT_QSN CHAR(1) NOT NULL DEFAULT SPACE(0), 
 BIQ BIT NULL DEFAULT(0), 
 NWAID uniqueiden..er, 
 PRESHIPRECIEVED_DATE DATETIME NULL, 
 PENDING_PRESHIP CHAR(1) NOT NULL DEFAULT SPACE(0),) 
  
INSERT INTO #Sor.ngTable_SixWeekShipView  
 (RowNumber, PERSON_ID, NWA_ID, CONTRACT_ID, POOLEE_NAME, SSN, PADD, DATE_OF_ENLISTMENT, MEPS_CONTRACT_DATE, GENDER_CODE, COMPONENT_CODE, COMPONENT_DESCRIPTION, RSS, MISSING_DOCS,  
 IST_DATE, IST_PULL_UPS, IST_PUSH_UPS, IST_HANG, IST_CRUNCHES, IST_MINUTES, IST_SECONDS, IST_HEIGHT, IST_WEIGHT, IST_RESULT, AFQT_SCORE, NWAID, PRESHIPRECIEVED_DATE) 
SELECT 
 ROW_NUMBER() OVER( 
 Order By  
 CASE @SortBy 
  WHEN 1 THEN  CONVERT(CHAR(11), C.PROJECTED_SHIP_DATE, 102)   
  WHEN 2 THEN  P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) 
  WHEN 3 THEN  MC.GENDER_CODE 
  WHEN 4 THEN  CONVERT(CHAR(11), mi.CONTRACT_BEGIN_DATE, 102)  
  WHEN 5 THEN  C.COMPONENT_CODE 
  WHEN 6 THEN  RSS.SHORT_NAME 
  ELSE P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) 
  END 
 ), 
 P.PERSON_ID,  
 N.NWA_ID,  
 C.CONTRACT_ID,  
 P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) AS POOLEE_NAME,  
 P.SOCIAL_SECURITY_NUMBER,  
 case when EXISTS (SELECT PROJECTED_SHIP_DATE FROM MCRISS.dbo.CONTRACT WHERE NWA_ID = n.NWA_ID) then CONVERT(VARCHAR(11), c.PROJECTED_SHIP_DATE, 106) else CONVERT(VARCHAR(11), mi.PROJECTED_SHIP_DATE, 106) end AS PADD,  
 CONVERT(VARCHAR(11), C.CONTRACT_BEGIN_DATE, 106) AS DATE_OF_ENLISTMENT,  
 CONVERT(VARCHAR(11), mi.CONTRACT_BEGIN_DATE, 106) AS MEPS_CONTRACT_DATE,  
 MC.GENDER_CODE AS GENDER_CODE,  
 C.COMPONENT_CODE,  
 CC.COMPONENT_DESCRIPTION,  
 RSS.SHORT_NAME AS RSS,  
 COALESCE(C.MISSING_DOCS, SPACE(0)) AS MISSING_DOCS,  
 C.IST_DATE,  
 C.IST_PULL_UPS,  
 C.IST_PUSH_UPS,  
 C.IST_HANG,  
 C.IST_CRUNCHES,  
 C.IST_MINUTES,  
 C.IST_SECONDS,  
 C.IST_HEIGHT,  
 C.IST_WEIGHT,  
 C.IST_RESULT, 
 CA.AFQT_SCORE, 
 N.rowguid, 
 C.PreShipRecievedDate 
FROM 
 NWA N WITH (NOLOCK) 
 INNER JOIN MIContract mi ON mi.nwa_id = N.NWA_ID 
 INNER JOIN RECRUITING_ORGANIZATION RSS ON (N.ORGANIZATION_OF_RECORD_ID = RSS.ORGANIZATION_ID AND RSS.ORGANIZATION_TYPE = 'RSS') 
 INNER JOIN PERSON P ON N.MARINE_CANDIDATE_ID = P.PERSON_ID 
 INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
  
 INNER JOIN CANDIDATE_ASVAB CA  
  ON (N.MARINE_CANDIDATE_ID = CA.MARINE_CANDIDATE_ID  
   AND CA.ASVAB_DATE = ( SELECT MAX(ASVAB_DATE) FROM CANDIDATE_ASVAB WHERE MARINE_CANDIDATE_ID = CA.MARINE_CANDIDATE_ID ) )  
 INNER JOIN [USMC].[vwRecrui.ngOrgIDs] vw ON n.ORGANIZATION_OF_RECORD_ID = vw.root 
 LEFT JOIN CONTRACT C ON C.NWA_ID = N.NWA_ID  
 INNER JOIN COMPONENT_CODE CC ON C.COMPONENT_CODE = CC.COMPONENT_CODE 
 WHERE  
 NOT EXISTS (SELECT 1 FROM SHIPPER S WHERE S.CONTRACT_ID = C.CONTRACT_ID) AND 
 (vw.RS = @OrgID OR vw.RSS = @OrgID OR vw.District = @OrgID OR vw.Region = @OrgID OR vw.HQ = @OrgID)  
 AND 
  
 ( 
  (c.PROJECTED_SHIP_DATE BETWEEN @StartDate AND @EndDate AND C.DISCHARGE_CODE IS NULL ) 
 OR 
 ( 
 NOT EXISTS (SELECT CONTRACT_ID FROM MCRISS.dbo.CONTRACT WHERE NWA_ID = n.NWA_ID) and 
   (mi.PROJECTED_SHIP_DATE BETWEEN @StartDate AND @EndDate ) 
  ) 
 ) 
 
 
 
INSERT INTO #Grid_SixWeekShipView 
SELECT *  
FROM #Sor.ngTable_SixWeekShipView 
WHERE RowNumber >= @star.ngRow AND RowNumber <= @LastRow 
  
--- GET EDUCATION DATA 
UPDATE 
 #Grid_SixWeekShipView  
SET  
 EDUCATION_LEVEL = CE.EDUCATION_LEVEL,  
 EDUCATION_CODE  = CE.EDUCATION_CODE 
FROM  
  #Grid_SixWeekShipView G INNER JOIN CANDIDATE_EDUCATION CE ON  
  (G.PERSON_ID = CE.MARINE_CANDIDATE_ID AND  
  CE.SCHOOL_END_DATE = dbo.GetMaxSchoolEndDate(CE.MARINE_CANDIDATE_ID))  
  
--- GET ASVAB DATA 
UPDATE 
 #Grid_SixWeekShipView  
SET  
 AFQT_SCORE = CA.AFQT_SCORE 
FROM  
  #Grid_SixWeekShipView G  
  INNER JOIN CANDIDATE_ASVAB CA ON (G.PERSON_ID = CA.MARINE_CANDIDATE_ID AND CA.ASVAB_DATE = dbo.GetMaxASVABDate(CA.MARINE_CANDIDATE_ID)) 
  
--- GET PROGRAM_MOS_CODE DATA 
 SELECT 
 G.CONTRACT_ID,   
 PG.PROGRAM_CODE,  
 PG.PROGRAM_TYPE, 
 PA.PROGRAM_ASSIGNMENT_DATE,  
 ISNULL(C.DUTY_PREFERENCE1, '00') AS DUTY_PREFERENCE1, 
 
 CASE  
   WHEN PG.PROGRAM_TYPE='EOP' OR 
        PG.PROGRAM_TYPE='MEOP' OR 
     PG.PROGRAM_TYPE='PRA' OR 
     PG.PROGRAM_TYPE='QEP' OR 
     PG.PROGRAM_TYPE='GOP' THEN LEFT(CAST(PROGRAM_CODE AS varchar(4)) + '00000' ,5) 
 ELSE 
  '00000' 
 END + '-' + 
 
 CASE  
   WHEN PG.PROGRAM_TYPE='EBP' THEN RIGHT('000' + CAST(PROGRAM_CODE AS varchar(4)), 3) 
 ELSE 
  '000' 
 END + '-' + 
 
 CASE  
   WHEN PG.PROGRAM_TYPE='MCCF' OR 
        PG.PROGRAM_TYPE='CEP' THEN RIGHT('000' + CAST(PROGRAM_CODE AS varchar(4)), 3) 
 ELSE 
  '000' 
 END  + '-' + 
 
 CASE  
   WHEN PG.PROGRAM_TYPE='QEP' OR 
        PG.PROGRAM_TYPE='GOP' OR 
        PG.PROGRAM_TYPE='CEP' THEN SUBSTRING(ISNULL(C.DUTY_PREFERENCE1, '00'), 3, LEN(DUTY_PREFERENCE1)-2)  
 ELSE 
  '00' 
 END + '-' + 
 ISNULL(CONVERT(varchar(8), PA.PROGRAM_ASSIGNMENT_DATE, 112), '19000101') AS PROGRAM_MOS_CODE 
INTO #ContractProgram  
FROM   
 MCRISS.dbo.PROGRAM_AVAILABILITY PA  
 INNER JOIN #Grid_SixWeekShipView G ON G.CONTRACT_ID = PA.CONTRACT_ID 
 INNER JOIN MCRISS.dbo.CONTRACT C ON PA.CONTRACT_ID = C.CONTRACT_ID 
 INNER JOIN MCRISS.dbo.PROGRAM PG ON PA.PROGRAM_ID = PG.PROGRAM_ID  
 
UPDATE 
 #Grid_SixWeekShipView  
SET  
 PROGRAM_MOS_CODE = COALESCE(C.PROGRAM_MOS_CODE, CASE WHEN G.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN SPACE(0) ELSE '00000-000-000-00-' END) 
FROM  
 #Grid_SixWeekShipView G LEFT OUTER JOIN #ContractProgram C ON G.CONTRACT_ID = C.CONTRACT_ID 
 
UPDATE 
 #Grid_SixWeekShipView  
SET  
 PROGRAM_MOS_CODE = C.QSN_ID + '/' + C.MOS 
FROM  
 #Grid_SixWeekShipView G INNER JOIN MCRISS.dbo.QSN  C ON G.CONTRACT_ID = C.CONTRACT_ID 
 
--- GET COMMENTS  
UPDATE 
 #Grid_SixWeekShipView  
SET  
 COMMENTS = C.COMMENT 
FROM 
  #Grid_SixWeekShipView G INNER JOIN CANDIDATE_COMMENT C ON  
  (G.PERSON_ID = C.MARINE_CANDIDATE_ID AND  
  C.COMMENT_ID = (SELECT MAX(C1.COMMENT_ID) FROM CANDIDATE_COMMENT C1 WHERE C1.MARINE_CANDIDATE_ID = C.MARINE_CANDIDATE_ID)) 
 
--- UPDATE SHIPPER PROBLEM DATA 
UPDATE 
 #Grid_SixWeekShipView  
SET  
 PENDING_EDUCATION  = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_EDUCATION CE WHERE CE.MARINE_CANDIDATE_ID = G.PERSON_ID AND COALESCE(CE.VERIFICATION, 'PENDING') = 'PENDING')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 PENDING_WAIVER   = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_WAIVER CW WHERE CW.NWA_ID = G.NWA_ID AND COALESCE(CW.WAIVER_STATUS_CODE, 'P') = 'P')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 PENDING_DEPENDENT  = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_DEPENDENT CD WHERE CD.MARINE_CANDIDATE_ID = G.PERSON_ID AND COALESCE(CD.VERIFICATION, 'P') = 'P')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 RESERVIST_WITHOUT_QSN  = CASE  
     WHEN G.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') AND NOT EXISTS (SELECT 1 FROM QSN Q WHERE Q.CONTRACT_ID = G.CONTRACT_ID) 
     THEN 'Y' 
     ELSE SPACE(0) 
     END, 
 IST_NOT_COMPLETE  = CASE  
     WHEN  (COALESCE(G.IST_RESULT, 'N') = 'N' OR G.IST_DATE IS NULL OR G.IST_CRUNCHES IS NULL OR G.IST_MINUTES IS NULL OR G.IST_SECONDS IS NULL OR  
      (G.GENDER_CODE = 'M' AND (G.IST_PULL_UPS IS NULL AND G.IST_PUSH_UPS IS NULL)) OR  
      (G.GENDER_CODE = 'F' AND (G.IST_PULL_UPS IS NULL AND G.IST_PUSH_UPS IS NULL) AND G.IST_HANG IS NULL )) 
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 EDUCATION_LEVEL_INVALID = CASE  
     WHEN COALESCE((SELECT E.ELIGIBLE_TO_SHIP FROM EDUCATION_LEVEL_CODE E WHERE E.EDUCATION_LEVEL_CODE = G.EDUCATION_LEVEL AND E.EDUCATION_CODE = G.EDUCATION_CODE), 'N') = 'N'  
     THEN 'Y'  
     ELSE SPACE(0) 
     END, 
 PENDING_PRESHIP = CASE  
     WHEN G.PRESHIPRECIEVED_DATE IS NULL --COALESCE((SELECT E.ELIGIBLE_TO_SHIP FROM EDUCATION_LEVEL_CODE E WHERE E.EDUCATION_LEVEL_CODE = G.EDUCATION_LEVEL AND E.EDUCATION_CODE = G.EDUCATION_CODE), 'N') = 'N'  
     THEN 'Y'  
     ELSE SPACE(0) 
     END 
        
FROM  
 #Grid_SixWeekShipView G  
 
UPDATE GSSV 
SET GSSV.BIQ = 1 
FROM #Grid_SixWeekShipView GSSV 
INNER JOIN USMC.BIQ_QUESTIONNAIRE BQ ON GSSV.PERSON_ID = BQ.MARINE_CANDIDATE_ID 
INNER JOIN USMC.BIQ_QUESTIONNAIRE_HISTORY BQH ON BQ.ID = BQH.QUESTIONNAIRE_ID  
            AND BQH.[TYPE] = 3 
            AND BQH.DATE IN ( SELECT MAX(BQH2.DATE) 
                 FROM USMC.BIQ_QUESTIONNAIRE_HISTORY BQH2 
                 WHERE BQH.QUESTIONNAIRE_ID = BQH2.QUESTIONNAIRE_ID) 
 
--- RETURN DATA 
SELECT  
 RowNumber, PERSON_ID, NWA_ID, CONTRACT_ID, POOLEE_NAME, SSN,  
 CONVERT(VARCHAR(11), PADD, 106) AS PADD,  
 CONVERT(VARCHAR(11), DATE_OF_ENLISTMENT, 106) AS DATE_OF_ENLISTMENT,  
 CONVERT(VARCHAR(11), MEPS_CONTRACT_DATE, 106) AS MEPS_CONTRACT_DATE,  
 GENDER_CODE,  
 COMPONENT_CODE,  
 COMPONENT_DESCRIPTION,  
 RSS,  
 AFQT_SCORE,  
 COALESCE(EDUCATION_LEVEL, SPACE(0)) AS EDUCATION_LEVEL,  
 COALESCE(EDUCATION_CODE, SPACE(0)) AS EDUCATION_CODE,  
 COALESCE(CONVERT(VARCHAR(11), IST_DATE, 106), SPACE(0)) AS IST_DATE,  
 COALESCE(IST_PULL_UPS, 0) AS IST_PULLUPS,  
 COALESCE(IST_PUSH_UPS, 0) AS IST_PUSHUPS,  
 COALESCE(IST_HANG, 0) AS IST_HANG,  
 COALESCE(IST_CRUNCHES, 0) AS IST_CRUNCHES,  
 COALESCE(IST_MINUTES, 0) AS IST_MINUTES,  
 COALESCE(IST_SECONDS, 0) AS IST_SECONDS,  
 COALESCE(IST_RESULT, SPACE(0)) AS IST_RESULT,  
 PROGRAM_MOS_CODE,  
 COALESCE(COMMENTS, SPACE(0)) AS COMMENTS,  
 MISSING_DOCS,  
 PENDING_EDUCATION,  
 PENDING_WAIVER,  
 PENDING_DEPENDENT,  
 RESERVIST_WITHOUT_QSN, 
 IST_NOT_COMPLETE,  
 EDUCATION_LEVEL_INVALID,  
 DATE_OF_ENLISTMENT AS DATE_OF_ENLISTMENT_SORT,  
 PADD AS PADD_SORT, 
 BIQ, 
 NWAID, 
 PRESHIPRECIEVED_DATE, 
 PENDING_PRESHIP 
FROM  
 #Grid_SixWeekShipView 
ORDER BY RowNumber 
  
SELECT 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView) AS Total, 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView WHERE COMPONENT_CODE = 'K5' AND GENDER_CODE = 'M') AS RegularMales, 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView WHERE COMPONENT_CODE = 'K5' AND GENDER_CODE = 'F') AS RegularFemales, 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView WHERE COMPONENT_CODE IN ('B5', 'K4', 'K8', 'K9') AND GENDER_CODE = 'M') AS ReserveMales, 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView WHERE COMPONENT_CODE IN ('B5', 'K4', 'K8', 'K9') AND GENDER_CODE = 'F') AS ReserveFemales, 
 (SELECT COUNT(*) FROM #Sor.ngTable_SixWeekShipView WHERE AFQT_SCORE >=50 AND COMPONENT_CODE = 'K5' AND GENDER_CODE = 'M') AS AlpahRegularMales 
 
DROP TABLE #ContractProgram 
 
DROP TABLE #Grid_SixWeekShipView 
DROP TABLE #Sor.ngTable_SixWeekShipView 
SET NOCOUNT OFF]]></body>
<schema>E9C4E37D-78A2-31F9-D580-7C2848ACFCB7</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>