<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetEnlistedShipSchedule]" directorySegmentName="seg_17" id="C2F799CF-70CE-506E-70C1-AF8E0EF29FC3">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@OrgID    int, 
 @ScheduledShipDate  date.me = NULL 
AS 
 
SET NOCOUNT ON  
 
SET @ScheduledShipDate = COALESCE(@ScheduledShipDate, GETDATE()) 
 
CREATE TABLE #SHIP_SCHEDULE  
 (PERSON_ID INT, NWA_ID INT, CONTRACT_ID INT, POOLEE_NAME VARCHAR(60), SSN CHAR(9), PADD DATETIME, DATE_OF_ENLISTMENT DATETIME,  
 GENDER CHAR(1), COMPONENT_CODE VARCHAR(2), COMPONENT_DESCRIPTION VARCHAR(50), RSS VARCHAR(15), AFQT VARCHAR(2) NOT NULL DEFAULT SPACE(0),  
 EDUCATION_LEVEL VARCHAR(2) NULL, EDUCATION_CODE CHAR(1) NULL,  
 IST_DATE DATETIME NULL, IST_PULL_UPS INT NULL, IST_HANG INT NULL, IST_CRUNCHES INT NULL, IST_MINUTES INT NULL,  
 IST_SECONDS INT NULL, IST_HEIGHT INT NULL, IST_WEIGHT INT NULL, IST_RESULT VARCHAR(1) NULL,  
 PROGRAM_MOS_CODE VARCHAR(25) NULL, COMMENTS VARCHAR(250) NULL, MISSING_DOCS VARCHAR(250) NULL,  
 PENDING_EDUCATION CHAR(1) NOT NULL DEFAULT SPACE(0), EDUCATION_LEVEL_INVALID CHAR(1) NOT NULL DEFAULT SPACE(0),  
 PENDING_WAIVER CHAR(1) NOT NULL DEFAULT SPACE(0), PENDING_DEPENDENT CHAR(1) NOT NULL DEFAULT SPACE(0),  
 IST_NOT_COMPLETE CHAR(1) NOT NULL DEFAULT SPACE(0), RESERVIST_WITHOUT_QSN CHAR(1) NOT NULL DEFAULT SPACE(0)) 
 
--- GET POOLEES SCHEDULED TO SHIP IN THE SPECIFIED DATE RANGE 
INSERT INTO #SHIP_SCHEDULE  
 (PERSON_ID, NWA_ID, CONTRACT_ID, POOLEE_NAME, SSN, PADD, DATE_OF_ENLISTMENT, GENDER, COMPONENT_CODE, COMPONENT_DESCRIPTION, RSS, MISSING_DOCS,  
 IST_DATE, IST_PULL_UPS, IST_HANG, IST_CRUNCHES, IST_MINUTES, IST_SECONDS, IST_HEIGHT, IST_WEIGHT, IST_RESULT) 
SELECT 
 P.PERSON_ID, N.NWA_ID, C.CONTRACT_ID,  
 P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) AS POOLEE_NAME,  
 P.SOCIAL_SECURITY_NUMBER,  
 CONVERT(VARCHAR(11), C.PROJECTED_SHIP_DATE, 106) AS PADD,  
 CONVERT(VARCHAR(11), C.CONTRACT_BEGIN_DATE, 106) AS DATE_OF_ENLISTMENT,  
 MC.GENDER_CODE AS GENDER,  
 C.COMPONENT_CODE, CC.COMPONENT_DESCRIPTION,  
 RSS.SHORT_NAME AS RSS,  
 COALESCE(C.MISSING_DOCS, SPACE(0)) AS MISSING_DOCS,  
 C.IST_DATE, C.IST_PULL_UPS, C.IST_HANG, C.IST_CRUNCHES, C.IST_MINUTES,  
 C.IST_SECONDS, C.IST_HEIGHT, C.IST_WEIGHT, C.IST_RESULT 
FROM 
 CONTRACT C INNER JOIN NWA N ON  
  (C.NWA_ID = N.NWA_ID AND  
  DATEDIFF(DAY, @ScheduledShipDate, C.PROJECTED_SHIP_DATE) BETWEEN 0 AND 42 AND  
  C.DISCHARGE_CODE IS NULL AND  
  NOT EXISTS (SELECT 1 FROM SHIPPER S WHERE S.CONTRACT_ID = C.CONTRACT_ID))  
 INNER JOIN RECRUITING_ORGANIZATION RSS ON  
  (N.ORGANIZATION_OF_RECORD_ID = RSS.ORGANIZATION_ID AND  
  RSS.ORGANIZATION_TYPE = 'RSS') 
 INNER JOIN ORGANIZATION_MAP OM ON  
  (RSS.ORGANIZATION_ID = OM.CHILD_ORGANIZATION_ID AND  
  OM.PARENT_ORGANIZATION_ID = @OrgID) 
 INNER JOIN PERSON P ON N.MARINE_CANDIDATE_ID = P.PERSON_ID 
 INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN COMPONENT_CODE CC ON C.COMPONENT_CODE = CC.COMPONENT_CODE 
 
--- GET EDUCATION DATA 
UPDATE 
 #SHIP_SCHEDULE  
SET  
 EDUCATION_LEVEL = CE.EDUCATION_LEVEL,  
 EDUCATION_CODE  = CE.EDUCATION_CODE 
FROM  
 #SHIP_SCHEDULE S INNER JOIN CANDIDATE_EDUCATION CE ON  
  (S.PERSON_ID = CE.MARINE_CANDIDATE_ID AND  
  CE.SCHOOL_END_DATE = dbo.GetMaxSchoolEndDate(CE.MARINE_CANDIDATE_ID)) 
 
--- GET ASVAB DATA 
UPDATE 
 #SHIP_SCHEDULE  
SET  
 AFQT = CONVERT(VARCHAR(2), CA.AFQT_SCORE) 
FROM  
 #SHIP_SCHEDULE S INNER JOIN CANDIDATE_ASVAB CA ON  
  (S.PERSON_ID = CA.MARINE_CANDIDATE_ID AND  
  CA.ASVAB_DATE = dbo.GetMaxASVABDate(CA.MARINE_CANDIDATE_ID)) 
  
--- GET PROGRAM_MOS_CODE DATA 
UPDATE 
 #SHIP_SCHEDULE  
SET  
 PROGRAM_MOS_CODE = COALESCE(C.PROGRAM_MOS_CODE, CASE WHEN S.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') THEN SPACE(0) ELSE '00000-000-000-00-' END) 
FROM  
 #SHIP_SCHEDULE S LEFT OUTER JOIN PROGRAM_MOS_CODES C ON S.CONTRACT_ID = C.CONTRACT_ID 
 
--- GET COMMENTS  
UPDATE 
 #SHIP_SCHEDULE  
SET  
 COMMENTS = C.COMMENT 
FROM 
 #SHIP_SCHEDULE S INNER JOIN CANDIDATE_COMMENT C ON  
  (S.PERSON_ID = C.MARINE_CANDIDATE_ID AND  
  C.COMMENT_ID = (SELECT MAX(C1.COMMENT_ID) FROM CANDIDATE_COMMENT C1 WHERE C1.MARINE_CANDIDATE_ID = C.MARINE_CANDIDATE_ID)) 
 
--- UPDATE SHIPPER PROBLEM DATA 
UPDATE 
 #SHIP_SCHEDULE  
SET  
 PENDING_EDUCATION  = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_EDUCATION CE WHERE CE.MARINE_CANDIDATE_ID = S.PERSON_ID AND COALESCE(CE.VERIFICATION, 'PENDING') = 'PENDING')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 PENDING_WAIVER   = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_WAIVER CW WHERE CW.NWA_ID = S.NWA_ID AND COALESCE(CW.WAIVER_STATUS_CODE, 'P') = 'P')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 PENDING_DEPENDENT  = CASE 
     WHEN EXISTS (SELECT 1 FROM CANDIDATE_DEPENDENT CD WHERE CD.MARINE_CANDIDATE_ID = S.PERSON_ID AND COALESCE(CD.VERIFICATION, 'P') = 'P')  
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 RESERVIST_WITHOUT_QSN  = CASE  
     WHEN S.COMPONENT_CODE IN ('K4', 'K8', 'K9', 'B5') AND NOT EXISTS (SELECT 1 FROM QSN Q WHERE Q.CONTRACT_ID = S.CONTRACT_ID) 
     THEN 'Y' 
     ELSE SPACE(0) 
     END, 
 IST_NOT_COMPLETE  = CASE  
     WHEN  (COALESCE(S.IST_RESULT, 'N') = 'N' OR S.IST_DATE IS NULL OR S.IST_CRUNCHES IS NULL OR S.IST_MINUTES IS NULL OR S.IST_SECONDS IS NULL OR  
      (S.GENDER = 'M' AND S.IST_PULL_UPS IS NULL) OR (S.GENDER = 'F' AND S.IST_HANG IS NULL)) 
     THEN 'Y' 
     ELSE SPACE(0) 
     END,  
 EDUCATION_LEVEL_INVALID = CASE  
     WHEN COALESCE((SELECT E.ELIGIBLE_TO_SHIP FROM EDUCATION_LEVEL_CODE E WHERE E.EDUCATION_LEVEL_CODE = S.EDUCATION_LEVEL AND E.EDUCATION_CODE = S.EDUCATION_CODE), 'N') = 'N'  
     THEN 'Y'  
     ELSE SPACE(0) 
     END  
FROM  
 #SHIP_SCHEDULE S  
 
 
--- RETURN DATA 
SELECT  
 PERSON_ID, NWA_ID, CONTRACT_ID, POOLEE_NAME, SSN,  
 CONVERT(VARCHAR(11), PADD, 106) AS PADD,  
 CONVERT(VARCHAR(11), DATE_OF_ENLISTMENT, 106) AS DATE_OF_ENLISTMENT,  
 GENDER,  
 COMPONENT_CODE,  
 COMPONENT_DESCRIPTION,  
 RSS,  
 AFQT,  
 COALESCE(EDUCATION_LEVEL, SPACE(0)) AS EDUCATION_LEVEL,  
 COALESCE(EDUCATION_CODE, SPACE(0)) AS EDUCATION_CODE,  
 COALESCE(CONVERT(VARCHAR(11), IST_DATE, 106), SPACE(0)) AS IST_DATE,  
 COALESCE(IST_PULL_UPS, 0) AS IST_PULLUPS,  
 COALESCE(IST_HANG, 0) AS IST_HANG,  
 COALESCE(IST_CRUNCHES, 0) AS IST_CRUNCHES,  
 COALESCE(IST_MINUTES, 0) AS IST_MINUTES,  
 COALESCE(IST_SECONDS, 0) AS IST_SECONDS,  
 COALESCE(IST_RESULT, SPACE(0)) AS IST_RESULT,  
 PROGRAM_MOS_CODE,  
 COALESCE(COMMENTS, SPACE(0)) AS COMMENTS,  
 MISSING_DOCS,  
 PENDING_EDUCATION,  
 PENDING_WAIVER,  
 PENDING_DEPENDENT,  
 RESERVIST_WITHOUT_QSN, 
 IST_NOT_COMPLETE,  
 EDUCATION_LEVEL_INVALID,  
 DATE_OF_ENLISTMENT AS DATE_OF_ENLISTMENT_SORT,  
 PADD AS PADD_SORT 
FROM  
 #SHIP_SCHEDULE 
 
--- CLEAN UP 
DROP TABLE #SHIP_SCHEDULE 
SET NOCOUNT OFF]]></body>
<schema>DD6CF638-A2EB-2E1B-FF13-422CA718DE2D</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>