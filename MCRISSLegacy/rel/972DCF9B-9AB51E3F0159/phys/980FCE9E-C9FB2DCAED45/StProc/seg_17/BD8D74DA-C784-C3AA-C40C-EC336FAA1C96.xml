<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[sp_GetEnlistedMEPSViewOld]" directorySegmentName="seg_17" id="BD8D74DA-C784-C3AA-C40C-EC336FAA1C96">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:41 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@ScheduleDate  date.me, 
 @MEPS  int = NULL, 
 @SortBy  int = NULL  
AS 
 
SET NOCOUNT ON 
 
 
SELECT DISTINCT 
 P.PERSON_ID, NWA.NWA_ID, C.CONTRACT_ID, 
 PERSON_NAME = RTRIM(P.LAST_NAME) + SPACE(1) + RTRIM(P.FIRST_NAME) + SPACE(1) + ISNULL(P.LEGAL_MIDDLE_NAME,''), 
 MC.GENDER_CODE, RSS = RSS.NAME, 
 ED = CE.EDUCATION_LEVEL + CE.EDUCATION_CODE,  
 [QT/GT] = CONVERT(VARCHAR(4), CA.AFQT_SCORE) + '/' + CONVERT(VARCHAR(4), CA.GT_SCORE), 
 [MENTAL RESULT] =  CASE   
    WHEN MS.ASVAB = 'Y' THEN 'ASVAB' 
    WHEN MS.SPECIAL_EXAM = 'Y' THEN MS.SPECIAL_EXAM_TYPE 
    ELSE NULL 
    END, 
 
 CME.MEDICAL_EXAM_TYPE, MS.PROCESSING_NOTES,  
 PROCESSING_STATUS =  CASE MS.PROCESSING_STATUS 
     WHEN 'P' THEN 'PENDING' 
     WHEN 'S' THEN 'SHOW' 
     WHEN 'N' THEN 'NO SHOW' 
     WHEN 'M' THEN 'PROJECT TO MIRS'     
     ELSE MS.PROCESSING_STATUS 
     END, 
 P.SOCIAL_SECURITY_NUMBER, 
 CATEGORY_CODE = CASE NWA.CATEGORY_CODE   
    WHEN 'R' THEN 'Regular' 
    WHEN 'G' THEN 'Reserve-Ground' 
    WHEN 'A' THEN 'Reseve-Air' 
    WHEN 'P' THEN 'Prior-Service' 
    ELSE NULL 
      END, 
 NWA.PROJECTED_SHIP_MONTH, 
 [(QT/GT)DATE] = CONVERT(VARCHAR(11), CA.ASVAB_DATE,106), 
 [(DEP)RESULT] =  CASE MS.CONTRACT  
    WHEN 'Y' THEN 'YES' 
    ELSE 'NO' 
    END, 
 [(SHIP)RESULT] =  CASE MS.SHIP  
    WHEN 'Y' THEN 'YES' 
    ELSE 'NO' 
    END, 
 [HOTEL-TRANSP-LAST MEPS] = ISNULL(MS.LODGING_REQUIRED, '') + '-' + ISNULL(MS.TRANSPORTATION_REQUIRED, '') + '-' + 
  CASE  
   WHEN DATEDIFF(DAY, CME.MEDICAL_EXAM_DATE, CA.ASVAB_DATE) >= 0 
   THEN ISNULL((SELECT MOL.MEPS_NAME FROM MEPS_ORGANIZATION_LOOKUP MOL  
    WHERE MOL.MEPS_ORGANIZATION_ID = CA.MEPS_ORGANIZATION_ID), '') 
   ELSE ISNULL((SELECT MOL.MEPS_NAME FROM MEPS_ORGANIZATION_LOOKUP MOL  
    WHERE MOL.MEPS_ORGANIZATION_ID = CME.MEPS_ORGANIZATION_ID), '') 
  END, 
 SD.STATUS_DESCRIPTION, 
 SD.DISPOSITION_DESCRIPTION, 
 MS.SCHEDULE_ID, MS.MEPS_ORGANIZATION_ID,  
 RSS_ID = RSS.ORGANIZATION_ID, 
 RS = RS.NAME, 
 SORT_ORDER =  CASE @SortBy 
    WHEN 1 THEN RTRIM(P.LAST_NAME) + SPACE(1) + RTRIM(P.FIRST_NAME) + SPACE(1) + ISNULL(P.LEGAL_MIDDLE_NAME, '') 
    WHEN 2 THEN MS.PROCESSING_STATUS 
    WHEN 3 THEN MC.GENDER_CODE 
    WHEN 4 THEN RSS.NAME 
    WHEN 5 THEN SD.STATUS_DESCRIPTION + '/' + SD.DISPOSITION_DESCRIPTION 
    WHEN 6 THEN RS.NAME 
    ELSE RTRIM(P.LAST_NAME) + SPACE(1) + RTRIM(P.FIRST_NAME) + SPACE(1) + ISNULL(P.LEGAL_MIDDLE_NAME, '') 
          END  
FROM  
 PERSON P, MARINE_CANDIDATE MC, RECRUITING_ORGANIZATION RSS, 
 NWA, CONTRACT C, CANDIDATE_ASVAB CA, CANDIDATE_MEDICAL_EXAM CME, 
 MEPS_SCHEDULE MS, CANDIDATE_STATUS CS, STATUS_DISPOSITION SD, CANDIDATE_EDUCATION CE, 
 MEPS_ORGANIZATION_LOOKUP MOL, ORGANIZATION_MAP OM, RECRUITING_ORGANIZATION RS 
WHERE  
 P.PERSON_ID = MC.MARINE_CANDIDATE_ID 
 AND NWA.NWA_ID *= C.NWA_ID 
 AND P.PERSON_ID *= CME.MARINE_CANDIDATE_ID 
 AND CME.MEDICAL_EXAM_DATE = (SELECT MAX(MEDICAL_EXAM_DATE) FROM CANDIDATE_MEDICAL_EXAM CME2  
     WHERE CME2.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID) 
 AND P.PERSON_ID *= CA.MARINE_CANDIDATE_ID 
 AND CA.ASVAB_DATE = (SELECT MAX(ASVAB_DATE) FROM CANDIDATE_ASVAB CA2  
     WHERE CA2.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID) 
 AND P.PERSON_ID *= CE.MARINE_CANDIDATE_ID 
 AND MC.MARINE_CANDIDATE_ID = NWA.MARINE_CANDIDATE_ID 
 AND RSS.ORGANIZATION_ID = NWA.ORGANIZATION_OF_RECORD_ID 
 AND MS.NWA_ID = NWA.NWA_ID 
 AND MS.PROCESSING_DATE = @ScheduleDate 
 AND MS.MEPS_ORGANIZATION_ID = @MEPS 
 AND MS.DELETED != 'Y' 
 AND MS.MEPS_ORGANIZATION_ID = MOL.MEPS_ORGANIZATION_ID 
 AND CS.NWA_ID = NWA.NWA_ID 
 AND CS.STATUS_TYPE = SD.STATUS_TYPE 
 AND CS.STATUS_CODE = SD.STATUS_CODE 
 AND CS.DISPOSITION_CODE = SD.DISPOSITION_CODE 
 AND CE.UPDATE_DATE = (SELECT MAX(UPDATE_DATE) FROM CANDIDATE_EDUCATION 
    WHERE CANDIDATE_EDUCATION.MARINE_CANDIDATE_ID = P.PERSON_ID)     
 AND CS.CANDIDATE_STATUS_ID =  (SELECT MAX(CANDIDATE_STATUS_ID) FROM CANDIDATE_STATUS  
     WHERE CANDIDATE_STATUS.NWA_ID = NWA.NWA_ID AND  
     DATEDIFF(DAY, @ScheduleDate , STATUS_EFFECTIVE_DATE) <= 0) 
 AND RSS.ORGANIZATION_ID = OM.CHILD_ORGANIZATION_ID 
 AND OM.PARENT_ORGANIZATION_ID = RS.ORGANIZATION_ID 
ORDER BY 
 SORT_ORDER]]></body>
<schema>3925E19F-DC76-90A4-B892-D7A526C79632</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>