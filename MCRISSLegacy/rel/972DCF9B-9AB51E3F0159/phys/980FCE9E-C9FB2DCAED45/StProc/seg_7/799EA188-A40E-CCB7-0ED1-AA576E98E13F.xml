<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetO.cerMEPSView]" directorySegmentName="seg_7" id="799EA188-A40E-CCB7-0ED1-AA576E98E13F">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:48 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@Star.ngRow int, 
 @PageSize int, 
 @ScheduleDate date.me, 
 @MEPS  int, 
 @SortBy int 
  
AS 
 
--This will return one more row that they asked for so that they know if there is another page of data. 
DECLARE @LastRow int 
SET @LastRow = @star.ngRow + @PageSize 
 
SET NOCOUNT ON 
SET ANSI_WARNINGS OFF 
 
 
CREATE TABLE #MEPS_VIEW1  
 (PERSON_ID INT, NWA_ID INT, CONTRACT_ID INT, PERSON_NAME VARCHAR(62), SSN CHAR(9), OSS VARCHAR(45), GENDER CHAR(1), PROGRAM VARCHAR(50),  
 MAX_PROJECTED_COMPLETE_DATE DATETIME, MAX_CURRENT_EDUCATION_LEVEL VARCHAR(2), MAX_CURRENT_EDUCATION_CODE CHAR(1),  
 MAX_SCHOOL_END_DATE DATETIME, MAX_COMPLETED_EDUCATION_LEVEL VARCHAR(2), MAX_COMPLETED_EDUCATION_CODE CHAR(1), EDUCATION VARCHAR(5),  
 AFQT VARCHAR(4), MENTAL_RESULT CHAR(1),  
 MEPS_MEDICAL_EXAM_DATE DATETIME, MEPS_MEDICAL_RESULT VARCHAR(4), ANNUAL_PHYSICAL_DATE DATETIME, ANNUAL_PHYSICAL_RESULT VARCHAR(4), FLIGHT_PHYSICAL_DATE DATETIME, FLIGHT_PHYSICAL_RESULT VARCHAR(4), 
 MAX_MEDICAL_EXAM_TYPE CHAR(1), MAX_MEDICAL_EXAM_DATE DATETIME, MAX_MEDICAL_RESULT VARCHAR(4),  
 PROCESSING_STATUS_CODE CHAR(1), PROCESSING_STATUS VARCHAR(20), STATUS VARCHAR(40), DISPOSITION VARCHAR(40), [Type] char(40)) 
 
INSERT INTO #MEPS_VIEW1 
 (PERSON_ID, NWA_ID, CONTRACT_ID, PERSON_NAME, SSN, OSS,  
 GENDER, PROGRAM, AFQT, MENTAL_RESULT,  
 PROCESSING_STATUS_CODE, PROCESSING_STATUS, STATUS, DISPOSITION) 
SELECT 
 P.PERSON_ID, N.NWA_ID, C.CONTRACT_ID,  
 P.LAST_NAME + ', ' + P.FIRST_NAME + COALESCE(SPACE(1) + P.LEGAL_MIDDLE_NAME, SPACE(0)) AS APPLICANT_NAME, 
 P.SOCIAL_SECURITY_NUMBER AS SSN, 
 OSS.NAME AS OSS, 
 COALESCE(MC.GENDER_CODE, SPACE(0)) AS GENDER, 
 COALESCE(CC.COMPONENT_DESCRIPTION, SPACE(0)) AS PROGRAM, 
 COALESCE(CONVERT(VARCHAR(4), CA.AFQT_SCORE), SPACE(0)) AS AFQT, 
 CASE   
  WHEN MS.ASVAB = 'Y' THEN 'ASVAB' 
  WHEN MS.SPECIAL_EXAM = 'Y' THEN MS.SPECIAL_EXAM_TYPE 
  ELSE SPACE(0) 
 END AS MENTAL_RESULT, 
 COALESCE(MS.PROCESSING_STATUS, SPACE(0)) AS PROCESSING_STATUS_CODE, 
 COALESCE(PS.PROCESSING_STATUS_DESCRIPTION, SPACE(0)) AS PROCESSING_STATUS, 
 SD.STATUS_DESCRIPTION AS STATUS, 
 SD.DISPOSITION_DESCRIPTION AS DISPOSITION 
FROM 
 MEPS_SCHEDULE MS WITH (NOLOCK) INNER JOIN PROCESSING_STATUS PS ON  
  (MS.PROCESSING_STATUS = PS.PROCESSING_STATUS_CODE AND 
  MS.MEPS_ORGANIZATION_ID = @MEPS AND  
  MS.PROCESSING_DATE = @ScheduleDate) 
 INNER JOIN NWA N ON MS.NWA_ID = N.NWA_ID 
 INNER JOIN CANDIDATE_STATUS CS ON  
  (N.NWA_ID = CS.NWA_ID AND 
  CS.STATUS_TYPE = 'O' AND 
  CS.CANDIDATE_STATUS_ID = dbo.GetMaxStatusID(CS.NWA_ID)) 
 INNER JOIN STATUS_DISPOSITION SD ON  
  (CS.STATUS_TYPE = SD.STATUS_TYPE AND 
  CS.STATUS_CODE = SD.STATUS_CODE AND 
  CS.DISPOSITION_CODE = SD.DISPOSITION_CODE) 
 INNER JOIN MARINE_CANDIDATE MC ON N.MARINE_CANDIDATE_ID = MC.MARINE_CANDIDATE_ID 
 INNER JOIN PERSON P ON MC.MARINE_CANDIDATE_ID = P.PERSON_ID 
 INNER JOIN COMPONENT_CODE CC ON N.OFFICER_COMPONENT_CODE = CC.COMPONENT_CODE 
 INNER JOIN RECRUITING_ORGANIZATION OSS ON N.ORGANIZATION_OF_RECORD_ID = OSS.ORGANIZATION_ID 
 LEFT OUTER JOIN OFFICER_CONTRACT C ON N.NWA_ID = C.NWA_ID 
 LEFT OUTER JOIN CANDIDATE_ASVAB CA ON 
   (N.MARINE_CANDIDATE_ID = CA.MARINE_CANDIDATE_ID AND 
   CA.ASVAB_DATE = dbo.GetMaxASVABDate(CA.MARINE_CANDIDATE_ID)) 
 
-- Sort Data  
CREATE TABLE #MEPS_VIEW2  
 (RowNumber INT NULL, PERSON_ID INT, NWA_ID INT, CONTRACT_ID INT, PERSON_NAME VARCHAR(62), SSN CHAR(9), OSS VARCHAR(45), GENDER CHAR(1), PROGRAM VARCHAR(50),  
 MAX_PROJECTED_COMPLETE_DATE DATETIME, MAX_CURRENT_EDUCATION_LEVEL VARCHAR(2), MAX_CURRENT_EDUCATION_CODE CHAR(1),  
 MAX_SCHOOL_END_DATE DATETIME, MAX_COMPLETED_EDUCATION_LEVEL VARCHAR(2), MAX_COMPLETED_EDUCATION_CODE CHAR(1), EDUCATION VARCHAR(5),  
 AFQT VARCHAR(4), MENTAL_RESULT CHAR(1),  
 MEPS_MEDICAL_EXAM_DATE DATETIME, MEPS_MEDICAL_RESULT VARCHAR(4), ANNUAL_PHYSICAL_DATE DATETIME, ANNUAL_PHYSICAL_RESULT VARCHAR(4), FLIGHT_PHYSICAL_DATE DATETIME, FLIGHT_PHYSICAL_RESULT VARCHAR(4), 
 MAX_MEDICAL_EXAM_TYPE CHAR(1), MAX_MEDICAL_EXAM_DATE DATETIME, MAX_MEDICAL_RESULT VARCHAR(4),  
 PROCESSING_STATUS_CODE CHAR(1), PROCESSING_STATUS VARCHAR(20), STATUS VARCHAR(40), DISPOSITION VARCHAR(40), [Type] char(40))   
 
IF @SortBy = 1 
 INSERT INTO #MEPS_VIEW2 
 SELECT ROW_NUMBER() OVER(Order By v1.DISPOSITION), v1.* 
 FROM #MEPS_VIEW1  v1  
 ORDER BY v1.DISPOSITION  
 
IF @SortBy = 2 
 INSERT INTO #MEPS_VIEW2 
 SELECT ROW_NUMBER() OVER(Order By v1.PERSON_NAME), v1.* 
 FROM #MEPS_VIEW1  v1  
 ORDER BY v1.PERSON_NAME 
  
IF @SortBy = 3 
 INSERT INTO #MEPS_VIEW2 
 SELECT ROW_NUMBER() OVER(Order By v1.OSS), v1.* 
 FROM #MEPS_VIEW1  v1  
 ORDER BY v1.OSS  
  
IF @SortBy = 4 
 INSERT INTO #MEPS_VIEW2 
 SELECT ROW_NUMBER() OVER(Order By v1.GENDER), v1.* 
 FROM #MEPS_VIEW1  v1  
 ORDER BY v1.GENDER  
  
IF @SortBy = 5 
 INSERT INTO #MEPS_VIEW2 
 SELECT ROW_NUMBER() OVER(Order By v1.PROCESSING_STATUS), v1.* 
 FROM #MEPS_VIEW1  v1  
 ORDER BY v1.PROCESSING_STATUS  
       
 
-- Limit data to current page     
CREATE TABLE #MEPS_VIEW3  
 (RowNumber INT NULL, PERSON_ID INT, NWA_ID INT, CONTRACT_ID INT, PERSON_NAME VARCHAR(62), SSN CHAR(9), OSS VARCHAR(45), GENDER CHAR(1), PROGRAM VARCHAR(50),  
 MAX_PROJECTED_COMPLETE_DATE DATETIME, MAX_CURRENT_EDUCATION_LEVEL VARCHAR(2), MAX_CURRENT_EDUCATION_CODE CHAR(1),  
 MAX_SCHOOL_END_DATE DATETIME, MAX_COMPLETED_EDUCATION_LEVEL VARCHAR(2), MAX_COMPLETED_EDUCATION_CODE CHAR(1), EDUCATION VARCHAR(5),  
 AFQT VARCHAR(4), MENTAL_RESULT CHAR(1),  
 MEPS_MEDICAL_EXAM_DATE DATETIME, MEPS_MEDICAL_RESULT VARCHAR(4), ANNUAL_PHYSICAL_DATE DATETIME, ANNUAL_PHYSICAL_RESULT VARCHAR(4), FLIGHT_PHYSICAL_DATE DATETIME, FLIGHT_PHYSICAL_RESULT VARCHAR(4), 
 MAX_MEDICAL_EXAM_TYPE CHAR(1), MAX_MEDICAL_EXAM_DATE DATETIME, MAX_MEDICAL_RESULT VARCHAR(4),  
 PROCESSING_STATUS_CODE CHAR(1), PROCESSING_STATUS VARCHAR(20), STATUS VARCHAR(40), DISPOSITION VARCHAR(40), [Type] char(40))   
 
INSERT intO #MEPS_VIEW3 
SELECT * 
FROM #MEPS_VIEW2 
WHERE RowNumber >= @Star.ngRow AND RowNumber <= @LastRow 
 
  
--- MEPS MEDICAL DATA 
UPDATE  
 #MEPS_VIEW3 
SET 
 MEPS_MEDICAL_EXAM_DATE  = CME.MEDICAL_EXAM_DATE,  
 MEPS_MEDICAL_RESULT  = CASE CME.MEDICAL_DISPOSITION 
     WHEN 'Q' THEN 'QUAL' 
     WHEN 'D' THEN 'DQ' 
     ELSE SPACE(0) 
     END 
FROM 
 #MEPS_VIEW3 V INNER JOIN CANDIDATE_MEDICAL_EXAM CME ON 
  (V.PERSON_ID = CME.MARINE_CANDIDATE_ID AND 
  CME.MEDICAL_EXAM_TYPE = 'FULL' AND  
  CME.MEDICAL_EXAM_DATE = dbo.GetMaxMedicalExamDate(CME.MARINE_CANDIDATE_ID, CME.MEDICAL_EXAM_TYPE)) 
 
 
--- ANNUAL PHYSICAL DATA 
UPDATE  
 #MEPS_VIEW3 
SET 
 ANNUAL_PHYSICAL_DATE  = AP.EXAM_DATE,  
 ANNUAL_PHYSICAL_RESULT  = CASE D.MEDICAL_DISPOSITION_CODE 
     WHEN 'Q' THEN 'QUAL' 
     WHEN 'DQ' THEN 'DQ' 
     ELSE SPACE(0) 
     END 
FROM 
 #MEPS_VIEW3 V INNER JOIN ANNUAL_PHYSICAL AP ON 
  (V.PERSON_ID = AP.MARINE_CANDIDATE_ID AND 
  AP.EXAM_DATE = (SELECT MAX(AP1.EXAM_DATE) FROM ANNUAL_PHYSICAL AP1  
    WHERE AP1.MARINE_CANDIDATE_ID = AP.MARINE_CANDIDATE_ID)) 
 LEFT OUTER JOIN MEDICAL_DISPOSITION D ON AP.MEDICAL_DISPOSITION_ID = D.MEDICAL_DISPOSITION_ID 
 
--- FLIGHT PHYSICAL DATA 
UPDATE  
 #MEPS_VIEW3 
SET 
 FLIGHT_PHYSICAL_DATE   = FP.EXAM_DATE,  
 FLIGHT_PHYSICAL_RESULT = CASE D.MEDICAL_DISPOSITION_CODE 
     WHEN 'Q' THEN 'QUAL' 
     WHEN 'DQ' THEN 'DQ' 
     ELSE SPACE(0) 
     END 
FROM 
 #MEPS_VIEW3 V INNER JOIN FLIGHT_PHYSICAL FP ON 
  (V.PERSON_ID = FP.MARINE_CANDIDATE_ID AND 
  FP.EXAM_DATE = (SELECT MAX(FP1.EXAM_DATE) FROM FLIGHT_PHYSICAL FP1  
    WHERE FP1.MARINE_CANDIDATE_ID = FP.MARINE_CANDIDATE_ID)) 
 LEFT OUTER JOIN MEDICAL_DISPOSITION D ON FP.MEDICAL_DISPOSITION_ID = D.MEDICAL_DISPOSITION_ID 
 
 
--- DEFINE THE MAX MEDICAL TYPE 
UPDATE  
 #MEPS_VIEW3 
SET 
 MAX_MEDICAL_EXAM_TYPE = CASE (SELECT MAX(EXAM_DATE) FROM  
     ((SELECT MEPS_MEDICAL_EXAM_DATE AS EXAM_DATE FROM #MEPS_VIEW3 V1 WHERE V1.PERSON_ID = V.PERSON_ID) UNION 
     (SELECT ANNUAL_PHYSICAL_DATE FROM #MEPS_VIEW3 V1 WHERE V1.PERSON_ID = V.PERSON_ID) UNION 
     (SELECT FLIGHT_PHYSICAL_DATE FROM #MEPS_VIEW3 V1 WHERE V1.PERSON_ID = V.PERSON_ID)) AS MEDICAL_DATES) 
     WHEN MEPS_MEDICAL_EXAM_DATE THEN 'M' 
     WHEN ANNUAL_PHYSICAL_DATE THEN 'A' 
     WHEN FLIGHT_PHYSICAL_DATE  THEN 'F' 
     ELSE NULL 
     END 
FROM 
 #MEPS_VIEW3 V  
 
 
--- SET THE MAX MEDICAL DATE AND RESULT 
UPDATE  
 #MEPS_VIEW3 
SET 
 MAX_MEDICAL_EXAM_DATE  = CASE MAX_MEDICAL_EXAM_TYPE  
     WHEN 'M' THEN MEPS_MEDICAL_EXAM_DATE 
     WHEN 'A' THEN ANNUAL_PHYSICAL_DATE 
     WHEN 'F' THEN FLIGHT_PHYSICAL_DATE 
     ELSE NULL 
     END,  
 MAX_MEDICAL_RESULT  = CASE MAX_MEDICAL_EXAM_TYPE  
     WHEN 'M' THEN MEPS_MEDICAL_RESULT 
     WHEN 'A' THEN ANNUAL_PHYSICAL_RESULT 
     WHEN 'F' THEN FLIGHT_PHYSICAL_RESULT 
     ELSE NULL 
     END  
FROM 
 #MEPS_VIEW3 V  
 
 
--- COMPLETED EDUCATION DATA 
UPDATE 
 #MEPS_VIEW3 
SET 
 MAX_SCHOOL_END_DATE   = CE.SCHOOL_END_DATE, 
 MAX_COMPLETED_EDUCATION_LEVEL  = CE.EDUCATION_LEVEL, 
 MAX_COMPLETED_EDUCATION_CODE  = CE.EDUCATION_CODE 
FROM 
 #MEPS_VIEW3 V INNER JOIN CANDIDATE_EDUCATION CE ON  
  (V.PERSON_ID = CE.MARINE_CANDIDATE_ID AND 
  CE.SCHOOL_END_DATE = dbo.GetMaxSchoolEndDate(CE.MARINE_CANDIDATE_ID))  
 
--- CURRENT EDUCATION DATA 
UPDATE 
 #MEPS_VIEW3 
SET 
 MAX_PROJECTED_COMPLETE_DATE = CE.PROJECTED_COMPL_DATE, 
 MAX_CURRENT_EDUCATION_LEVEL = CE.EDUCATION_LEVEL, 
 MAX_CURRENT_EDUCATION_CODE  = CE.EDUCATION_CODE 
FROM 
 #MEPS_VIEW3 V INNER JOIN CANDIDATE_EDUCATION CE ON  
  (V.PERSON_ID = CE.MARINE_CANDIDATE_ID AND 
  CE.PROJECTED_COMPL_DATE = dbo.GetMaxSchoolProjectedCompleteDate(CE.MARINE_CANDIDATE_ID))  
 
 
--- UPDATE EDUCATION BASED ON THE GREATER OF THE PROJECTED COMPLETED AND SCHOOL END DATES 
UPDATE 
 #MEPS_VIEW3 
SET 
 EDUCATION = CASE  
   WHEN DATEDIFF(DAY, V.MAX_SCHOOL_END_DATE, V.MAX_PROJECTED_COMPLETE_DATE) > 0 THEN COALESCE(V.MAX_CURRENT_EDUCATION_LEVEL, SPACE(0)) + COALESCE(V.MAX_CURRENT_EDUCATION_CODE, SPACE(0)) 
   ELSE COALESCE(V.MAX_COMPLETED_EDUCATION_LEVEL, SPACE(0)) + COALESCE(V.MAX_COMPLETED_EDUCATION_CODE, SPACE(0)) 
   END 
FROM  
 #MEPS_VIEW3 V 
 
--- type 
UPDATE #MEPS_VIEW3 SET  
 [Type] = cns.STATUS_Type 
FROM #MEPS_VIEW3 mv 
 INNER JOIN vwCurrentNwaStatus cns on mv.NWA_ID = cns.NWA_ID 
 
 
--- RETURN DATA 
SELECT 
 PERSON_ID, NWA_ID, CONTRACT_ID, PERSON_NAME AS APPLICANT_NAME, SSN, OSS,  
 GENDER, PROGRAM,  
 COALESCE(EDUCATION, SPACE(0)) AS EDUCATION,  
 AFQT, MENTAL_RESULT,  
 MAX_MEDICAL_RESULT AS PHYSICAL_RESULT, 
 PROCESSING_STATUS_CODE, PROCESSING_STATUS, STATUS, DISPOSITION, TYPE 
FROM  
 #MEPS_VIEW3 
  
SELECT COUNT(*) AS TOTAL FROM #MEPS_VIEW3 
 
--- CLEAN UP 
DROP TABLE #MEPS_VIEW1  
DROP TABLE #MEPS_VIEW2 
DROP TABLE #MEPS_VIEW3 
SET NOCOUNT OFF 
SET ANSI_WARNINGS ON]]></body>
<schema>E9C4E37D-78A2-31F9-D580-7C2848ACFCB7</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>