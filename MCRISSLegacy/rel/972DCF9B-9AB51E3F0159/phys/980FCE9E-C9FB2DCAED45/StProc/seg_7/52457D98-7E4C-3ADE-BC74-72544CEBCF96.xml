<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[GetO.cerContractByNwaID]" directorySegmentName="seg_7" id="52457D98-7E4C-3ADE-BC74-72544CEBCF96">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:42 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[( 
 @NwaID int 
) 
AS  
 
SET NOCOUNT ON 
 
DECLARE @ContractID int 
SET @ContractID = (SELECT TOP 1 CONTRACT_ID FROM OFFICER_CONTRACT WITH (NOLOCK) WHERE NWA_ID = @NwaID) 
 
--- DECLARE DISPOSTION CONSTANTS FOR READABILITY 
DECLARE @DISPOSITION_SUBMITTED_TO_DISTRICT    varchar(2) 
DECLARE @DISPOSITION_DISTRICT_NON_SELECTED    varchar(2) 
DECLARE @DISPOSITION_DISTRICT_SELECTED    varchar(2) 
DECLARE @DISPOSITION_PENDING_ADDITIONAL_INFORMATION_DIST    varchar(2) 
DECLARE @DISPOSITION_WITHDRAWN_BY_DISTRICT                  varchar(2) 
DECLARE @DISPOSITION_SUBMITTED_TO_REGION                    varchar(2) 
DECLARE @DISPOSITION_PENDING_ADDITIONAL_INFORMATION_REGION  varchar(2) 
DECLARE @DISPOSITION_REGION_NON_SELECTED                         varchar(2) 
DECLARE @DISPOSITION_REGION_SELECTED                             varchar(2) 
DECLARE @DISPOSITION_WITHDRAWN_BY_REGION                         varchar(2) 
DECLARE @DISPOSITION_DISENROLLED_BY_REGION                       varchar(2) 
DECLARE @DISPOSITION_MCRC_APPROVED                               varchar(2) 
DECLARE @DISPOSITION_MCRC_DISAPPROVED                            varchar(2) 
DECLARE @DISPOSITION_WITHDRAWN_BY_MCRC                           varchar(2) 
DECLARE @DISPOSITION_DISENROLLED_BY_MCRC                         varchar(2) 
 
 
SELECT --- mailed to district 
 @DISPOSITION_SUBMITTED_TO_DISTRICT                      = 'R', 
 --- district ac.on 
 @DISPOSITION_DISTRICT_NON_SELECTED                      = 'T', 
 @DISPOSITION_DISTRICT_SELECTED  = 'W', 
 @DISPOSITION_PENDING_ADDITIONAL_INFORMATION_DIST        = 'AI', 
 @DISPOSITION_WITHDRAWN_BY_DISTRICT                      = 'BA', 
 @DISPOSITION_SUBMITTED_TO_REGION                        = 'AS',  
 --- region ac.on 
 @DISPOSITION_PENDING_ADDITIONAL_INFORMATION_REGION      = 'AT', 
 @DISPOSITION_REGION_NON_SELECTED                        = 'Z', 
 @DISPOSITION_REGION_SELECTED                            = 'AU', 
 @DISPOSITION_WITHDRAWN_BY_REGION                        = 'AV', 
 @DISPOSITION_DISENROLLED_BY_REGION                      = 'AB', 
 --- mcrc ac.on 
 @DISPOSITION_MCRC_APPROVED                              = 'AW', 
 @DISPOSITION_MCRC_DISAPPROVED                           = 'AX', 
 @DISPOSITION_WITHDRAWN_BY_MCRC                          = 'AY', 
 @DISPOSITION_DISENROLLED_BY_MCRC                        = 'AZ' 
 
CREATE TABLE #CONTRACT  
 (CONTRACT_ID INT, NWA_ID INT, CONTRACT_BEGIN_DATE DATETIME, COMPONENT_CODE VARCHAR(2), NATIONAL_CALL_TO_SERVICE CHAR(1), 
 DATE_MAILED_TO_DISTRICT DATETIME, DISTRICT_ACTION_DATE DATETIME, REGION_ACTION_DATE DATETIME, MCRC_ACTION_DATE DATETIME, 
 BACKGROUND_COMPLETE_DATE DATETIME, CONTRACT_GPA FLOAT, PROJECTED_LAW_GRAD_DATE DATETIME, PROJECTED_GRAD_DATE DATETIME, PROJECTED_COMMISSION_DATE DATETIME, 
 DISCHARGE_CODE VARCHAR(3), DISCHARGE_DATE DATETIME, COMPONENT_DESCRIPTION VARCHAR(50), EMAIL_ADDRESS VARCHAR(50),  
 OCS_ID INT, OCS_CLASS VARCHAR(7), CLASS_NUMBER INT, FISCAL_YEAR INT, PEBD DATETIME, OCS_CLASS_BEGIN_DATE DATETIME, OCS_CLASS_END_DATE DATETIME, 
 SENIOR_OCS_ID INT, SENIOR_CLASS VARCHAR(7), SENIOR_CLASS_NUMBER INT, SENIOR_FISCAL_YEAR INT, SENIOR_OCS_CLASS_BEGIN_DATE DATETIME, SENIOR_OCS_CLASS_END_DATE DATETIME, 
 SMCR_ID INT, SMCR_ACTIVATED CHAR(1), SMCR_ACTIVATED_DATE DATETIME, SMCR_DEACTIVATED_DATE DATETIME, MISSION_MONTH INT, MISSION_YEAR INT, BOARD_STATUS_ID INT, BOARD_ID INT) 
 
 
INSERT INTO #CONTRACT  
 (CONTRACT_ID, NWA_ID, CONTRACT_BEGIN_DATE, COMPONENT_CODE, NATIONAL_CALL_TO_SERVICE, DATE_MAILED_TO_DISTRICT, DISTRICT_ACTION_DATE ,  
 REGION_ACTION_DATE, MCRC_ACTION_DATE, BACKGROUND_COMPLETE_DATE, CONTRACT_GPA,  
 PROJECTED_LAW_GRAD_DATE, PROJECTED_GRAD_DATE, PROJECTED_COMMISSION_DATE,  
 DISCHARGE_CODE, DISCHARGE_DATE, COMPONENT_DESCRIPTION, EMAIL_ADDRESS, MISSION_MONTH, MISSION_YEAR, BOARD_STATUS_ID, BOARD_ID) 
SELECT  
 @ContractID, C.NWA_ID, C.CONTRACT_BEGIN_DATE, N.OFFICER_COMPONENT_CODE, N.NATIONAL_CALL_TO_SERVICE, --- N.OCCR, 
 (SELECT MAX(CS.STATUS_EFFECTIVE_DATE) FROM CANDIDATE_STATUS CS  
  WHERE CS.NWA_ID = C.NWA_ID AND 
  CS.STATUS_TYPE = 'O' AND  
  CS.STATUS_CODE = 'B' AND  
  CS.DISPOSITION_CODE = @DISPOSITION_SUBMITTED_TO_DISTRICT),  
 (SELECT MAX(CS.STATUS_EFFECTIVE_DATE) FROM CANDIDATE_STATUS CS  
  WHERE CS.NWA_ID = C.NWA_ID AND 
  CS.STATUS_TYPE = 'O' AND  
  CS.STATUS_CODE = 'B' AND  
  CS.DISPOSITION_CODE IN (@DISPOSITION_DISTRICT_NON_SELECTED, @DISPOSITION_DISTRICT_SELECTED, @DISPOSITION_PENDING_ADDITIONAL_INFORMATION_DIST, 
     @DISPOSITION_WITHDRAWN_BY_DISTRICT, @DISPOSITION_SUBMITTED_TO_REGION)),  
 (SELECT MAX(CS.STATUS_EFFECTIVE_DATE) FROM CANDIDATE_STATUS CS  
  WHERE CS.NWA_ID = C.NWA_ID AND 
  CS.STATUS_TYPE = 'O' AND  
  CS.STATUS_CODE = 'B' AND  
  CS.DISPOSITION_CODE IN (@DISPOSITION_PENDING_ADDITIONAL_INFORMATION_REGION, @DISPOSITION_REGION_NON_SELECTED, @DISPOSITION_REGION_SELECTED,  
     @DISPOSITION_WITHDRAWN_BY_REGION, @DISPOSITION_DISENROLLED_BY_REGION)),  
 (SELECT MAX(CS.STATUS_EFFECTIVE_DATE) FROM CANDIDATE_STATUS CS  
  WHERE CS.NWA_ID = C.NWA_ID AND 
  CS.STATUS_TYPE = 'O' AND  
  CS.STATUS_CODE = 'B' AND  
  CS.DISPOSITION_CODE IN (@DISPOSITION_MCRC_APPROVED, @DISPOSITION_MCRC_DISAPPROVED, @DISPOSITION_WITHDRAWN_BY_MCRC,  
     @DISPOSITION_DISENROLLED_BY_MCRC)),  
 C.BACKGROUND_COMPLETE_DATE, C.CONTRACT_GPA, C.PROJECTED_LAW_GRAD_DATE,  
 C.PROJECTED_GRAD_DATE, C.PROJECTED_COMMISSION_DATE, C.DISCHARGE_CODE, C.DISCHARGE_DATE,  
 CC.COMPONENT_DESCRIPTION, N.EMAIL_ADDRESS, 
 COALESCE(M.MISSION_MONTH, 0) AS MISSION_MONTH, 
 COALESCE(M.MISSION_YEAR, 0) AS MISSION_YEAR, 
 C.BOARD_STATUS_ID, 
 (SELECT B.BOARD_ID FROM BOARD B, OFFICER_CONTRACT_BOARD OCB, OFFICER_CONTRACT_BOARD_STATUS_HISTORY OCBSH 
  WHERE B.BOARD_ID = OCB.BOARD_ID AND 
  OCB.CONTRACT_BOARD_ID = OCBSH.CONTRACT_BOARD_ID AND 
  OCBSH.OFFICER_CONTRACT_ID = C.CONTRACT_ID AND 
  OCBSH.STATUS_DATE = (SELECT MAX(OCBSH.STATUS_DATE) FROM OFFICER_CONTRACT_BOARD_STATUS_HISTORY OCBSH 
        WHERE OCBSH.BOARD_STATUS_ID = C.BOARD_STATUS_ID AND 
        OCBSH.OFFICER_CONTRACT_ID = C.CONTRACT_ID)) 
FROM  
 OFFICER_CONTRACT C  WITH (NOLOCK) 
 INNER JOIN NWA N ON  
  (C.CONTRACT_ID = @ContractID AND 
  C.NWA_ID = N.NWA_ID) 
 LEFT OUTER JOIN COMPONENT_CODE CC ON N.OFFICER_COMPONENT_CODE = CC.COMPONENT_CODE 
 LEFT OUTER JOIN OCS ON  
  (C.NWA_ID = OCS.NWA_ID AND 
  OCS.OCS_ID = dbo.GetMaxOCSID(OCS.NWA_ID, NULL)) 
 LEFT OUTER JOIN OCS_CLASS CL ON OCS.OCS_CLASS_ID = CL.CLASS_ID 
 LEFT OUTER JOIN NWA_OFFICER_MISSION M ON N.NWA_ID = M.NWA_ID 
 
 
DECLARE @PLCJrFlag char(1) 
DECLARE @PriorServiceHistoryPresent bit 
 
SET @PLCJrFlag = CASE 
   WHEN EXISTS (SELECT 1 FROM #CONTRACT C INNER JOIN OCS O ON  
      (C.NWA_ID = O.NWA_ID AND 
      C.CONTRACT_ID = @ContractID) 
     INNER JOIN OCS_CLASS CL ON  
      (O.OCS_CLASS_ID = CL.CLASS_ID AND 
      CL.TRAINING_TYPE_CODE = 'PLCJR'))  
   THEN 'Y'  
   ELSE 'N' 
   END 
 
--- RETRIEVE THE PRIOR SERVICE HISTORY PRESENT FLAG 
SET @PriorServiceHistoryPresent = CASE  
    WHEN EXISTS (SELECT 1 FROM CANDIDATE_PRIOR_SERVICE PSH WITH (NOLOCK) 
    INNER JOIN NWA N ON PSH.MARINE_CANDIDATE_ID = N.MARINE_CANDIDATE_ID 
       INNER JOIN OFFICER_CONTRACT OC ON N.NWA_ID = OC.NWA_ID       
       WHERE OC.CONTRACT_ID = @ContractID) 
    THEN 1 
    ELSE 0 
    END 
 
--- GET OCS DATA 
UPDATE 
 #CONTRACT 
SET 
 OCS_ID    = O.OCS_ID, 
 OCS_CLASS   = CL.TRAINING_TYPE_CODE,  
 CLASS_NUMBER  = CL.CLASS_NUMBER, 
 --- FISCAL_YEAR  = O.FISCAL_YEAR, 
 FISCAL_YEAR  = CL.FISCAL_YEAR, 
 PEBD   = O.PEBD, 
 OCS_CLASS_BEGIN_DATE  = CL.CLASS_BEGIN_DATE,  
 OCS_CLASS_END_DATE  = CL.CLASS_END_DATE  
FROM 
 #CONTRACT C INNER JOIN OCS O ON  
  (C.NWA_ID = O.NWA_ID AND 
  O.OCS_ID = CASE @PLCJrFlag 
    WHEN 'Y' THEN (SELECT MAX(O1.OCS_ID) FROM OCS O1 INNER JOIN OCS_CLASS CL1 ON 
      (O1.NWA_ID = O.NWA_ID AND  
      O1.OCS_CLASS_ID = CL1.CLASS_ID AND 
      CL1.TRAINING_TYPE_CODE = 'PLCJR')) 
    ELSE dbo.GetMaxOCSID(C.NWA_ID, NULL) 
    END) 
 INNER JOIN OCS_CLASS CL ON O.OCS_CLASS_ID = CL.CLASS_ID 
 
 
 
 
--- IF (SELECT OCS_CLASS FROM #CONTRACT WHERE CONTRACT_ID = @ContractID) = 'PLCJR' 
IF @PLCJrFlag = 'Y' 
BEGIN 
 --- SENIOR OCS DATA  
 UPDATE 
  #CONTRACT 
 SET 
  SENIOR_OCS_ID    = OCS.OCS_ID, 
  SENIOR_CLASS    = CL.TRAINING_TYPE_CODE,  
  SENIOR_CLASS_NUMBER  = CL.CLASS_NUMBER, 
  --- SENIOR_FISCAL_YEAR  = OCS.FISCAL_YEAR, 
  SENIOR_FISCAL_YEAR  = CL.FISCAL_YEAR, 
  SENIOR_OCS_CLASS_BEGIN_DATE  = CL.CLASS_BEGIN_DATE,  
  SENIOR_OCS_CLASS_END_DATE  = CL.CLASS_END_DATE  
 FROM 
  #CONTRACT C INNER JOIN OCS ON  
   (C.NWA_ID = OCS.NWA_ID AND 
   OCS.OCS_ID = (SELECT MAX(O1.OCS_ID) FROM OCS O1 INNER JOIN OCS_CLASS CL1 ON 
     (O1.NWA_ID = OCS.NWA_ID AND  
     O1.OCS_ID > C.OCS_ID AND  
     O1.OCS_CLASS_ID = CL1.CLASS_ID AND 
     CL1.TRAINING_TYPE_CODE = 'PLCSR'))) 
  INNER JOIN OCS_CLASS CL ON OCS.OCS_CLASS_ID = CL.CLASS_ID 
 
END  
 
--- SMCR DATA 
UPDATE 
 #CONTRACT 
SET 
 SMCR_ID   = S.SMCR_ID, 
 SMCR_ACTIVATED   = S.ACTIVATED, 
 SMCR_ACTIVATED_DATE  = S.ACTIVATED_DATE, 
 SMCR_DEACTIVATED_DATE  = S.DEACTIVATED_DATE 
FROM 
 #CONTRACT C INNER JOIN SMCR S ON C.CONTRACT_ID = S.CONTRACT_ID 
 
 
--- RETURN THE DATA 
SELECT  
 CONTRACT_ID, 
 NWA_ID, 
 CONVERT(CHAR(11), CONTRACT_BEGIN_DATE, 106) AS CONTRACT_BEGIN_DATE, 
 COALESCE(COMPONENT_CODE, SPACE(0)) AS COMPONENT_CODE, 
 NATIONAL_CALL_TO_SERVICE AS NATIONAL_CALL_TO_SERVICE, 
 --- OCCR, 
 COALESCE(CONVERT(CHAR(11), DATE_MAILED_TO_DISTRICT, 106), SPACE(0)) AS DATE_MAILED_TO_DISTRICT, 
 COALESCE(CONVERT(CHAR(11), DISTRICT_ACTION_DATE, 106), SPACE(0)) AS DISTRICT_ACTION_DATE, 
 COALESCE(CONVERT(CHAR(11), REGION_ACTION_DATE, 106), SPACE(0)) AS REGION_ACTION_DATE, 
 COALESCE(CONVERT(CHAR(11), MCRC_ACTION_DATE, 106), SPACE(0)) AS MCRC_ACTION_DATE, 
 COALESCE(CONVERT(CHAR(11), BACKGROUND_COMPLETE_DATE, 106), SPACE(0)) AS BACKGROUND_COMPLETE_DATE, 
 COALESCE(CONTRACT_GPA, 0) AS CONTRACT_GPA, 
 COALESCE(CONVERT(CHAR(11), PROJECTED_LAW_GRAD_DATE, 106), SPACE(0)) AS PROJECTED_LAW_GRAD_DATE, 
 COALESCE(CONVERT(CHAR(11), PROJECTED_GRAD_DATE, 106), SPACE(0)) AS PROJECTED_GRAD_DATE, 
 COALESCE(CONVERT(CHAR(11), PROJECTED_COMMISSION_DATE, 106), SPACE(0)) AS PROJECTED_COMMISSION_DATE, 
 COALESCE(DISCHARGE_CODE, SPACE(0)) AS DISCHARGE_CODE, 
 COALESCE(CONVERT(CHAR(11), DISCHARGE_DATE, 106), SPACE(0)) AS DISCHARGE_DATE, 
 COALESCE(COMPONENT_DESCRIPTION, SPACE(0)) AS COMPONENT_DESCRIPTION, 
 COALESCE(EMAIL_ADDRESS, SPACE(0)) AS EMAIL_ADDRESS, 
 COALESCE(OCS_ID, 0) AS OCS_ID, 
 COALESCE(OCS_CLASS, SPACE(0)) AS OCS_CLASS, 
 COALESCE(CLASS_NUMBER, 0) AS CLASS_NUMBER, 
 COALESCE(FISCAL_YEAR, 0) AS FISCAL_YEAR, 
 COALESCE(CONVERT(CHAR(11), PEBD, 106), SPACE(0)) AS PEBD, 
 COALESCE(CONVERT(CHAR(11), OCS_CLASS_BEGIN_DATE, 106), SPACE(0)) AS OCS_CLASS_BEGIN_DATE, 
 COALESCE(CONVERT(CHAR(11), OCS_CLASS_END_DATE, 106), SPACE(0)) AS OCS_CLASS_END_DATE, 
 COALESCE(SENIOR_OCS_ID, 0) AS SENIOR_OCS_ID, 
 COALESCE(SENIOR_CLASS, SPACE(0)) AS SENIOR_CLASS,  
 COALESCE(SENIOR_CLASS_NUMBER, SPACE(0)) AS SENIOR_CLASS_NUMBER, 
 COALESCE(SENIOR_FISCAL_YEAR, 0) AS SENIOR_FISCAL_YEAR, 
 COALESCE(CONVERT(CHAR(11), SENIOR_OCS_CLASS_BEGIN_DATE, 106), SPACE(0)) AS SENIOR_OCS_CLASS_BEGIN_DATE, 
 
 COALESCE(CONVERT(CHAR(11), SENIOR_OCS_CLASS_END_DATE, 106), SPACE(0)) AS SENIOR_OCS_CLASS_END_DATE, 
 COALESCE(SMCR_ID, 0) AS SMCR_ID, 
 COALESCE(SMCR_ACTIVATED, SPACE(0)) AS SMCR_ACTIVATED, 
 COALESCE(CONVERT(VARCHAR(11), SMCR_ACTIVATED_DATE, 106), SPACE(0)) AS SMCR_ACTIVATED_DATE, 
 COALESCE(CONVERT(VARCHAR(11), SMCR_DEACTIVATED_DATE, 106), SPACE(0)) AS SMCR_DEACTIVATED_DATE, 
 COALESCE(MISSION_MONTH, 0) AS MISSION_MONTH, 
 COALESCE(MISSION_YEAR, 0) AS MISSION_YEAR, 
 @PriorServiceHistoryPresent AS PRIOR_SERVICE_HISTORY_PRESENT_BIT, 
 BOARD_STATUS_ID, 
 COALESCE(BOARD_ID, 0) AS BOARD_ID 
FROM  
 #CONTRACT 
 
 
--- CLEAN UP 
DROP TABLE #CONTRACT  
SET NOCOUNT OFF]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>