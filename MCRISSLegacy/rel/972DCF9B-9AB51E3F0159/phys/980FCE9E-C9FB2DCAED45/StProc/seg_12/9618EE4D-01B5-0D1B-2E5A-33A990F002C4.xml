<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[InsertUpdateReferral]" directorySegmentName="seg_12" id="9618EE4D-01B5-0D1B-2E5A-33A990F002C4">
<sourceDDLFile>Appian.sql</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:57:49 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[( 
 @ContractID int, 
 @SSN varchar(9), 
 @SourceCode varchar(10), 
 @ReserveRUC varchar(5), 
 @RsID int,  
 @LastEditBy varchar(50)  
) 
AS 
 
DECLARE @PersonID  int 
DECLARE @DEPContractID  int 
DECLARE @ReferralType  varchar(10) 
 
---GET THE REFERRAL'S PERSON_ID 
SELECT @PersonID = PERSON_ID FROM PERSON WHERE SOCIAL_SECURITY_NUMBER = @SSN 
 
 
--- WHEN THE SOURCE CODE = 'DEP' OR 'CDR' SET THE REFERRAL TYPE = SOURCE CODE SINCE WE'VE ALREADY  
--- VALIDATED THE REFERRAL SSN.  FOR ALL OTHER VALUES IF THE REFERRAL SSN IS IN THE MARINE TABLE,  
--- REFERRAL TYPE = 'CDR' IF NOT, REFERRAL TYPE = 'DEP' 
SET @ReferralType = CASE  
   WHEN @SourceCode IN ('DEP', 'CDR') THEN @SourceCode 
   ELSE 
    CASE  
     WHEN EXISTS (SELECT 1 FROM MARINE WHERE MARINE_ID = @PersonID) THEN 'CDR' 
     ELSE 'DEP' 
    END 
   END 
     
--- GET THE DEP CONTRACT ID FOR DEP REFERRALS 
IF @ReferralType = 'DEP' 
BEGIN 
 --- DEP - SELECT MAX(CONTRACT_ID) TO MAKE SURE WE GET THE RIGHT DEP_CONTRACT_ID PER SCR 1331 
 SELECT  
  @DEPContractID = MAX(C.CONTRACT_ID)  
 FROM  
  CONTRACT C INNER JOIN NWA N ON C.NWA_ID = N.NWA_ID 
 WHERE   
  N.MARINE_CANDIDATE_ID = @PersonID 
END 
 
 
IF EXISTS (SELECT 1 FROM REFERRAL WHERE CONTRACT_ID = @ContractID) 
BEGIN 
 --- IF A REFERRAL EXISTS FOR THIS CONTRACT UPDATE IT 
 UPDATE REFERRAL 
 SET  
  REFERRAL_TYPE = @ReferralType, 
  --- FOR CDR REFERRALS SET MARINE_ID TO THE REFERALS MARINE ID, FOR DEP REFERRALS SET MARINE_ID = NULL 
  MARINE_ID = CASE @ReferralType WHEN 'CDR' THEN @PersonID ELSE NULL END, 
  --- FOR DEP REFERRALS SET DEP_CONTRACT_ID TO THE REFERALS CONTRACT ID, FOR CDR REFERRALS SET DEP_CONTRACT_ID = NULL 
  DEP_CONTRACT_ID = CASE @ReferralType WHEN 'DEP' THEN @DEPContractID ELSE NULL END, 
  USER_LOGIN = @LastEditBy, 
  UPDATE_DATE = GETDATE() 
 WHERE  
  CONTRACT_ID = @ContractID 
 
END  
ELSE 
BEGIN 
 If @ReferralType = 'CDR' 
 BEGIN 
  IF NOT EXISTS(SELECT DEP_CONTRACT_ID FROM REFERRAL WHERE REFERRAL.MARINE_ID = @PersonID AND CONTRACT_ID IN 
         (SELECT CONTRACT_ID  
          FROM CONTRACT C  
          INNER JOIN NWA N ON C.NWA_ID = N.NWA_ID WHERE MARINE_CANDIDATE_ID IN  
           (SELECT N.MARINE_CANDIDATE_ID  
            FROM CONTRACT C  
            INNER JOIN NWA N ON N.NWA_ID = C.NWA_ID 
            WHERE C.CONTRACT_ID = @CONTRACTID))) 
  BEGIN 
   INSERT INTO REFERRAL  
   (REFERRAL_TYPE, CONTRACT_ID, MARINE_ID, DEP_CONTRACT_ID, USER_LOGIN, UPDATE_DATE)  
   VALUES  
   (@ReferralType, @ContractID, @PersonID, NULL, @LastEditBy, GETDATE()) 
  END 
 END 
 ELSE 
 BEGIN 
  IF NOT EXISTS(SELECT DEP_CONTRACT_ID FROM REFERRAL WHERE REFERRAL.DEP_CONTRACT_ID = @DEPContractID AND CONTRACT_ID IN 
        (SELECT CONTRACT_ID FROM CONTRACT C INNER JOIN NWA N  
        ON C.NWA_ID = N.NWA_ID WHERE MARINE_CANDIDATE_ID  
        IN (SELECT N.MARINE_CANDIDATE_ID FROM CONTRACT C  
        INNER JOIN NWA N ON N.NWA_ID = C.NWA_ID 
        WHERE C.CONTRACT_ID = @CONTRACTID))) 
  BEGIN 
   INSERT INTO REFERRAL  
   (REFERRAL_TYPE, CONTRACT_ID, MARINE_ID, DEP_CONTRACT_ID, USER_LOGIN, UPDATE_DATE)  
   VALUES  
   (@ReferralType, @ContractID, NULL,  @DEPContractID, @LastEditBy, GETDATE()) 
  END 
 END 
END  
 
DECLARE @ReferralID int 
SET @ReferralID = (SELECT REFERRAL_ID FROM REFERRAL WHERE CONTRACT_ID = @ContractID) 
 
 
IF (@ReserveRUC is not null AND @ReserveRUC != '') 
BEGIN 
 IF EXISTS (SELECT 1 FROM RESERVE_REFERRAL WHERE REFERRAL_ID = @ReferralID) 
 BEGIN 
  UPDATE [MCRISS].[dbo].[RESERVE_REFERRAL] SET 
   [MARINE_ID] = @PersonID 
   ,[REFERRAL_RUC] = @ReserveRUC 
   ,[REFERRAL_RS] = @RsID 
   ,[USER_LOGIN] = @LastEditBy 
   ,[UPDATE_DATE] = GetDate() 
  WHERE REFERRAL_ID = @ReferralID 
 END 
 ELSE 
 BEGIN 
  INSERT INTO [MCRISS].[dbo].[RESERVE_REFERRAL] 
   ([REFERRAL_ID],[MARINE_ID],[REFERRAL_RUC],[REFERRAL_RS],[USER_LOGIN],[UPDATE_DATE],[ROWGUID]) 
  VALUES 
   (@ReferralID, @PersonID, @ReserveRUC, @RsID, @LastEditBy, GetDate(), NewID()) 
 END 
END]]></body>
<schema>E9C4E37D-78A2-31F9-D580-7C2848ACFCB7</schema>
<database>EA42DEDC-DFC5-B775-3079-AD0E133F5E1D</database>
</StoredProcedureSqlServerv2k5>