<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[SSRS_MISSIONACHIEVED]" directorySegmentName="seg_12" id="AE47E925-6618-93BB-278C-592F5B0200C7">
<sourceDDLFile>create ODSE script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 23:42:37 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[(@YEAR INT 
 ,@MONTH INT) 
 
AS 
 
CREATE TABLE #MISSION 
 (CATEGORY VARCHAR(30) 
 ,FYTD_MISSION INT 
 ,FYTD_ACHIEVED INT 
 ,FY_MISSION INT) 
 
 
DECLARE @FYWRAP INT 
DECLARE @FY INT 
 
 
 
IF @MONTH < 10 
BEGIN 
 SET @FYWRAP = 1 
 SET @FY = @YEAR 
END 
ELSE  
BEGIN 
 SET @FY = @YEAR + 1 
END 
 
INSERT INTO #MISSION 
SELECT  
 APT.DESCRIPTION + ' ' + 
 CASE PAYGRADETYPE 
  WHEN 1 THEN 'Enlisted' 
  WHEN 2 THEN 'O.cer' 
  ELSE 'Enlisted' 
 END AS PAYGRADE 
 ,SUM(MISSION) 
 ,0 
 ,0 
FROM  
 MISSIONDATA MD 
 INNER JOIN APPLICANTPACKAGETYPE APT ON MD.APPLICANTPACKAGETYPEID = APT.APPLICANTPACKAGETYPEID 
WHERE  
 MD.ORGUNITID = 1 
  
 AND ( 
   (MONTH <= @MONTH AND CALENDARYEAR = @YEAR) 
  OR 
   (@FYWRAP = 1 AND MONTH >= 10 AND CALENDARYEAR = @YEAR - 1) 
  ) 
   
 AND (ISOPEN = 0 OR ISOPEN IS NULL) 
GROUP BY 
 APT.DESCRIPTION + ' ' + 
 CASE PAYGRADETYPE 
  WHEN 1 THEN 'Enlisted' 
  WHEN 2 THEN 'O.cer' 
  ELSE 'Enlisted' 
 END 
 
UPDATE M 
 SET FYTD_ACHIEVED = T.ACHIEVED 
FROM 
 ( SELECT  
   APT.DESCRIPTION + ' ' + 
   CASE Q.PAYGRADETYPE 
    WHEN 'E' THEN 'Enlisted' 
    WHEN 'O' THEN 'O.cer' 
    ELSE 'Enlisted' 
   END AS PAYGRADE 
   ,COUNT(*) AS ACHIEVED 
  FROM APPLICANTPACKAGE AP 
   INNER JOIN APPLICANTPACKAGETYPE APT ON AP.APPLICANTPACKAGETYPEID = APT.APPLICANTPACKAGETYPEID 
   INNER JOIN QSN Q ON AP.QSNID = Q.QSNID 
   INNER JOIN LEADSTATUSDISPOSITION LSD ON AP.LEADID = LSD.LEADID 
  WHERE Q.FISCALYEAR = @FY 
   AND (LSD.STATUSDISPOSITIONID IN (28,29)) 
  GROUP BY 
   APT.DESCRIPTION + ' ' + 
   CASE Q.PAYGRADETYPE 
    WHEN 'E' THEN 'Enlisted' 
    WHEN 'O' THEN 'O.cer' 
    ELSE 'Enlisted' 
   END) T 
 INNER JOIN #MISSION M ON M.CATEGORY = T.PAYGRADE 
 
UPDATE M 
SET FY_MISSION = T.MISSION 
FROM 
 (SELECT  
  APT.DESCRIPTION + ' ' + 
  CASE PAYGRADETYPE 
   WHEN 1 THEN 'Enlisted' 
   WHEN 2 THEN 'O.cer' 
   ELSE 'Enlisted' 
  END AS PAYGRADE 
  ,SUM(MISSION) AS MISSION 
 FROM  
  MISSIONDATA MD 
  INNER JOIN APPLICANTPACKAGETYPE APT ON MD.APPLICANTPACKAGETYPEID = APT.APPLICANTPACKAGETYPEID 
 WHERE  
  MD.ORGUNITID = 1 
   
  AND ( 
    (MONTH <= 9 AND CALENDARYEAR = @FY) 
   OR 
    (MONTH >= 10 AND CALENDARYEAR = @FY - 1) 
   ) 
    
  AND (ISOPEN = 0 OR ISOPEN IS NULL) 
 GROUP BY 
  APT.DESCRIPTION + ' ' + 
  CASE PAYGRADETYPE 
   WHEN 1 THEN 'Enlisted' 
   WHEN 2 THEN 'O.cer' 
   ELSE 'Enlisted' 
  END) T 
 INNER JOIN #MISSION M ON M.CATEGORY = T.PAYGRADE 
 
 
 
SELECT * FROM #MISSION 
order by 1 desc 
 
 
DROP TABLE #MISSION]]></body>
<schema>CEC76C37-9D45-8E15-510C-CBE87FFE10F5</schema>
<database>0070DB58-AADF-159B-2831-3CD8EEAC6A57</database>
</StoredProcedureSqlServerv2k5>