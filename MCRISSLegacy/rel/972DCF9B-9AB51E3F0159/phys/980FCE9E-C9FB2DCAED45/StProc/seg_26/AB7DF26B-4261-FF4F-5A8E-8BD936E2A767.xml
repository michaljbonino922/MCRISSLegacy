<?xml version = '1.0' encoding = 'UTF-8'?>
<StoredProcedureSqlServerv2k5 class="oracle.dbtools.crest.model.design.storage.sqlserver.v2k5.StoredProcedureSqlServerv2k5" name="[UpdateEnlistedReferral]" directorySegmentName="seg_26" id="AB7DF26B-4261-FF4F-5A8E-8BD936E2A767">
<sourceDDLFile>create MCRISS script - MCRISS OTA.txt</sourceDDLFile>
<createdBy>MichalBonino</createdBy>
<createdTime>2024-04-29 19:28:43 UTC</createdTime>
<ownerDesignName>MCRISSLegacy</ownerDesignName>
<body><![CDATA[@ContractID  int = 0, 
 @SSN   varchar(9), 
 @SourceCode  varchar(10),  
 @UserLogin  varchar(15)  
AS 
 
DECLARE @PersonID  int 
DECLARE @DEPContractID  int 
DECLARE @ReferralType  varchar(10) 
 
---GET THE REFERRAL'S PERSON_ID 
SELECT @PersonID = PERSON_ID FROM [dbo].[PERSON] WHERE SOCIAL_SECURITY_NUMBER = @SSN 
 
 
--- WHEN THE SOURCE CODE = 'DEP' OR 'CDR' SET THE REFERRAL TYPE = SOURCE CODE SINCE WE'VE ALREADY  
--- VALIDATED THE REFERRAL SSN.  FOR ALL OTHER VALUES IF THE REFERRAL SSN IS IN THE MARINE TABLE,  
--- REFERRAL TYPE = 'CDR' IF NOT, REFERRAL TYPE = 'DEP' 
SET @ReferralType = CASE  
   WHEN @SourceCode IN ('DEP', 'CDR') THEN @SourceCode 
   ELSE 
    CASE  
     WHEN EXISTS (SELECT 1 FROM [dbo].[MARINE] WHERE MARINE_ID = @PersonID) THEN 'CDR' 
     ELSE 'DEP' 
    END 
   END 
     
--- GET THE DEP CONTRACT ID FOR DEP REFERRALS 
IF @ReferralType = 'DEP' 
BEGIN 
 --- DEP - SELECT MAX(CONTRACT_ID) TO MAKE SURE WE GET THE RIGHT DEP_CONTRACT_ID PER SCR 1331 
 SELECT  
  @DEPContractID = MAX(C.CONTRACT_ID)  
 FROM  
  [dbo].[CONTRACT] C INNER JOIN [dbo].[NWA] N ON C.NWA_ID = N.NWA_ID 
 WHERE   
  N.MARINE_CANDIDATE_ID = @PersonID 
END 
 
 
IF EXISTS (SELECT 1 FROM [dbo].[REFERRAL] WHERE CONTRACT_ID = @ContractID) 
BEGIN 
 --- IF A REFERRAL EXISTS FOR THIS CONTRACT UPDATE IT 
 UPDATE  
  [dbo].[REFERRAL] 
 SET  
  REFERRAL_TYPE = @ReferralType, 
  --- FOR CDR REFERRALS SET MARINE_ID TO THE REFERALS MARINE ID, FOR DEP REFERRALS SET MARINE_ID = NULL 
  MARINE_ID = CASE @ReferralType WHEN 'CDR' THEN @PersonID ELSE NULL END, 
  --- FOR DEP REFERRALS SET DEP_CONTRACT_ID TO THE REFERALS CONTRACT ID, FOR CDR REFERRALS SET DEP_CONTRACT_ID = NULL 
  DEP_CONTRACT_ID = CASE @ReferralType WHEN 'DEP' THEN @DEPContractID ELSE NULL END, 
  USER_LOGIN = @UserLogin, 
  UPDATE_DATE = GETDATE() 
 WHERE  
  CONTRACT_ID = @ContractID 
 
END  
ELSE 
BEGIN 
 If @ReferralType = 'CDR' 
 BEGIN 
  IF NOT EXISTS(SELECT DEP_CONTRACT_ID FROM [dbo].[REFERRAL] WHERE  
  CONTRACT_ID IN 
   (SELECT CONTRACT_ID FROM [dbo].[CONTRACT] C INNER JOIN [dbo].[NWA] N  
   ON C.NWA_ID = N.NWA_ID WHERE MARINE_CANDIDATE_ID  
   IN (SELECT N.MARINE_CANDIDATE_ID FROM [dbo].[CONTRACT] C  
   INNER JOIN [dbo].[NWA] N ON N.NWA_ID = C.NWA_ID 
   WHERE C.CONTRACT_ID = @CONTRACTID)) 
  AND REFERRAL.MARINE_ID = @PersonID) 
  BEGIN 
   INSERT INTO [dbo].[REFERRAL] (REFERRAL_TYPE,  
   CONTRACT_ID, MARINE_ID, DEP_CONTRACT_ID,  
   USER_LOGIN, UPDATE_DATE) VALUES  
   (@ReferralType, @ContractID, @PersonID,  
   NULL, @UserLogin, GETDATE()) 
  END 
 END 
 ELSE 
 BEGIN 
  IF NOT EXISTS(SELECT DEP_CONTRACT_ID FROM REFERRAL WHERE  
  CONTRACT_ID IN 
   (SELECT CONTRACT_ID FROM [dbo].[CONTRACT] C INNER JOIN [dbo].[NWA] N  
   ON C.NWA_ID = N.NWA_ID WHERE MARINE_CANDIDATE_ID  
   IN (SELECT N.MARINE_CANDIDATE_ID FROM [dbo].[CONTRACT] C  
   INNER JOIN [dbo].[NWA] N ON N.NWA_ID = C.NWA_ID 
   WHERE C.CONTRACT_ID = @CONTRACTID)) 
  AND REFERRAL.DEP_CONTRACT_ID = @DEPContractID) 
  BEGIN 
   INSERT INTO [dbo].[REFERRAL] (REFERRAL_TYPE,  
   CONTRACT_ID, MARINE_ID, DEP_CONTRACT_ID,  
   USER_LOGIN, UPDATE_DATE) VALUES  
   (@ReferralType, @ContractID, NULL,  
   @DEPContractID, @UserLogin, GETDATE()) 
  END 
 END 
END]]></body>
<schema>72379847-5555-B149-4E45-17F849103A51</schema>
<database>B007042D-D2E3-F83F-481F-CEB23B21CB30</database>
</StoredProcedureSqlServerv2k5>